"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = createMultiBufferingPlayer;
// Currently, Web Chat uses a triple-buffer approach.
var NUM_BUFFER = 3;

function zeroBuffer(buffer) {
  var channels = buffer.numberOfChannels;

  for (var channel = 0; channel < channels; channel++) {
    var audioData = buffer.getChannelData(channel);
    [].fill.call(audioData, 0);
  }
}

function copyBuffer(buffer, multiChannelArray) {
  var channels = buffer.numberOfChannels;

  for (var channel = 0; channel < channels; channel++) {
    var float32Array = multiChannelArray[+channel]; // Note that Safari does not support AudioBuffer.copyToChannel yet.

    if (buffer.copyToChannel) {
      buffer.copyToChannel(float32Array, channel);
    } else {
      var float32ArrayLength = float32Array.length;
      var perChannelBuffer = buffer.getChannelData(channel);

      for (var offset = 0; offset < float32ArrayLength; offset++) {
        perChannelBuffer[+offset] = float32Array[+offset];
      }
    }
  }
} // This is a multi-buffering player. Users can keep pushing buffer to Web Chat.
// The buffer, realized as BufferSource, is queued to AudioContext.
// Data will be queued as quickly and frequently as possible.
// Web Chat does not support progressive buffering (pushing a partial buffer) and there are currently no plans to implement.


function createMultiBufferingPlayer(audioContext, _ref, numSamplePerBuffer) {
  var channels = _ref.channels,
      samplesPerSec = _ref.samplesPerSec;
  var freeBuffers = new Array(NUM_BUFFER).fill().map(function () {
    return audioContext.createBuffer(channels, numSamplePerBuffer, samplesPerSec);
  });
  var queuedBufferSources = [];
  var nextSchedule;
  var queue = [];

  var playNext = function playNext() {
    if (typeof nextSchedule !== 'number') {
      nextSchedule = audioContext.currentTime;
    }

    var bufferSource = audioContext.createBufferSource();
    var multiChannelArray = queue.shift();

    if (typeof multiChannelArray === 'function') {
      // If the queued item is a function, it is because the user called "flush".
      // The "flush" function will callback when all queued buffers before the "flush" call have played.
      multiChannelArray();
    } else if (multiChannelArray) {
      var nextBuffer = freeBuffers.shift(); // If all buffers are currently occupied, prepend the data back to the queue.
      // When one of the buffers finish, it will call playNext() again to pick up items from the queue.

      if (!nextBuffer) {
        queue.unshift(multiChannelArray);
        return;
      }

      zeroBuffer(nextBuffer);
      copyBuffer(nextBuffer, multiChannelArray);
      bufferSource.buffer = nextBuffer;
      bufferSource.connect(audioContext.destination);
      bufferSource.start(nextSchedule); // All BufferSource data that is currently queued will be stored at the AudioContext, via bufferSource.start().
      // This is for cancelAll() to effectively cancel all BufferSource queued at the AudioContext.

      queuedBufferSources.push(bufferSource);
      nextSchedule += nextBuffer.duration;
      bufferSource.addEventListener('ended', function () {
        queuedBufferSources = queuedBufferSources.filter(function (target) {
          return target !== bufferSource;
        }); // Declare the buffer is free to pick up on the next iteration.

        freeBuffers.push(nextBuffer);
        playNext();
      });
    }
  };

  return {
    cancelAll: function cancelAll() {
      queue.splice(0); // Although all buffers are cleared, there are still some BufferSources queued at the AudioContext that need to be stopped.

      queuedBufferSources.forEach(function (bufferSource) {
        return bufferSource.stop();
      });
    },
    flush: function flush() {
      return new Promise(function (resolve) {
        return queue.push(resolve);
      });
    },
    push: function push(multiChannelArray) {
      if (!multiChannelArray) {
        throw new Error('multiChannelArray must not be falsy.');
      }

      queue.push(multiChannelArray);
      playNext();
    }
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jcmVhdGVNdWx0aUJ1ZmZlcmluZ1BsYXllci5qcyJdLCJuYW1lcyI6WyJOVU1fQlVGRkVSIiwiemVyb0J1ZmZlciIsImJ1ZmZlciIsImNoYW5uZWxzIiwibnVtYmVyT2ZDaGFubmVscyIsImNoYW5uZWwiLCJhdWRpb0RhdGEiLCJnZXRDaGFubmVsRGF0YSIsImZpbGwiLCJjYWxsIiwiY29weUJ1ZmZlciIsIm11bHRpQ2hhbm5lbEFycmF5IiwiZmxvYXQzMkFycmF5IiwiY29weVRvQ2hhbm5lbCIsImZsb2F0MzJBcnJheUxlbmd0aCIsImxlbmd0aCIsInBlckNoYW5uZWxCdWZmZXIiLCJvZmZzZXQiLCJjcmVhdGVNdWx0aUJ1ZmZlcmluZ1BsYXllciIsImF1ZGlvQ29udGV4dCIsIm51bVNhbXBsZVBlckJ1ZmZlciIsInNhbXBsZXNQZXJTZWMiLCJmcmVlQnVmZmVycyIsIkFycmF5IiwibWFwIiwiY3JlYXRlQnVmZmVyIiwicXVldWVkQnVmZmVyU291cmNlcyIsIm5leHRTY2hlZHVsZSIsInF1ZXVlIiwicGxheU5leHQiLCJjdXJyZW50VGltZSIsImJ1ZmZlclNvdXJjZSIsImNyZWF0ZUJ1ZmZlclNvdXJjZSIsInNoaWZ0IiwibmV4dEJ1ZmZlciIsInVuc2hpZnQiLCJjb25uZWN0IiwiZGVzdGluYXRpb24iLCJzdGFydCIsInB1c2giLCJkdXJhdGlvbiIsImFkZEV2ZW50TGlzdGVuZXIiLCJmaWx0ZXIiLCJ0YXJnZXQiLCJjYW5jZWxBbGwiLCJzcGxpY2UiLCJmb3JFYWNoIiwic3RvcCIsImZsdXNoIiwiUHJvbWlzZSIsInJlc29sdmUiLCJFcnJvciJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUE7QUFDQSxJQUFNQSxVQUFVLEdBQUcsQ0FBbkI7O0FBRUEsU0FBU0MsVUFBVCxDQUFvQkMsTUFBcEIsRUFBNEI7QUFDMUIsTUFBTUMsUUFBUSxHQUFHRCxNQUFNLENBQUNFLGdCQUF4Qjs7QUFFQSxPQUFLLElBQUlDLE9BQU8sR0FBRyxDQUFuQixFQUFz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QSxRQUFRO0FBQ1Q7QUFoQkksR0FBUDtBQWtCRCIsInNvdXJjZVJvb3QiOiJkaXJlY3RsaW5lc3BlZWNoOi8vLyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEN1cnJlbnRseSwgV2ViIENoYXQgdXNlcyBhIHRyaXBsZS1idWZmZXIgYXBwcm9hY2guXG5jb25zdCBOVU1fQlVGRkVSID0gMztcblxuZnVuY3Rpb24gemVyb0J1ZmZlcihidWZmZXIpIHtcbiAgY29uc3QgY2hhbm5lbHMgPSBidWZmZXIubnVtYmVyT2ZDaGFubmVscztcblxuICBmb3IgKGxldCBjaGFubmVsID0gMDsgY2hhbm5lbCA8IGNoYW5uZWxzOyBjaGFubmVsKyspIHtcbiAgICBjb25zdCBhdWRpb0RhdGEgPSBidWZmZXIuZ2V0Q2hhbm5lbERhdGEoY2hhbm5lbCk7XG5cbiAgICBbXS5maWxsLmNhbGwoYXVkaW9EYXRhLCAwKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBjb3B5QnVmZmVyKGJ1ZmZlciwgbXVsdGlDaGFubmVsQXJyYXkpIHtcbiAgY29uc3QgY2hhbm5lbHMgPSBidWZmZXIubnVtYmVyT2ZDaGFubmVscztcblxuICBmb3IgKGxldCBjaGFubmVsID0gMDsgY2hhbm5lbCA8IGNoYW5uZWxzOyBjaGFubmVsKyspIHtcbiAgICBjb25zdCBmbG9hdDMyQXJyYXkgPSBtdWx0aUNoYW5uZWxBcnJheVsrY2hhbm5lbF07XG5cbiAgICAvLyBOb3RlIHRoYXQgU2FmYXJpIGRvZXMgbm90IHN1cHBvcnQgQXVkaW9CdWZmZXIuY29weVRvQ2hhbm5lbCB5ZXQuXG4gICAgaWYgKGJ1ZmZlci5jb3B5VG9DaGFubmVsKSB7XG4gICAgICBidWZmZXIuY29weVRvQ2hhbm5lbChmbG9hdDMyQXJyYXksIGNoYW5uZWwpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCB7IGxlbmd0aDogZmxvYXQzMkFycmF5TGVuZ3RoIH0gPSBmbG9hdDMyQXJyYXk7XG4gICAgICBjb25zdCBwZXJDaGFubmVsQnVmZmVyID0gYnVmZmVyLmdldENoYW5uZWxEYXRhKGNoYW5uZWwpO1xuXG4gICAgICBmb3IgKGxldCBvZmZzZXQgPSAwOyBvZmZzZXQgPCBmbG9hdDMyQXJyYXlMZW5ndGg7IG9mZnNldCsrKSB7XG4gICAgICAgIHBlckNoYW5uZWxCdWZmZXJbK29mZnNldF0gPSBmbG9hdDMyQXJyYXlbK29mZnNldF07XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbi8vIFRoaXMgaXMgYSBtdWx0aS1idWZmZXJpbmcgcGxheWVyLiBVc2VycyBjYW4ga2VlcCBwdXNoaW5nIGJ1ZmZlciB0byBXZWIgQ2hhdC5cbi8vIFRoZSBidWZmZXIsIHJlYWxpemVkIGFzIEJ1ZmZlclNvdXJjZSwgaXMgcXVldWVkIHRvIEF1ZGlvQ29udGV4dC5cbi8vIERhdGEgd2lsbCBiZSBxdWV1ZWQgYXMgcXVpY2tseSBhbmQgZnJlcXVlbnRseSBhcyBwb3NzaWJsZS5cbi8vIFdlYiBDaGF0IGRvZXMgbm90IHN1cHBvcnQgcHJvZ3Jlc3NpdmUgYnVmZmVyaW5nIChwdXNoaW5nIGEgcGFydGlhbCBidWZmZXIpIGFuZCB0aGVyZSBhcmUgY3VycmVudGx5IG5vIHBsYW5zIHRvIGltcGxlbWVudC5cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gY3JlYXRlTXVsdGlCdWZmZXJpbmdQbGF5ZXIoYXVkaW9Db250ZXh0LCB7IGNoYW5uZWxzLCBzYW1wbGVzUGVyU2VjIH0sIG51bVNhbXBsZVBlckJ1ZmZlcikge1xuICBjb25zdCBmcmVlQnVmZmVycyA9IG5ldyBBcnJheShOVU1fQlVGRkVSKVxuICAgIC5maWxsKClcbiAgICAubWFwKCgpID0+IGF1ZGlvQ29udGV4dC5jcmVhdGVCdWZmZXIoY2hhbm5lbHMsIG51bVNhbXBsZVBlckJ1ZmZlciwgc2FtcGxlc1BlclNlYykpO1xuICBsZXQgcXVldWVkQnVmZmVyU291cmNlcyA9IFtdO1xuICBsZXQgbmV4dFNjaGVkdWxlO1xuXG4gIGNvbnN0IHF1ZXVlID0gW107XG5cbiAgY29uc3QgcGxheU5leHQgPSAoKSA9PiB7XG4gICAgaWYgKHR5cGVvZiBuZXh0U2NoZWR1bGUgIT09ICdudW1iZXInKSB7XG4gICAgICBuZXh0U2NoZWR1bGUgPSBhdWRpb0NvbnRleHQuY3VycmVudFRpbWU7XG4gICAgfVxuXG4gICAgY29uc3QgYnVmZmVyU291cmNlID0gYXVkaW9Db250ZXh0LmNyZWF0ZUJ1ZmZlclNvdXJjZSgpO1xuICAgIGNvbnN0IG11bHRpQ2hhbm5lbEFycmF5ID0gcXVldWUuc2hpZnQoKTtcblxuICAgIGlmICh0eXBlb2YgbXVsdGlDaGFubmVsQXJyYXkgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIC8vIElmIHRoZSBxdWV1ZWQgaXRlbSBpcyBhIGZ1bmN0aW9uLCBpdCBpcyBiZWNhdXNlIHRoZSB1c2VyIGNhbGxlZCBcImZsdXNoXCIuXG4gICAgICAvLyBUaGUgXCJmbHVzaFwiIGZ1bmN0aW9uIHdpbGwgY2FsbGJhY2sgd2hlbiBhbGwgcXVldWVkIGJ1ZmZlcnMgYmVmb3JlIHRoZSBcImZsdXNoXCIgY2FsbCBoYXZlIHBsYXllZC5cbiAgICAgIG11bHRpQ2hhbm5lbEFycmF5KCk7XG4gICAgfSBlbHNlIGlmIChtdWx0aUNoYW5uZWxBcnJheSkge1xuICAgICAgY29uc3QgbmV4dEJ1ZmZlciA9IGZyZWVCdWZmZXJzLnNoaWZ0KCk7XG5cbiAgICAgIC8vIElmIGFsbCBidWZmZXJzIGFyZSBjdXJyZW50bHkgb2NjdXBpZWQsIHByZXBlbmQgdGhlIGRhdGEgYmFjayB0byB0aGUgcXVldWUuXG4gICAgICAvLyBXaGVuIG9uZSBvZiB0aGUgYnVmZmVycyBmaW5pc2gsIGl0IHdpbGwgY2FsbCBwbGF5TmV4dCgpIGFnYWluIHRvIHBpY2sgdXAgaXRlbXMgZnJvbSB0aGUgcXVldWUuXG4gICAgICBpZiAoIW5leHRCdWZmZXIpIHtcbiAgICAgICAgcXVldWUudW5zaGlmdChtdWx0aUNoYW5uZWxBcnJheSk7XG5cbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICB6ZXJvQnVmZmVyKG5leHRCdWZmZXIpO1xuICAgICAgY29weUJ1ZmZlcihuZXh0QnVmZmVyLCBtdWx0aUNoYW5uZWxBcnJheSk7XG5cbiAgICAgIGJ1ZmZlclNvdXJjZS5idWZmZXIgPSBuZXh0QnVmZmVyO1xuICAgICAgYnVmZmVyU291cmNlLmNvbm5lY3QoYXVkaW9Db250ZXh0LmRlc3RpbmF0aW9uKTtcbiAgICAgIGJ1ZmZlclNvdXJjZS5zdGFydChuZXh0U2NoZWR1bGUpO1xuXG4gICAgICAvLyBBbGwgQnVmZmVyU291cmNlIGRhdGEgdGhhdCBpcyBjdXJyZW50bHkgcXVldWVkIHdpbGwgYmUgc3RvcmVkIGF0IHRoZSBBdWRpb0NvbnRleHQsIHZpYSBidWZmZXJTb3VyY2Uuc3RhcnQoKS5cbiAgICAgIC8vIFRoaXMgaXMgZm9yIGNhbmNlbEFsbCgpIHRvIGVmZmVjdGl2ZWx5IGNhbmNlbCBhbGwgQnVmZmVyU291cmNlIHF1ZXVlZCBhdCB0aGUgQXVkaW9Db250ZXh0LlxuICAgICAgcXVldWVkQnVmZmVyU291cmNlcy5wdXNoKGJ1ZmZlclNvdXJjZSk7XG5cbiAgICAgIG5leHRTY2hlZHVsZSArPSBuZXh0QnVmZmVyLmR1cmF0aW9uO1xuXG4gICAgICBidWZmZXJTb3VyY2UuYWRkRXZlbnRMaXN0ZW5lcignZW5kZWQnLCAoKSA9PiB7XG4gICAgICAgIHF1ZXVlZEJ1ZmZlclNvdXJjZXMgPSBxdWV1ZWRCdWZmZXJTb3VyY2VzLmZpbHRlcih0YXJnZXQgPT4gdGFyZ2V0ICE9PSBidWZmZXJTb3VyY2UpO1xuXG4gICAgICAgIC8vIERlY2xhcmUgdGhlIGJ1ZmZlciBpcyBmcmVlIHRvIHBpY2sgdXAgb24gdGhlIG5leHQgaXRlcmF0aW9uLlxuICAgICAgICBmcmVlQnVmZmVycy5wdXNoKG5leHRCdWZmZXIpO1xuICAgICAgICBwbGF5TmV4dCgpO1xuICAgICAgfSk7XG4gICAgfVxuICB9O1xuXG4gIHJldHVybiB7XG4gICAgY2FuY2VsQWxsOiAoKSA9PiB7XG4gICAgICBxdWV1ZS5zcGxpY2UoMCk7XG5cbiAgICAgIC8vIEFsdGhvdWdoIGFsbCBidWZmZXJzIGFyZSBjbGVhcmVkLCB0aGVyZSBhcmUgc3RpbGwgc29tZSBCdWZmZXJTb3VyY2VzIHF1ZXVlZCBhdCB0aGUgQXVkaW9Db250ZXh0IHRoYXQgbmVlZCB0byBiZSBzdG9wcGVkLlxuICAgICAgcXVldWVkQnVmZmVyU291cmNlcy5mb3JFYWNoKGJ1ZmZlclNvdXJjZSA9PiBidWZmZXJTb3VyY2Uuc3RvcCgpKTtcbiAgICB9LFxuICAgIGZsdXNoOiAoKSA9PiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHF1ZXVlLnB1c2gocmVzb2x2ZSkpLFxuICAgIHB1c2g6IG11bHRpQ2hhbm5lbEFycmF5ID0+IHtcbiAgICAgIGlmICghbXVsdGlDaGFubmVsQXJyYXkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdtdWx0aUNoYW5uZWxBcnJheSBtdXN0IG5vdCBiZSBmYWxzeS4nKTtcbiAgICAgIH1cblxuICAgICAgcXVldWUucHVzaChtdWx0aUNoYW5uZWxBcnJheSk7XG5cbiAgICAgIHBsYXlOZXh0KCk7XG4gICAgfVxuICB9O1xufVxuIl19