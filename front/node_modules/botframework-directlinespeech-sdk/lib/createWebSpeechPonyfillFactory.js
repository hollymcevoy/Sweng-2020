"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _typeof = require("@babel/runtime/helpers/typeof");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _default;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _abortControllerEs = require("abort-controller-es5");

var _SpeechToText = require("web-speech-cognitive-services/lib/SpeechServices/SpeechToText");

var _createTaskQueue2 = _interopRequireDefault(require("./createTaskQueue"));

var _es = _interopRequireWildcard(require("event-target-shim/es5"));

var _playCognitiveServicesStream = _interopRequireDefault(require("./playCognitiveServicesStream"));

var _playWhiteNoise = _interopRequireDefault(require("./playWhiteNoise"));

var _SpeechSynthesisAudioStreamUtterance = _interopRequireDefault(require("./SpeechSynthesisAudioStreamUtterance"));

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || _typeof(obj) !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = (0, _getPrototypeOf2.default)(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = (0, _getPrototypeOf2.default)(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return (0, _possibleConstructorReturn2.default)(this, result); }; }

function _isNativeReflectConstruct() { if (typeof Reflect === "undefined" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === "function") return true; try { Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {})); return true; } catch (e) { return false; } }

function _default(_ref) {
  var audioContext = _ref.audioContext,
      enableTelemetry = _ref.enableTelemetry,
      _ref$ponyfill = _ref.ponyfill,
      ponyfill = _ref$ponyfill === void 0 ? {
    AudioContext: window.AudioContext || window.webkitAudioContext
  } : _ref$ponyfill,
      recognizer = _ref.recognizer,
      textNormalization = _ref.textNormalization;

  if (!ponyfill.AudioContext) {
    console.warn('botframework-directlinespeech-sdk: This browser does not support Web Audio API. Speech support is disabled.');
    return function () {
      return {};
    };
  }

  return function () {
    var _createSpeechRecognit = (0, _SpeechToText.createSpeechRecognitionPonyfillFromRecognizer)({
      createRecognizer: function createRecognizer() {
        return recognizer;
      },
      enableTelemetry: enableTelemetry,
      looseEvents: true,
      textNormalization: textNormalization
    }),
        SpeechGrammarList = _createSpeechRecognit.SpeechGrammarList,
        SpeechRecognition = _createSpeechRecognit.SpeechRecognition;

    if (!audioContext) {
      audioContext = new ponyfill.AudioContext();
    }

    var _createTaskQueue = (0, _createTaskQueue2.default)(),
        cancelAll = _createTaskQueue.cancelAll,
        push = _createTaskQueue.push;

    var SpeechSynthesis = /*#__PURE__*/function (_EventTarget) {
      (0, _inherits2.default)(SpeechSynthesis, _EventTarget);

      var _super = _createSuper(SpeechSynthesis);

      function SpeechSynthesis() {
        (0, _classCallCheck2.default)(this, SpeechSynthesis);
        return _super.apply(this, arguments);
      }

      (0, _createClass2.default)(SpeechSynthesis, [{
        key: "cancel",
        value: function cancel() {
          cancelAll();
        } // Returns an empty array.
        // Synthesis is done on the bot side, the content of the voice list is not meaningful on the client side.

      }, {
        key: "getVoices",
        value: function getVoices() {
          return [];
        }
      }, {
        key: "speak",
        value: function speak(utterance) {
          var _push = push(function () {
            var controller = new _abortControllerEs.AbortController();
            var signal = controller.signal;
            return {
              abort: controller.abort.bind(controller),
              result: (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee() {
                return _regenerator.default.wrap(function _callee$(_context) {
                  while (1) {
                    switch (_context.prev = _context.next) {
                      case 0:
                        utterance.dispatchEvent(new _es.Event('start'));
                        _context.prev = 1;

                        if (!utterance.audioStream) {
                          _context.next = 7;
                          break;
                        }

                        _context.next = 5;
                        return (0, _playCognitiveServicesStream.default)(audioContext, utterance.audioStream, {
                          signal: signal
                        });

                      case 5:
                        _context.next = 9;
                        break;

                      case 7:
                        _context.next = 9;
                        return (0, _playWhiteNoise.default)(audioContext);

                      case 9:
                        _context.next = 15;
                        break;

                      case 11:
                        _context.prev = 11;
                        _context.t0 = _context["catch"](1);

                        if (!(_context.t0.message !== 'aborted')) {
                          _context.next = 15;
                          break;
                        }

                        return _context.abrupt("return", utterance.dispatchEvent(new ErrorEvent(_context.t0)));

                      case 15:
                        utterance.dispatchEvent(new _es.Event('end'));

                      case 16:
                      case "end":
                        return _context.stop();
                    }
                  }
                }, _callee, null, [[1, 11]]);
              }))()
            };
          }),
              result = _push.result; // Catching the error to prevent uncaught promise error due to cancellation.


          result.catch(function (error) {
            if (!/^cancelled/i.test(error.message)) {
              throw error;
            }
          });
        }
      }, {
        key: "onvoiceschanged",
        get: function get() {
          return (0, _es.getEventAttributeValue)(this, 'voiceschanged');
        },
        set: function set(value) {
          (0, _es.setEventAttributeValue)(this, 'voiceschanged', value);
        }
      }]);
      return SpeechSynthesis;
    }(_es.default);

    return {
      SpeechGrammarList: SpeechGrammarList,
      SpeechRecognition: SpeechRecognition,
      speechSynthesis: new SpeechSynthesis(),
      SpeechSynthesisUtterance: _SpeechSynthesisAudioStreamUtterance.default
    };
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jcmVhdGVXZWJTcGVlY2hQb255ZmlsbEZhY3RvcnkuanMiXSwibmFtZXMiOlsiYXVkaW9Db250ZXh0IiwiZW5hYmxlVGVsZW1ldHJ5IiwicG9ueWZpbGwiLCJBdWRpb0NvbnRleHQiLCJ3aW5kb3ciLCJ3ZWJraXRBdWRpb0NvbnRleHQiLCJyZWNvZ25pemVyIiwidGV4dE5vcm1hbGl6YXRpb24iLCJjb25zb2xlIiwid2FybiIsImNyZWF0ZVJlY29nbml6ZXIiLCJsb29zZUV2ZW50cyIsIlNwZWVjaEdyYW1tYXJMaXN0IiwiU3BlZWNoUmVjb2duaXRpb24iLCJjYW5jZWxBbGwiLCJwdXNoIiwiU3BlZWNoU3ludGhlc2lzIiwidXR0ZXJhbmNlIiwiY29udHJvbGxlciIsIkFib3J0Q29udHJvbGxlciIsInNpZ25hbCIsImFib3J0IiwiYmluZCIsInJlc3VsdCIsImRpc3BhdGNoRXZlbnQiLCJFdmVudCIsImF1ZGlvU3RyZWFtIiwibWVzc2FnZSIsIkVycm9yRXZlbnQiLCJjYXRjaCIsImVycm9yIiwidGVzdCIsInZhbHVlIiwiRXZlbnRUYXJnZXQiLCJzcGVlY2hTeW50aGVzaXMiLCJTcGVlY2hTeW50aGVzaXNVdHRlcmFuY2UiLCJTcGVlY2hTeW50aGVzaXNBdWRpb1N0cmVhbVV0dGVyYW5jZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7Ozs7O0FBRWUsd0JBUVo7QUFBQSxNQVBEQSxZQU9DLFFBUERBLFlBT0M7QUFBQSxNQU5EQyxlQU1DLFFBTkRBLGVBTUM7QUFBQSwyQkFMREMsUUFLQztBQUFBLE1BTERBLFFBS0MsOEJBTFU7QUFDVEMsSUFBQUEsWUFBWSxFQUFFQyxNQUFNLENBQUNELFlBQVAsSUFBdUJDLE1BQU0sQ0FBQ0M7QUFEbkMsR0FLVjtBQUFBLE1BRkRDLFVBRUMsUUFGREEsVUFFQztBQUFBLE1BRERDLGlCQUNDLFFBRERB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Q0QsU0EvRFE7QUFBQSxhQWlFVCxhQUFvQkUsS0FBcEIsRUFBMkI7QUFDekIsMENBQXVCLElBQXZCLEVBQTZCLGVBQTdCLEVBQThDQSxLQUE5QztBQUNEO0FBbkVRO0FBQUE7QUFBQSxNQWNtQkMsV0FkbkI7O0FBc0VYLFdBQU87QUFDTHJCLE1BQUFBLGlCQUFpQixFQUFqQkEsaUJBREs7QUFFTEMsTUFBQUEsaUJBQWlCLEVBQWpCQSxpQkFGSztBQUdMcUIsTUFBQUEsZUFBZSxFQUFFLElBQUlsQixlQUFKLEVBSFo7QUFJTG1CLE1BQUFBLHdCQUF3QixFQUFFQztBQUpyQixLQUFQO0FBTUQsR0E1RUQ7QUE2RUQiLCJzb3VyY2VSb290IjoiZGlyZWN0bGluZXNwZWVjaDovLy8iLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQgY2xhc3MtbWV0aG9kcy11c2UtdGhpczogW1wiZXJyb3JcIiwgeyBcImV4Y2VwdE1ldGhvZHNcIjogW1wiY2FuY2VsXCIsIFwiZ2V0Vm9pY2VzXCIsIFwic3BlYWtcIl0gfV0gKi9cblxuaW1wb3J0IHsgQWJvcnRDb250cm9sbGVyIH0gZnJvbSAnYWJvcnQtY29udHJvbGxlci1lczUnO1xuaW1wb3J0IHsgY3JlYXRlU3BlZWNoUmVjb2duaXRpb25Qb255ZmlsbEZyb21SZWNvZ25pemVyIH0gZnJvbSAnd2ViLXNwZWVjaC1jb2duaXRpdmUtc2VydmljZXMvbGliL1NwZWVjaFNlcnZpY2VzL1NwZWVjaFRvVGV4dCc7XG5cbmltcG9ydCBjcmVhdGVUYXNrUXVldWUgZnJvbSAnLi9jcmVhdGVUYXNrUXVldWUnO1xuaW1wb3J0IEV2ZW50VGFyZ2V0LCB7IEV2ZW50LCBnZXRFdmVudEF0dHJpYnV0ZVZhbHVlLCBzZXRFdmVudEF0dHJpYnV0ZVZhbHVlIH0gZnJvbSAnZXZlbnQtdGFyZ2V0LXNoaW0vZXM1JztcbmltcG9ydCBwbGF5Q29nbml0aXZlU2VydmljZXNTdHJlYW0gZnJvbSAnLi9wbGF5Q29nbml0aXZlU2VydmljZXNTdHJlYW0nO1xuaW1wb3J0IHBsYXlXaGl0ZU5vaXNlIGZyb20gJy4vcGxheVdoaXRlTm9pc2UnO1xuaW1wb3J0IFNwZWVjaFN5bnRoZXNpc0F1ZGlvU3RyZWFtVXR0ZXJhbmNlIGZyb20gJy4vU3BlZWNoU3ludGhlc2lzQXVkaW9TdHJlYW1VdHRlcmFuY2UnO1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiAoe1xuICBhdWRpb0NvbnRleHQsXG4gIGVuYWJsZVRlbGVtZXRyeSxcbiAgcG9ueWZpbGwgPSB7XG4gICAgQXVkaW9Db250ZXh0OiB3aW5kb3cuQXVkaW9Db250ZXh0IHx8IHdpbmRvdy53ZWJraXRBdWRpb0NvbnRleHRcbiAgfSxcbiAgcmVjb2duaXplcixcbiAgdGV4dE5vcm1hbGl6YXRpb25cbn0pIHtcbiAgaWYgKCFwb255ZmlsbC5BdWRpb0NvbnRleHQpIHtcbiAgICBjb25zb2xlLndhcm4oXG4gICAgICAnYm90ZnJhbWV3b3JrLWRpcmVjdGxpbmVzcGVlY2gtc2RrOiBUaGlzIGJyb3dzZXIgZG9lcyBub3Qgc3VwcG9ydCBXZWIgQXVkaW8gQVBJLiBTcGVlY2ggc3VwcG9ydCBpcyBkaXNhYmxlZC4nXG4gICAgKTtcblxuICAgIHJldHVybiAoKSA9PiAoe30pO1xuICB9XG5cbiAgcmV0dXJuICgpID0+IHtcbiAgICBjb25zdCB7IFNwZWVjaEdyYW1tYXJMaXN0LCBTcGVlY2hSZWNvZ25pdGlvbiB9ID0gY3JlYXRlU3BlZWNoUmVjb2duaXRpb25Qb255ZmlsbEZyb21SZWNvZ25pemVyKHtcbiAgICAgIGNyZWF0ZVJlY29nbml6ZXI6ICgpID0+IHJlY29nbml6ZXIsXG4gICAgICBlbmFibGVUZWxlbWV0cnksXG4gICAgICBsb29zZUV2ZW50czogdHJ1ZSxcbiAgICAgIHRleHROb3JtYWxpemF0aW9uXG4gICAgfSk7XG5cbiAgICBpZiAoIWF1ZGlvQ29udGV4dCkge1xuICAgICAgYXVkaW9Db250ZXh0ID0gbmV3IHBvbnlmaWxsLkF1ZGlvQ29udGV4dCgpO1xuICAgIH1cblxuICAgIGNvbnN0IHsgY2FuY2VsQWxsLCBwdXNoIH0gPSBjcmVhdGVUYXNrUXVldWUoKTtcblxuICAgIGNsYXNzIFNwZWVjaFN5bnRoZXNpcyBleHRlbmRzIEV2ZW50VGFyZ2V0IHtcbiAgICAgIGNhbmNlbCgpIHtcbiAgICAgICAgY2FuY2VsQWxsKCk7XG4gICAgICB9XG5cbiAgICAgIC8vIFJldHVybnMgYW4gZW1wdHkgYXJyYXkuXG4gICAgICAvLyBTeW50aGVzaXMgaXMgZG9uZSBvbiB0aGUgYm90IHNpZGUsIHRoZSBjb250ZW50IG9mIHRoZSB2b2ljZSBsaXN0IGlzIG5vdCBtZWFuaW5nZnVsIG9uIHRoZSBjbGllbnQgc2lkZS5cbiAgICAgIGdldFZvaWNlcygpIHtcbiAgICAgICAgcmV0dXJuIFtdO1xuICAgICAgfVxuXG4gICAgICBzcGVhayh1dHRlcmFuY2UpIHtcbiAgICAgICAgY29uc3QgeyByZXN1bHQgfSA9IHB1c2goKCkgPT4ge1xuICAgICAgICAgIGNvbnN0IGNvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7XG4gICAgICAgICAgY29uc3QgeyBzaWduYWwgfSA9IGNvbnRyb2xsZXI7XG5cbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgYWJvcnQ6IGNvbnRyb2xsZXIuYWJvcnQuYmluZChjb250cm9sbGVyKSxcbiAgICAgICAgICAgIHJlc3VsdDogKGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgICAgdXR0ZXJhbmNlLmRpc3BhdGNoRXZlbnQobmV3IEV2ZW50KCdzdGFydCcpKTtcblxuICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGlmICh1dHRlcmFuY2UuYXVkaW9TdHJlYW0pIHtcbiAgICAgICAgICAgICAgICAgIGF3YWl0IHBsYXlDb2duaXRpdmVTZXJ2aWNlc1N0cmVhbShhdWRpb0NvbnRleHQsIHV0dGVyYW5jZS5hdWRpb1N0cmVhbSwgeyBzaWduYWwgfSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgIGF3YWl0IHBsYXlXaGl0ZU5vaXNlKGF1ZGlvQ29udGV4dCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIC8vIEVpdGhlciBkaXNwYXRjaCBcImVuZFwiIG9yIFwiZXJyb3JcIiBldmVudCwgYnV0IG5vdCBib3RoXG4gICAgICAgICAgICAgICAgaWYgKGVycm9yLm1lc3NhZ2UgIT09ICdhYm9ydGVkJykge1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIHV0dGVyYW5jZS5kaXNwYXRjaEV2ZW50KG5ldyBFcnJvckV2ZW50KGVycm9yKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgdXR0ZXJhbmNlLmRpc3BhdGNoRXZlbnQobmV3IEV2ZW50KCdlbmQnKSk7XG4gICAgICAgICAgICB9KSgpXG4gICAgICAgICAgfTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gQ2F0Y2hpbmcgdGhlIGVycm9yIHRvIHByZXZlbnQgdW5jYXVnaHQgcHJvbWlzZSBlcnJvciBkdWUgdG8gY2FuY2VsbGF0aW9uLlxuICAgICAgICByZXN1bHQuY2F0Y2goZXJyb3IgPT4ge1xuICAgICAgICAgIGlmICghL15jYW5jZWxsZWQvaXUudGVzdChlcnJvci5tZXNzYWdlKSkge1xuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgZ2V0IG9udm9pY2VzY2hhbmdlZCgpIHtcbiAgICAgICAgcmV0dXJuIGdldEV2ZW50QXR0cmlidXRlVmFsdWUodGhpcywgJ3ZvaWNlc2NoYW5nZWQnKTtcbiAgICAgIH1cblxuICAgICAgc2V0IG9udm9pY2VzY2hhbmdlZCh2YWx1ZSkge1xuICAgICAgICBzZXRFdmVudEF0dHJpYnV0ZVZhbHVlKHRoaXMsICd2b2ljZXNjaGFuZ2VkJywgdmFsdWUpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBTcGVlY2hHcmFtbWFyTGlzdCxcbiAgICAgIFNwZWVjaFJlY29nbml0aW9uLFxuICAgICAgc3BlZWNoU3ludGhlc2lzOiBuZXcgU3BlZWNoU3ludGhlc2lzKCksXG4gICAgICBTcGVlY2hTeW50aGVzaXNVdHRlcmFuY2U6IFNwZWVjaFN5bnRoZXNpc0F1ZGlvU3RyZWFtVXR0ZXJhbmNlXG4gICAgfTtcbiAgfTtcbn1cbiJdfQ==