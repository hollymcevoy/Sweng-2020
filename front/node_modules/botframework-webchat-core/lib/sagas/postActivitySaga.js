"use strict";

var _regeneratorRuntime2 = require("@babel/runtime/regenerator");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = postActivitySaga;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _effects = require("redux-saga/effects");

var _observeOnce = _interopRequireDefault(require("./effects/observeOnce"));

var _whileConnected = _interopRequireDefault(require("./effects/whileConnected"));

var _clockSkewAdjustment = _interopRequireDefault(require("../selectors/clockSkewAdjustment"));

var _combineSelectors = _interopRequireDefault(require("../selectors/combineSelectors"));

var _dateToLocaleISOString = _interopRequireDefault(require("../utils/dateToLocaleISOString"));

var _language = _interopRequireDefault(require("../selectors/language"));

var _sendTimeout = _interopRequireDefault(require("../selectors/sendTimeout"));

var _deleteKey = _interopRequireDefault(require("../utils/deleteKey"));

var _sleep = _interopRequireDefault(require("../utils/sleep"));

var _uniqueID = _interopRequireDefault(require("../utils/uniqueID"));

var _postActivity = require("../actions/postActivity");

var _incomingActivity = require("../actions/incomingActivity");

var _marked = /*#__PURE__*/_regeneratorRuntime2.mark(postActivity),
    _marked2 = /*#__PURE__*/_regeneratorRuntime2.mark(postActivitySaga);

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function getTimestamp(date) {
  var clockSkewAdjustment = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 0;
  // "+date" will return epoch time in milliseconds, same as Date.getTime().
  return new Date(+date + clockSkewAdjustment).toISOString();
}

function postActivity(directLine, userID, username, numActivitiesPosted, _ref) {
  var method, activity, _yield$select, clockSkewAdjustment, locale, _activity, attachments, clientActivityID, now, localTimeZone, meta, echoBackCall, sendTimeout, _yield$race, echoBack;

  return _regenerator["default"].wrap(function postActivity$(_context2) {
    while (1) {
      switch (_context2.prev = _context2.next) {
        case 0:
          method = _ref.meta.method, activity = _ref.payload.activity;
          _context2.next = 3;
          return (0, _effects.select)((0, _combineSelectors["default"])({
            clockSkewAdjustment: _clockSkewAdjustment["default"],
            locale: _language["default"]
          }));

        case 3:
          _yield$select = _context2.sent;
          clockSkewAdjustment = _yield$select.clockSkewAdjustment;
          locale = _yield$select.locale;
          _activity = activity, attachments = _activity.attachments;
          clientActivityID = (0, _uniqueID["default"])();
          now = new Date();
          localTimeZone = typeof window.Intl === 'undefined' ? undefined : new Intl.DateTimeFormat().resolvedOptions().timeZone;
          activity = _objectSpread(_objectSpread({}, (0, _deleteKey["default"])(activity, 'id')), {}, {
            attachments: attachments && attachments.map(function (_ref2) {
              var contentType = _ref2.contentType,
                  contentUrl = _ref2.contentUrl,
                  name = _ref2.name,
                  thumbnailUrl = _ref2.thumbnailUrl;
              return {
                contentType: contentType,
                contentUrl: contentUrl,
                name: name,
                thumbnailUrl: thumbnailUrl
              };
            }),
            channelData: _objectSpread(_objectSpread({}, (0, _deleteKey["default"])(activity.channelData, 'state')), {}, {
              clientActivityID: clientActivityID,
              // This is unskewed local timestamp for estimating clock skew.
              clientTimestamp: getTimestamp(now)
            }),
            channelId: 'webchat',
            from: {
              id: userID,
              name: username,
              role: 'user'
            },
            locale: locale,
            localTimestamp: (0, _dateToLocaleISOString["default"])(now),
            localTimezone: localTimeZone,
            // This timestamp will be replaced by Direct Line Channel in echoback.
            // We are temporarily adding this timestamp for sorting.
            timestamp: getTimestamp(now, clockSkewAdjustment)
          });

          if (!numActivitiesPosted) {
            activity.entities = [].concat((0, _toConsumableArray2["default"])(activity.entities || []), [{
              // TODO: [P4] Currently in v3, we send the capabilities although the client might not actually have them
              //       We need to understand why we need to send these, and only send capabilities the client have
              requiresBotState: true,
              supportsListening: true,
              supportsTts: true,
              type: 'ClientCapabilities'
            }]);
          }

          meta = {
            clientActivityID: clientActivityID,
            method: method
          };
          _context2.next = 15;
          return (0, _effects.put)({
            type: _postActivity.POST_ACTIVITY_PENDING,
            meta: meta,
            payload: {
              activity: activity
            }
          });

        case 15:
          _context2.prev = 15;
          // Quirks: We might receive INCOMING_ACTIVITY before the postActivity call completed
          //         So, we setup expectation first, then postActivity afterward
          echoBackCall = (0, _effects.call)( /*#__PURE__*/_regenerator["default"].mark(function _callee() {
            var _yield$take, _activity2, _activity2$channelDat, channelData, id;

            return _regenerator["default"].wrap(function _callee$(_context) {
              while (1) {
                switch (_context.prev = _context.next) {
                  case 0:
                    _context.next = 2;
                    return (0, _effects.take)(_incomingActivity.INCOMING_ACTIVITY);

                  case 2:
                    _yield$take = _context.sent;
                    _activity2 = _yield$take.payload.activity;
                    _activity2$channelDat = _activity2.channelData, channelData = _activity2$channelDat === void 0 ? {} : _activity2$channelDat, id = _activity2.id;

                    if (!(channelData.clientActivityID === clientActivityID && id)) {
                      _context.next = 7;
                      break;
                    }

                    return _context.abrupt("return", _activity2);

                  case 7:
                    _context.next = 0;
                    break;

                  case 9:
                  case "end":
                    return _context.stop();
                }
              }
            }, _callee);
          })); // Timeout could be due to either:
          // - Post activity call may take too long time to complete
          //   - Direct Line service only respond on HTTP after bot respond to Direct Line
          // - Activity may take too long time to echo back

          _context2.next = 19;
          return (0, _effects.select)(_sendTimeout["default"]);

        case 19:
          sendTimeout = _context2.sent;
          _context2.next = 22;
          return (0, _effects.race)({
            send: (0, _effects.all)({
              echoBack: echoBackCall,
              postActivity: (0, _observeOnce["default"])(directLine.postActivity(activity))
            }),
            timeout: (0, _effects.call)(function () {
              return (0, _sleep["default"])(sendTimeout).then(function () {
                return Promise.reject(new Error('timeout'));
              });
            })
          });

        case 22:
          _yield$race = _context2.sent;
          echoBack = _yield$race.send.echoBack;
          _context2.next = 26;
          return (0, _effects.put)({
            type: _postActivity.POST_ACTIVITY_FULFILLED,
            meta: meta,
            payload: {
              activity: echoBack
            }
          });

        case 26:
          _context2.next = 33;
          break;

        case 28:
          _context2.prev = 28;
          _context2.t0 = _context2["catch"](15);
          console.error('botframework-webchat: Failed to post activity to chat adapter.', _context2.t0);
          _context2.next = 33;
          return (0, _effects.put)({
            type: _postActivity.POST_ACTIVITY_REJECTED,
            error: true,
            meta: meta,
            payload: _context2.t0
          });

        case 33:
          _context2.prev = 33;
          _context2.next = 36;
          return (0, _effects.cancelled)();

        case 36:
          if (!_context2.sent) {
            _context2.next = 39;
            break;
          }

          _context2.next = 39;
          return (0, _effects.put)({
            type: _postActivity.POST_ACTIVITY_REJECTED,
            error: true,
            meta: meta,
            payload: new Error('cancelled')
          });

        case 39:
          return _context2.finish(33);

        case 40:
        case "end":
          return _context2.stop();
      }
    }
  }, _marked, null, [[15, 28, 33, 40]]);
}

function postActivitySaga() {
  return _regenerator["default"].wrap(function postActivitySaga$(_context5) {
    while (1) {
      switch (_context5.prev = _context5.next) {
        case 0:
          _context5.next = 2;
          return (0, _whileConnected["default"])( /*#__PURE__*/_regenerator["default"].mark(function postActivityWhileConnected(_ref3) {
            var directLine, userID, username, numActivitiesPosted;
            return _regenerator["default"].wrap(function postActivityWhileConnected$(_context4) {
              while (1) {
                switch (_context4.prev = _context4.next) {
                  case 0:
                    directLine = _ref3.directLine, userID = _ref3.userID, username = _ref3.username;
                    numActivitiesPosted = 0;
                    _context4.next = 4;
                    return (0, _effects.takeEvery)(_postActivity.POST_ACTIVITY, /*#__PURE__*/_regenerator["default"].mark(function postActivityWrapper(action) {
                      return _regenerator["default"].wrap(function postActivityWrapper$(_context3) {
                        while (1) {
                          switch (_context3.prev = _context3.next) {
                            case 0:
                              return _context3.delegateYield(postActivity(directLine, userID, username, numActivitiesPosted++, action), "t0", 1);

                            case 1:
                            case "end":
                              return _context3.stop();
                          }
                        }
                      }, postActivityWrapper);
                    }));

                  case 4:
                  case "end":
                    return _context4.stop();
                }
              }
            }, postActivityWhileConnected);
          }));

        case 2:
        case "end":
          return _context5.stop();
      }
    }
  }, _marked2);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zYWdhcy9wb3N0QWN0aXZpdHlTYWdhLmpzIl0sIm5hbWVzIjpbInBvc3RBY3Rpdml0eSIsInBvc3RBY3Rpdml0eVNhZ2EiLCJnZXRUaW1lc3RhbXAiLCJkYXRlIiwiY2xvY2tTa2V3QWRqdXN0bWVudCIsIkRhdGUiLCJ0b0lTT1N0cmluZyIsImRpcmVjdExpbmUiLCJ1c2VySUQiLCJ1c2VybmFtZSIsIm51bUFjdGl2aXRpZXNQb3N0ZWQiLCJtZXRob2QiLCJtZXRhIiwiYWN0aXZpdHkiLCJwYXlsb2FkIiwiY2xvY2tTa2V3QWRqdXN0bWVudFNlbGVjdG9yIiwibG9jYWxlIiwibGFuZ3VhZ2VTZWxlY3RvciIsImF0dGFjaG1lbnRzIiwiY2xpZW50QWN0aXZpdHlJRCIsIm5vdyIsImxvY2FsVGltZVpvbmUiLCJ3aW5kb3ciLCJJbnRsIiwidW5kZWZpbmVkIiwiRGF0ZVRpbWVGb3JtYXQiLCJyZXNvbHZlZE9wdGlvbnMiLCJ0aW1lWm9uZSIsIm1hcCIsImNvbnRlbnRUeXBlIiwiY29udGVudFVybCIsIm5hbWUiLCJ0aHVtYm5haWxVcmwiLCJjaGFubmVsRGF0YSIsImNsaWVudFRpbWVzdGFtcCIsImNoYW5uZWxJZCIsImZyb20iLCJpZCIsInJvbGUiLCJsb2NhbFRpbWVzdGFtcCIsImxvY2FsVGltZXpvbmUiLCJ0aW1lc3RhbXAiLCJlbnRpdGllcyIsInJlcXVpcmVzQm90U3RhdGUiLCJzdXBwb3J0c0xpc3RlbmluZyIsInN1cHBvcnRzVHRzIiwidHlwZSIsIlBPU1RfQUNUSVZJVFlfUEVORElORyIsImVjaG9CYWNrQ2FsbCIsIklOQ09NSU5HX0FDVElWSVRZIiwic2VuZFRpbWVvdXRTZWxlY3RvciIsInNlbmRUaW1lb3V0Iiwic2VuZCIsImVjaG9CYWNrIiwidGltZW91dCIsInRoZW4iLCJQcm9taXNlIiwicmVqZWN0IiwiRXJyb3IiLCJQT1NUX0FDVElWSVRZX0ZVTEZJTExFRCIsImNvbnNvbGUiLCJlcnJvciIsIlBPU1RfQUNUSVZJVFlfUkVKRUNURUQiLCJwb3N0QWN0aXZpdHlXaGlsZUNvbm5lY3RlZCIsIlBPU1RfQUNUSVZJVFkiLCJwb3N0QWN0aXZpdHlXcmFwcGVyIiwiYWN0aW9uIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUVBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUVBOztBQU9BOztxREFPVUEsWTtzREF3R2VDLGdCOzs7Ozs7QUE3R3pCLFNBQVNDLFlBQVQsQ0FBc0JDLElBQXRCLEVBQXFEO0FBQUEsTUFBekJDLG1CQUF5Qix1RUFBSCxDQUFHO0FBQ25EO0FBQ0EsU0FBTyxJQUFJQyxJQUFKLENBQVMsQ0FBQ0YsSUFBRCxHQUFRQyxtQkFBakIsRUFBc0NFLFdBQXRDLEVBQVA7QUFDRDs7QUFFRCxTQUFVTixZQUFWLENBQXVCTyxVQUF2QixFQUFtQ0MsTUFBbkMsRUFBMkNDLFFBQTNDLEVBQXFEQyxtQkFBckQ7QUFBQTs7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFvRkMsVUFBQUEsTUFBcEYsUUFBNEVDLElBQTVFLENBQW9GRCxNQUFwRixFQUF5R0UsUUFBekcsUUFBOEZDLE9BQTlGLENBQXlHRCxRQUF6RztBQUFBO0FBQzBDLGlCQUFNLHFCQUM1QyxrQ0FBaUI7QUFBRVQsWUFBQUEsbUJBQW1CLEVBQUVXLCtCQUF2QjtBQUFvREMsWUFBQUEsTUFBTSxFQUFFQztBQUE1RCxXQUFqQixDQUQ0QyxDQUFOOztBQUQxQztBQUFBO0FBQ1ViLFVBQUFBLG1CQURWLGlCQUNVQSxtQkFEVjtBQUMrQlksVUFBQUEsTUFEL0IsaUJBQytCQSxNQUQvQjtBQUFBLHNCQUkwQkgsUUFKMUIsRUFJVUssV0FKVixhQUlVQSxXQUpWO0FBS1FDLFVBQUFBLGdCQUxSLEdBSzJCLDJCQUwzQjtBQU1RQyxVQUFBQSxHQU5SLEdBTWMsSUFBSWYsSUFBSixFQU5kO0FBT1FnQixVQUFBQSxhQVBSLEdBUUksT0FBT0MsTUFBTSxDQUFDQyxJQUFkLEtBQXVCLFdBQXZCLEdB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QUFBO0FBa0dRLGlCQUFNLHlCQUFOOztBQWxHUjtBQUFBO0FBQUE7QUFBQTtBQUFBOztBQUFBO0FBbUdNLGlCQUFNLGtCQUFJO0FBQUVnQyxZQUFBQSxJQUFJLEVBQUVnQixvQ0FBUjtBQUFnQ0QsWUFBQUEsS0FBSyxFQUFFLElBQXZDO0FBQTZDakQsWUFBQUEsSUFBSSxFQUFKQSxJQUE3QztBQUFtREUsWUFBQUEsT0FBTyxFQUFFLElBQUk0QyxLQUFKLENBQVUsV0FBVjtBQUE1RCxXQUFKLENBQU47O0FBbkdOO0FBQUE7O0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7O0FBd0dlLFNBQVV6RCxnQkFBVjtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFDYixpQkFBTSwyRUFBZSxTQUFVOEQsMEJBQVY7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQXVDeEQsb0JBQUFBLFVBQXZDLFNBQXVDQSxVQUF2QyxFQUFtREMsTUFBbkQsU0FBbURBLE1BQW5ELEVBQTJEQyxRQUEzRCxTQUEyREEsUUFBM0Q7QUFDZkMsb0JBQUFBLG1CQURlLEdBQ08sQ0FEUDtBQUFBO0FBR25CLDJCQUFNLHdCQUFVc0QsMkJBQVYsNENBQXlCLFNBQVVDLG1CQUFWLENBQThCQyxNQUE5QjtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQzdCLDZEQUFPbEUsWUFBWSxDQUFDTyxVQUFELEVBQWFDLE1BQWIsRUFBcUJDLFFBQXJCLEVBQStCQyxtQkFBbUIsRUFBbEQsRUFBc0R3RCxNQUF0RCxDQUFuQjs7QUFENkI7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLHlCQUFVRCxtQkFBVjtBQUFBLHFCQUF6QixFQUFOOztBQUhtQjtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUEsZUFBVUYsMEJBQVY7QUFBQSxXQUFmLEVBQU47O0FBRGE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUEiLCJzb3VyY2VSb290IjoiY29yZTovLy8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBhbGwsIGNhbGwsIGNhbmNlbGxlZCwgcHV0LCByYWNlLCBzZWxlY3QsIHRha2UsIHRha2VFdmVyeSB9IGZyb20gJ3JlZHV4LXNhZ2EvZWZmZWN0cyc7XG5cbmltcG9ydCBvYnNlcnZlT25jZSBmcm9tICcuL2VmZmVjdHMvb2JzZXJ2ZU9uY2UnO1xuaW1wb3J0IHdoaWxlQ29ubmVjdGVkIGZyb20gJy4vZWZmZWN0cy93aGlsZUNvbm5lY3RlZCc7XG5cbmltcG9ydCBjbG9ja1NrZXdBZGp1c3RtZW50U2VsZWN0b3IgZnJvbSAnLi4vc2VsZWN0b3JzL2Nsb2NrU2tld0FkanVzdG1lbnQnO1xuaW1wb3J0IGNvbWJpbmVTZWxlY3RvcnMgZnJvbSAnLi4vc2VsZWN0b3JzL2NvbWJpbmVTZWxlY3RvcnMnO1xuaW1wb3J0IGRhdGVUb0xvY2FsZUlTT1N0cmluZyBmcm9tICcuLi91dGlscy9kYXRlVG9Mb2NhbGVJU09TdHJpbmcnO1xuaW1wb3J0IGxhbmd1YWdlU2VsZWN0b3IgZnJvbSAnLi4vc2VsZWN0b3JzL2xhbmd1YWdlJztcbmltcG9ydCBzZW5kVGltZW91dFNlbGVjdG9yIGZyb20gJy4uL3NlbGVjdG9ycy9zZW5kVGltZW91dCc7XG5cbmltcG9ydCBkZWxldGVLZXkgZnJvbSAnLi4vdXRpbHMvZGVsZXRlS2V5JztcbmltcG9ydCBzbGVlcCBmcm9tICcuLi91dGlscy9zbGVlcCc7XG5pbXBvcnQgdW5pcXVlSUQgZnJvbSAnLi4vdXRpbHMvdW5pcXVlSUQnO1xuXG5pbXBvcnQge1xuICBQT1NUX0FDVElWSVRZLFxuICBQT1NUX0FDVElWSVRZX0ZVTEZJTExFRCxcbiAgUE9TVF9BQ1RJVklUWV9QRU5ESU5HLFxuICBQT1NUX0FDVElWSVRZX1JFSkVDVEVEXG59IGZyb20gJy4uL2FjdGlvbnMvcG9zdEFjdGl2aXR5JztcblxuaW1wb3J0IHsgSU5DT01JTkdfQUNUSVZJVFkgfSBmcm9tICcuLi9hY3Rpb25zL2luY29taW5nQWN0aXZpdHknO1xuXG5mdW5jdGlvbiBnZXRUaW1lc3RhbXAoZGF0ZSwgY2xvY2tTa2V3QWRqdXN0bWVudCA9IDApIHtcbiAgLy8gXCIrZGF0ZVwiIHdpbGwgcmV0dXJuIGVwb2NoIHRpbWUgaW4gbWlsbGlzZWNvbmRzLCBzYW1lIGFzIERhdGUuZ2V0VGltZSgpLlxuICByZXR1cm4gbmV3IERhdGUoK2RhdGUgKyBjbG9ja1NrZXdBZGp1c3RtZW50KS50b0lTT1N0cmluZygpO1xufVxuXG5mdW5jdGlvbiogcG9zdEFjdGl2aXR5KGRpcmVjdExpbmUsIHVzZXJJRCwgdXNlcm5hbWUsIG51bUFjdGl2aXRpZXNQb3N0ZWQsIHsgbWV0YTogeyBtZXRob2QgfSwgcGF5bG9hZDogeyBhY3Rpdml0eSB9IH0pIHtcbiAgY29uc3QgeyBjbG9ja1NrZXdBZGp1c3RtZW50LCBsb2NhbGUgfSA9IHlpZWxkIHNlbGVjdChcbiAgICBjb21iaW5lU2VsZWN0b3JzKHsgY2xvY2tTa2V3QWRqdXN0bWVudDogY2xvY2tTa2V3QWRqdXN0bWVudFNlbGVjdG9yLCBsb2NhbGU6IGxhbmd1YWdlU2VsZWN0b3IgfSlcbiAgKTtcbiAgY29uc3QgeyBhdHRhY2htZW50cyB9ID0gYWN0aXZpdHk7XG4gIGNvbnN0IGNsaWVudEFjdGl2aXR5SUQgPSB1bmlxdWVJRCgpO1xuICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuICBjb25zdCBsb2NhbFRpbWVab25lID1cbiAgICB0eXBlb2Ygd2luZG93LkludGwgPT09ICd1bmRlZmluZWQnID8gdW5kZWZpbmVkIDogbmV3IEludGwuRGF0ZVRpbWVGb3JtYXQoKS5yZXNvbHZlZE9wdGlvbnMoKS50aW1lWm9uZTtcblxuICBhY3Rpdml0eSA9IHtcbiAgICAuLi5kZWxldGVLZXkoYWN0aXZpdHksICdpZCcpLFxuICAgIGF0dGFjaG1lbnRzOlxuICAgICAgYXR0YWNobWVudHMgJiZcbiAgICAgIGF0dGFjaG1lbnRzLm1hcCgoeyBjb250ZW50VHlwZSwgY29udGVudFVybCwgbmFtZSwgdGh1bWJuYWlsVXJsIH0pID0+ICh7XG4gICAgICAgIGNvbnRlbnRUeXBlLFxuICAgICAgICBjb250ZW50VXJsLFxuICAgICAgICBuYW1lLFxuICAgICAgICB0aHVtYm5haWxVcmxcbiAgICAgIH0pKSxcbiAgICBjaGFubmVsRGF0YToge1xuICAgICAgLi4uZGVsZXRlS2V5KGFjdGl2aXR5LmNoYW5uZWxEYXRhLCAnc3RhdGUnKSxcbiAgICAgIGNsaWVudEFjdGl2aXR5SUQsXG4gICAgICAvLyBUaGlzIGlzIHVuc2tld2VkIGxvY2FsIHRpbWVzdGFtcCBmb3IgZXN0aW1hdGluZyBjbG9jayBza2V3LlxuICAgICAgY2xpZW50VGltZXN0YW1wOiBnZXRUaW1lc3RhbXAobm93KVxuICAgIH0sXG4gICAgY2hhbm5lbElkOiAnd2ViY2hhdCcsXG4gICAgZnJvbToge1xuICAgICAgaWQ6IHVzZXJJRCxcbiAgICAgIG5hbWU6IHVzZXJuYW1lLFxuICAgICAgcm9sZTogJ3VzZXInXG4gICAgfSxcbiAgICBsb2NhbGUsXG4gICAgbG9jYWxUaW1lc3RhbXA6IGRhdGVUb0xvY2FsZUlTT1N0cmluZyhub3cpLFxuICAgIGxvY2FsVGltZXpvbmU6IGxvY2FsVGltZVpvbmUsXG4gICAgLy8gVGhpcyB0aW1lc3RhbXAgd2lsbCBiZSByZXBsYWNlZCBieSBEaXJlY3QgTGluZSBDaGFubmVsIGluIGVjaG9iYWNrLlxuICAgIC8vIFdlIGFyZSB0ZW1wb3JhcmlseSBhZGRpbmcgdGhpcyB0aW1lc3RhbXAgZm9yIHNvcnRpbmcuXG4gICAgdGltZXN0YW1wOiBnZXRUaW1lc3RhbXAobm93LCBjbG9ja1NrZXdBZGp1c3RtZW50KVxuICB9O1xuXG4gIGlmICghbnVtQWN0aXZpdGllc1Bvc3RlZCkge1xuICAgIGFjdGl2aXR5LmVudGl0aWVzID0gW1xuICAgICAgLi4uKGFjdGl2aXR5LmVudGl0aWVzIHx8IFtdKSxcbiAgICAgIHtcbiAgICAgICAgLy8gVE9ETzogW1A0XSBDdXJyZW50bHkgaW4gdjMsIHdlIHNlbmQgdGhlIGNhcGFiaWxpdGllcyBhbHRob3VnaCB0aGUgY2xpZW50IG1pZ2h0IG5vdCBhY3R1YWxseSBoYXZlIHRoZW1cbiAgICAgICAgLy8gICAgICAgV2UgbmVlZCB0byB1bmRlcnN0YW5kIHdoeSB3ZSBuZWVkIHRvIHNlbmQgdGhlc2UsIGFuZCBvbmx5IHNlbmQgY2FwYWJpbGl0aWVzIHRoZSBjbGllbnQgaGF2ZVxuICAgICAgICByZXF1aXJlc0JvdFN0YXRlOiB0cnVlLFxuICAgICAgICBzdXBwb3J0c0xpc3RlbmluZzogdHJ1ZSxcbiAgICAgICAgc3VwcG9ydHNUdHM6IHRydWUsXG4gICAgICAgIHR5cGU6ICdDbGllbnRDYXBhYmlsaXRpZXMnXG4gICAgICB9XG4gICAgXTtcbiAgfVxuXG4gIGNvbnN0IG1ldGEgPSB7IGNsaWVudEFjdGl2aXR5SUQsIG1ldGhvZCB9O1xuXG4gIHlpZWxkIHB1dCh7IHR5cGU6IFBPU1RfQUNUSVZJVFlfUEVORElORywgbWV0YSwgcGF5bG9hZDogeyBhY3Rpdml0eSB9IH0pO1xuXG4gIHRyeSB7XG4gICAgLy8gUXVpcmtzOiBXZSBtaWdodCByZWNlaXZlIElOQ09NSU5HX0FDVElWSVRZIGJlZm9yZSB0aGUgcG9zdEFjdGl2aXR5IGNhbGwgY29tcGxldGVkXG4gICAgLy8gICAgICAgICBTbywgd2Ugc2V0dXAgZXhwZWN0YXRpb24gZmlyc3QsIHRoZW4gcG9zdEFjdGl2aXR5IGFmdGVyd2FyZFxuXG4gICAgY29uc3QgZWNob0JhY2tDYWxsID0gY2FsbChmdW5jdGlvbiogKCkge1xuICAgICAgZm9yICg7Oykge1xuICAgICAgICBjb25zdCB7XG4gICAgICAgICAgcGF5bG9hZDogeyBhY3Rpdml0eSB9XG4gICAgICAgIH0gPSB5aWVsZCB0YWtlKElOQ09NSU5HX0FDVElWSVRZKTtcbiAgICAgICAgY29uc3QgeyBjaGFubmVsRGF0YSA9IHt9LCBpZCB9ID0gYWN0aXZpdHk7XG5cbiAgICAgICAgaWYgKGNoYW5uZWxEYXRhLmNsaWVudEFjdGl2aXR5SUQgPT09IGNsaWVudEFjdGl2aXR5SUQgJiYgaWQpIHtcbiAgICAgICAgICByZXR1cm4gYWN0aXZpdHk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vIFRpbWVvdXQgY291bGQgYmUgZHVlIHRvIGVpdGhlcjpcbiAgICAvLyAtIFBvc3QgYWN0aXZpdHkgY2FsbCBtYXkgdGFrZSB0b28gbG9uZyB0aW1lIHRvIGNvbXBsZXRlXG4gICAgLy8gICAtIERpcmVjdCBMaW5lIHNlcnZpY2Ugb25seSByZXNwb25kIG9uIEhUVFAgYWZ0ZXIgYm90IHJlc3BvbmQgdG8gRGlyZWN0IExpbmVcbiAgICAvLyAtIEFjdGl2aXR5IG1heSB0YWtlIHRvbyBsb25nIHRpbWUgdG8gZWNobyBiYWNrXG5cbiAgICBjb25zdCBzZW5kVGltZW91dCA9IHlpZWxkIHNlbGVjdChzZW5kVGltZW91dFNlbGVjdG9yKTtcblxuICAgIGNvbnN0IHtcbiAgICAgIHNlbmQ6IHsgZWNob0JhY2sgfVxuICAgIH0gPSB5aWVsZCByYWNlKHtcbiAgICAgIHNlbmQ6IGFsbCh7XG4gICAgICAgIGVjaG9CYWNrOiBlY2hvQmFja0NhbGwsXG4gICAgICAgIHBvc3RBY3Rpdml0eTogb2JzZXJ2ZU9uY2UoZGlyZWN0TGluZS5wb3N0QWN0aXZpdHkoYWN0aXZpdHkpKVxuICAgICAgfSksXG4gICAgICB0aW1lb3V0OiBjYWxsKCgpID0+IHNsZWVwKHNlbmRUaW1lb3V0KS50aGVuKCgpID0+IFByb21pc2UucmVqZWN0KG5ldyBFcnJvcigndGltZW91dCcpKSkpXG4gICAgfSk7XG5cbiAgICB5aWVsZCBwdXQoeyB0eXBlOiBQT1NUX0FDVElWSVRZX0ZVTEZJTExFRCwgbWV0YSwgcGF5bG9hZDogeyBhY3Rpdml0eTogZWNob0JhY2sgfSB9KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgY29uc29sZS5lcnJvcignYm90ZnJhbWV3b3JrLXdlYmNoYXQ6IEZhaWxlZCB0byBwb3N0IGFjdGl2aXR5IHRvIGNoYXQgYWRhcHRlci4nLCBlcnIpO1xuXG4gICAgeWllbGQgcHV0KHsgdHlwZTogUE9TVF9BQ1RJVklUWV9SRUpFQ1RFRCwgZXJyb3I6IHRydWUsIG1ldGEsIHBheWxvYWQ6IGVyciB9KTtcbiAgfSBmaW5hbGx5IHtcbiAgICBpZiAoeWllbGQgY2FuY2VsbGVkKCkpIHtcbiAgICAgIHlpZWxkIHB1dCh7IHR5cGU6IFBPU1RfQUNUSVZJVFlfUkVKRUNURUQsIGVycm9yOiB0cnVlLCBtZXRhLCBwYXlsb2FkOiBuZXcgRXJyb3IoJ2NhbmNlbGxlZCcpIH0pO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiogcG9zdEFjdGl2aXR5U2FnYSgpIHtcbiAgeWllbGQgd2hpbGVDb25uZWN0ZWQoZnVuY3Rpb24qIHBvc3RBY3Rpdml0eVdoaWxlQ29ubmVjdGVkKHsgZGlyZWN0TGluZSwgdXNlcklELCB1c2VybmFtZSB9KSB7XG4gICAgbGV0IG51bUFjdGl2aXRpZXNQb3N0ZWQgPSAwO1xuXG4gICAgeWllbGQgdGFrZUV2ZXJ5KFBPU1RfQUNUSVZJVFksIGZ1bmN0aW9uKiBwb3N0QWN0aXZpdHlXcmFwcGVyKGFjdGlvbikge1xuICAgICAgeWllbGQqIHBvc3RBY3Rpdml0eShkaXJlY3RMaW5lLCB1c2VySUQsIHVzZXJuYW1lLCBudW1BY3Rpdml0aWVzUG9zdGVkKyssIGFjdGlvbik7XG4gICAgfSk7XG4gIH0pO1xufVxuIl19