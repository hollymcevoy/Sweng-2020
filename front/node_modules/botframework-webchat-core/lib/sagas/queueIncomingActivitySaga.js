"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _typeof = require("@babel/runtime/helpers/typeof");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = queueIncomingActivitySaga;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _effects = require("redux-saga/effects");

var _queueIncomingActivity = require("../actions/queueIncomingActivity");

var _activities = _interopRequireWildcard(require("../selectors/activities"));

var _activityFromBot = _interopRequireDefault(require("../definitions/activityFromBot"));

var _incomingActivity = _interopRequireWildcard(require("../actions/incomingActivity"));

var _setSuggestedActions = _interopRequireDefault(require("../actions/setSuggestedActions"));

var _sleep = _interopRequireDefault(require("../utils/sleep"));

var _whileConnected = _interopRequireDefault(require("./effects/whileConnected"));

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || _typeof(obj) !== "object" && typeof obj !== "function") { return { "default": obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj["default"] = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

var _marked = /*#__PURE__*/_regenerator["default"].mark(takeEveryAndSelect),
    _marked2 = /*#__PURE__*/_regenerator["default"].mark(waitForActivityId),
    _marked3 = /*#__PURE__*/_regenerator["default"].mark(queueIncomingActivity),
    _marked4 = /*#__PURE__*/_regenerator["default"].mark(queueIncomingActivitySaga);

// We will hold up the replying activity if the originating activity did not arrive, up to 5 seconds.
var REPLY_TIMEOUT = 5000;

function takeEveryAndSelect(actionType, selector, fn) {
  var action, state;
  return _regenerator["default"].wrap(function takeEveryAndSelect$(_context) {
    while (1) {
      switch (_context.prev = _context.next) {
        case 0:
          _context.next = 2;
          return (0, _effects.cancelled)();

        case 2:
          if (_context.sent) {
            _context.next = 13;
            break;
          }

          _context.next = 5;
          return (0, _effects.take)(actionType);

        case 5:
          action = _context.sent;
          _context.next = 8;
          return (0, _effects.select)(selector);

        case 8:
          state = _context.sent;
          _context.next = 11;
          return (0, _effects.fork)(fn, action, state);

        case 11:
          _context.next = 0;
          break;

        case 13:
        case "end":
          return _context.stop();
      }
    }
  }, _marked);
} // Wait for specific activity to arrive in the transcript.
// We will use the initial set of activities to close time gaps between select() and take().
// If another activity with the same "replyToId" is already rendered (in the "activities" array),
// we will skip the wait as we already waited long enough for the missing activity to show up.


function waitForActivityId(replyToId, initialActivities) {
  var activities, replied, _yield$take, activity;

  return _regenerator["default"].wrap(function waitForActivityId$(_context2) {
    while (1) {
      switch (_context2.prev = _context2.next) {
        case 0:
          activities = initialActivities;

        case 1:
          replied = activities.find(function (activity) {
            return activity.id === replyToId || activity.replyToId === replyToId;
          });

          if (!replied) {
            _context2.next = 4;
            break;
          }

          return _context2.abrupt("break", 15);

        case 4:
          _context2.next = 6;
          return (0, _effects.take)(_incomingActivity.INCOMING_ACTIVITY);

        case 6:
          _yield$take = _context2.sent;
          activity = _yield$take.payload.activity;

          if (!(activity.id === replyToId)) {
            _context2.next = 10;
            break;
          }

          return _context2.abrupt("break", 15);

        case 10:
          _context2.next = 12;
          return (0, _effects.select)(_activities["default"]);

        case 12:
          activities = _context2.sent;

        case 13:
          _context2.next = 1;
          break;

        case 15:
        case "end":
          return _context2.stop();
      }
    }
  }, _marked2);
}

function queueIncomingActivity(_ref) {
  var userID;
  return _regenerator["default"].wrap(function queueIncomingActivity$(_context4) {
    while (1) {
      switch (_context4.prev = _context4.next) {
        case 0:
          userID = _ref.userID;
          _context4.next = 3;
          return takeEveryAndSelect(_queueIncomingActivity.QUEUE_INCOMING_ACTIVITY, _activities["default"], /*#__PURE__*/_regenerator["default"].mark(function queueIncomingActivity(_ref2, initialActivities) {
            var activity, replyToId, initialBotActivities, result, messageActivities, lastMessageActivity, _lastMessageActivity$, actions, to;

            return _regenerator["default"].wrap(function queueIncomingActivity$(_context3) {
              while (1) {
                switch (_context3.prev = _context3.next) {
                  case 0:
                    activity = _ref2.payload.activity;
                    // This is for resolving an accessibility issue.
                    // If the incoming activity has "replyToId" field, hold on it until the activity replied to is in the transcript, then release this one.
                    replyToId = activity.replyToId;
                    initialBotActivities = initialActivities.filter(function (_ref3) {
                      var role = _ref3.from.role;
                      return role === 'bot';
                    }); // To speed up the first activity render time, we do not delay the first activity from the bot.
                    // Even if it is the first activity from the bot, the bot might be "replying" to the "conversationUpdate" event.
                    // Thus, the "replyToId" will always be there even it is the first activity in the conversation.

                    if (!(replyToId && initialBotActivities.length)) {
                      _context3.next = 8;
                      break;
                    }

                    _context3.next = 6;
                    return (0, _effects.race)({
                      _: waitForActivityId(replyToId, initialActivities),
                      timeout: (0, _effects.call)(_sleep["default"], REPLY_TIMEOUT)
                    });

                  case 6:
                    result = _context3.sent;

                    if ('timeout' in result) {
                      console.warn("botframework-webchat: Timed out while waiting for activity \"".concat(replyToId, "\" which activity \"").concat(activity.id, "\" is replying to."), {
                        activity: activity,
                        replyToId: replyToId
                      });
                    }

                  case 8:
                    _context3.next = 10;
                    return (0, _effects.put)((0, _incomingActivity["default"])(activity));

                  case 10:
                    _context3.next = 12;
                    return (0, _effects.select)((0, _activities.ofType)('message'));

                  case 12:
                    messageActivities = _context3.sent;
                    lastMessageActivity = messageActivities[messageActivities.length - 1];

                    if (!(0, _activityFromBot["default"])(lastMessageActivity)) {
                      _context3.next = 20;
                      break;
                    }

                    _lastMessageActivity$ = lastMessageActivity.suggestedActions;
                    _lastMessageActivity$ = _lastMessageActivity$ === void 0 ? {} : _lastMessageActivity$;
                    actions = _lastMessageActivity$.actions, to = _lastMessageActivity$.to; // If suggested actions is not destined to anyone, or is destined to the user, show it.
                    // In other words, if suggested actions is destined to someone else, don't show it.

                    _context3.next = 20;
                    return (0, _effects.put)((0, _setSuggestedActions["default"])(to && to.length && !to.includes(userID) ? null : actions));

                  case 20:
                  case "end":
                    return _context3.stop();
                }
              }
            }, queueIncomingActivity);
          }));

        case 3:
        case "end":
          return _context4.stop();
      }
    }
  }, _marked3);
}

function queueIncomingActivitySaga() {
  return _regenerator["default"].wrap(function queueIncomingActivitySaga$(_context5) {
    while (1) {
      switch (_context5.prev = _context5.next) {
        case 0:
          _context5.next = 2;
          return (0, _whileConnected["default"])(queueIncomingActivity);

        case 2:
        case "end":
          return _context5.stop();
      }
    }
  }, _marked4);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zYWdhcy9xdWV1ZUluY29taW5nQWN0aXZpdHlTYWdhLmpzIl0sIm5hbWVzIjpbInRha2VFdmVyeUFuZFNlbGVjdCIsIndhaXRGb3JBY3Rpdml0eUlkIiwicXVldWVJbmNvbWluZ0FjdGl2aXR5IiwicXVldWVJbmNvbWluZ0FjdGl2aXR5U2FnYSIsIlJFUExZX1RJTUVPVVQiLCJhY3Rpb25UeXBlIiwic2VsZWN0b3IiLCJmbiIsImFjdGlvbiIsInN0YXRlIiwicmVwbHlUb0lkIiwiaW5pdGlhbEFjdGl2aXRpZXMiLCJhY3Rpdml0aWVzIiwicmVwbGllZCIsImZpbmQiLCJhY3Rpdml0eSIsImlkIiwiSU5DT01JTkdfQUNUSVZJVFkiLCJwYXlsb2FkIiwiYWN0aXZpdGllc1NlbGVjdG9yIiwidXNlcklEIiwiUVVFVUVfSU5DT01JTkdfQUNUSVZJVFkiLCJpbml0aWFsQm90QWN0aXZpdGllcyIsImZpbHRlciIsInJvbGUiLCJmcm9tIiwibGVuZ3RoIiwiXyIsInRpbWVvdXQiLCJzbGVlcCIsInJlc3VsdCIsImNvbnNvbGUiLCJ3YXJuIiwibWVzc2FnZUFjdGl2aXRpZXMiLCJsYXN0TWVzc2FnZUFjdGl2aXR5Iiwic3VnZ2VzdGVkQWN0aW9ucyIsImFjdGlvbnMiLCJ0byIsImluY2x1ZGVzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozt3REFLVUEsa0I7eURBZ0JBQyxpQjt5REFzQkFDLHFCO3lEQWlEZUMseUI7O0FBMUZ6QjtBQUNBLElBQU1DLGFBQWEsR0FBRyxJQUF0Qjs7QUFFQSxTQUFVSixrQkFBVixDQUE2QkssVUFBN0IsRUFBeUNDLFFBQXpDLEVBQW1EQyxFQUFuRDtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUlXLGlCQUFNLHlCQUFOOztBQUpYO0FBQUE7QUFBQTtBQUFBO0FBQUE7O0FBQUE7QUFLbUIsaUJBQU0sbUJBQUtG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QUFBLG1CQWhDUixHQWdDOEJELGlCQUFpQixDQUFDQSxpQkFBaUIsQ0FBQ1AsTUFBbEIsR0FBMkIsQ0FBNUIsQ0FoQy9DOztBQUFBLHlCQWtDTSxpQ0FBZ0JRLG1CQUFoQixDQWxDTjtBQUFBO0FBQUE7QUFBQTs7QUFBQSw0Q0FtQ3VEQSxtQkFuQ3ZELENBbUNZQyxnQkFuQ1o7QUFtQ0ksK0VBQTRDLEVBQTVDO0FBQTRCQyxvQkFBQUEsT0FuQ2hDLHlCQW1DZ0NBLE9BbkNoQyxFQW1DeUNDLEVBbkN6Qyx5QkFtQ3lDQSxFQW5DekMsRUFxQ0k7QUFDQTs7QUF0Q0o7QUF1Q0ksMkJBQU0sa0JBQUkscUNBQW9CQSxFQUFFLElBQUlBLEVBQUUsQ0FBQ1gsTUFBVCxJQUFtQixDQUFDVyxFQUFFLENBQUNDLFFBQUgsQ0FBWWxCLE1BQVosQ0FBcEIsR0FBMEMsSUFBMUMsR0FBaURnQixPQUFyRSxDQUFKLENBQU47O0FBdkNKO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQSxlQUFVbEMscUJBQVY7QUFBQSxXQUhzQixFQUF4Qjs7QUFERjtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTs7QUFpRGUsU0FBVUMseUJBQVY7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQ2IsaUJBQU0sZ0NBQWVELHFCQUFmLENBQU47O0FBRGE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUEiLCJzb3VyY2VSb290IjoiY29yZTovLy8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBjYWxsLCBjYW5jZWxsZWQsIGZvcmssIHB1dCwgcmFjZSwgc2VsZWN0LCB0YWtlIH0gZnJvbSAncmVkdXgtc2FnYS9lZmZlY3RzJztcblxuaW1wb3J0IHsgUVVFVUVfSU5DT01JTkdfQUNUSVZJVFkgfSBmcm9tICcuLi9hY3Rpb25zL3F1ZXVlSW5jb21pbmdBY3Rpdml0eSc7XG5pbXBvcnQgYWN0aXZpdGllc1NlbGVjdG9yLCB7IG9mVHlwZSBhcyBhY3Rpdml0aWVzT2ZUeXBlIH0gZnJvbSAnLi4vc2VsZWN0b3JzL2FjdGl2aXRpZXMnO1xuaW1wb3J0IGFjdGl2aXR5RnJvbUJvdCBmcm9tICcuLi9kZWZpbml0aW9ucy9hY3Rpdml0eUZyb21Cb3QnO1xuaW1wb3J0IGluY29taW5nQWN0aXZpdHksIHsgSU5DT01JTkdfQUNUSVZJVFkgfSBmcm9tICcuLi9hY3Rpb25zL2luY29taW5nQWN0aXZpdHknO1xuaW1wb3J0IHNldFN1Z2dlc3RlZEFjdGlvbnMgZnJvbSAnLi4vYWN0aW9ucy9zZXRTdWdnZXN0ZWRBY3Rpb25zJztcbmltcG9ydCBzbGVlcCBmcm9tICcuLi91dGlscy9zbGVlcCc7XG5pbXBvcnQgd2hpbGVDb25uZWN0ZWQgZnJvbSAnLi9lZmZlY3RzL3doaWxlQ29ubmVjdGVkJztcblxuLy8gV2Ugd2lsbCBob2xkIHVwIHRoZSByZXBseWluZyBhY3Rpdml0eSBpZiB0aGUgb3JpZ2luYXRpbmcgYWN0aXZpdHkgZGlkIG5vdCBhcnJpdmUsIHVwIHRvIDUgc2Vjb25kcy5cbmNvbnN0IFJFUExZX1RJTUVPVVQgPSA1MDAwO1xuXG5mdW5jdGlvbiogdGFrZUV2ZXJ5QW5kU2VsZWN0KGFjdGlvblR5cGUsIHNlbGVjdG9yLCBmbikge1xuICAvLyBzZWxlY3QoKSB3aWxsIGZyZWUgdXAgdGhlIGNvZGUgZXhlY3V0aW9uLlxuICAvLyBJZiB3ZSBwYWlyIHVwIHdpdGggdGFrZUV2ZXJ5KCksIGl0IHdpbGwgYWxsb3cgYWN0aW9ucyB0byBzbGlwIHRocm91Z2guXG4gIC8vIFRodXMsIHdlIGFyZSB3cml0aW5nIG9uZSB0aGF0IGRvbid0IHVzZSB0YWtlRXZlcnkoKS5cbiAgd2hpbGUgKCEoeWllbGQgY2FuY2VsbGVkKCkpKSB7XG4gICAgY29uc3QgYWN0aW9uID0geWllbGQgdGFrZShhY3Rpb25UeXBlKTtcbiAgICBjb25zdCBzdGF0ZSA9IHlpZWxkIHNlbGVjdChzZWxlY3Rvcik7XG5cbiAgICB5aWVsZCBmb3JrKGZuLCBhY3Rpb24sIHN0YXRlKTtcbiAgfVxufVxuXG4vLyBXYWl0IGZvciBzcGVjaWZpYyBhY3Rpdml0eSB0byBhcnJpdmUgaW4gdGhlIHRyYW5zY3JpcHQuXG4vLyBXZSB3aWxsIHVzZSB0aGUgaW5pdGlhbCBzZXQgb2YgYWN0aXZpdGllcyB0byBjbG9zZSB0aW1lIGdhcHMgYmV0d2VlbiBzZWxlY3QoKSBhbmQgdGFrZSgpLlxuLy8gSWYgYW5vdGhlciBhY3Rpdml0eSB3aXRoIHRoZSBzYW1lIFwicmVwbHlUb0lkXCIgaXMgYWxyZWFkeSByZW5kZXJlZCAoaW4gdGhlIFwiYWN0aXZpdGllc1wiIGFycmF5KSxcbi8vIHdlIHdpbGwgc2tpcCB0aGUgd2FpdCBhcyB3ZSBhbHJlYWR5IHdhaXRlZCBsb25nIGVub3VnaCBmb3IgdGhlIG1pc3NpbmcgYWN0aXZpdHkgdG8gc2hvdyB1cC5cbmZ1bmN0aW9uKiB3YWl0Rm9yQWN0aXZpdHlJZChyZXBseVRvSWQsIGluaXRpYWxBY3Rpdml0aWVzKSB7XG4gIGxldCBhY3Rpdml0aWVzID0gaW5pdGlhbEFjdGl2aXRpZXM7XG5cbiAgZm9yICg7Oykge1xuICAgIGNvbnN0IHJlcGxpZWQgPSBhY3Rpdml0aWVzLmZpbmQoYWN0aXZpdHkgPT4gYWN0aXZpdHkuaWQgPT09IHJlcGx5VG9JZCB8fCBhY3Rpdml0eS5yZXBseVRvSWQgPT09IHJlcGx5VG9JZCk7XG5cbiAgICBpZiAocmVwbGllZCkge1xuICAgICAgYnJlYWs7XG4gICAgfVxuXG4gICAgY29uc3Qge1xuICAgICAgcGF5bG9hZDogeyBhY3Rpdml0eSB9XG4gICAgfSA9IHlpZWxkIHRha2UoSU5DT01JTkdfQUNUSVZJVFkpO1xuXG4gICAgaWYgKGFjdGl2aXR5LmlkID09PSByZXBseVRvSWQpIHtcbiAgICAgIGJyZWFrO1xuICAgIH1cblxuICAgIGFjdGl2aXRpZXMgPSB5aWVsZCBzZWxlY3QoYWN0aXZpdGllc1NlbGVjdG9yKTtcbiAgfVxufVxuXG5mdW5jdGlvbiogcXVldWVJbmNvbWluZ0FjdGl2aXR5KHsgdXNlcklEIH0pIHtcbiAgeWllbGQgdGFrZUV2ZXJ5QW5kU2VsZWN0KFxuICAgIFFVRVVFX0lOQ09NSU5HX0FDVElWSVRZLFxuICAgIGFjdGl2aXRpZXNTZWxlY3RvcixcbiAgICBmdW5jdGlvbiogcXVldWVJbmNvbWluZ0FjdGl2aXR5KHsgcGF5bG9hZDogeyBhY3Rpdml0eSB9IH0sIGluaXRpYWxBY3Rpdml0aWVzKSB7XG4gICAgICAvLyBUaGlzIGlzIGZvciByZXNvbHZpbmcgYW4gYWNjZXNzaWJpbGl0eSBpc3N1ZS5cbiAgICAgIC8vIElmIHRoZSBpbmNvbWluZyBhY3Rpdml0eSBoYXMgXCJyZXBseVRvSWRcIiBmaWVsZCwgaG9sZCBvbiBpdCB1bnRpbCB0aGUgYWN0aXZpdHkgcmVwbGllZCB0byBpcyBpbiB0aGUgdHJhbnNjcmlwdCwgdGhlbiByZWxlYXNlIHRoaXMgb25lLlxuICAgICAgY29uc3QgeyByZXBseVRvSWQgfSA9IGFjdGl2aXR5O1xuICAgICAgY29uc3QgaW5pdGlhbEJvdEFjdGl2aXRpZXMgPSBpbml0aWFsQWN0aXZpdGllcy5maWx0ZXIoKHsgZnJvbTogeyByb2xlIH0gfSkgPT4gcm9sZSA9PT0gJ2JvdCcpO1xuXG4gICAgICAvLyBUbyBzcGVlZCB1cCB0aGUgZmlyc3QgYWN0aXZpdHkgcmVuZGVyIHRpbWUsIHdlIGRvIG5vdCBkZWxheSB0aGUgZmlyc3QgYWN0aXZpdHkgZnJvbSB0aGUgYm90LlxuICAgICAgLy8gRXZlbiBpZiBpdCBpcyB0aGUgZmlyc3QgYWN0aXZpdHkgZnJvbSB0aGUgYm90LCB0aGUgYm90IG1pZ2h0IGJlIFwicmVwbHlpbmdcIiB0byB0aGUgXCJjb252ZXJzYXRpb25VcGRhdGVcIiBldmVudC5cbiAgICAgIC8vIFRodXMsIHRoZSBcInJlcGx5VG9JZFwiIHdpbGwgYWx3YXlzIGJlIHRoZXJlIGV2ZW4gaXQgaXMgdGhlIGZpcnN0IGFjdGl2aXR5IGluIHRoZSBjb252ZXJzYXRpb24uXG4gICAgICBpZiAocmVwbHlUb0lkICYmIGluaXRpYWxCb3RBY3Rpdml0aWVzLmxlbmd0aCkge1xuICAgICAgICAvLyBFaXRoZXIgdGhlIGFjdGl2aXR5IHJlcGxpZWQgdG8gaXMgaW4gdGhlIHRyYW5zY3JpcHQgb3IgYWZ0ZXIgdGltZW91dC5cbiAgICAgICAgY29uc3QgcmVzdWx0ID0geWllbGQgcmFjZSh7XG4gICAgICAgICAgXzogd2FpdEZvckFjdGl2aXR5SWQocmVwbHlUb0lkLCBpbml0aWFsQWN0aXZpdGllcyksXG4gICAgICAgICAgdGltZW91dDogY2FsbChzbGVlcCwgUkVQTFlfVElNRU9VVClcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKCd0aW1lb3V0JyBpbiByZXN1bHQpIHtcbiAgICAgICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgICAgICBgYm90ZnJhbWV3b3JrLXdlYmNoYXQ6IFRpbWVkIG91dCB3aGlsZSB3YWl0aW5nIGZvciBhY3Rpdml0eSBcIiR7cmVwbHlUb0lkfVwiIHdoaWNoIGFjdGl2aXR5IFwiJHthY3Rpdml0eS5pZH1cIiBpcyByZXBseWluZyB0by5gLFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBhY3Rpdml0eSxcbiAgICAgICAgICAgICAgcmVwbHlUb0lkXG4gICAgICAgICAgICB9XG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICB5aWVsZCBwdXQoaW5jb21pbmdBY3Rpdml0eShhY3Rpdml0eSkpO1xuXG4gICAgICAvLyBVcGRhdGUgc3VnZ2VzdGVkIGFjdGlvbnNcbiAgICAgIC8vIFRPRE86IFtQM10gV2UgY291bGQgcHV0IHRoaXMgbG9naWMgaW5zaWRlIHJlZHVjZXIgdG8gbWluaW1pemUgbnVtYmVyIG9mIGFjdGlvbnMgZGlzcGF0Y2hlZC5cbiAgICAgIGNvbnN0IG1lc3NhZ2VBY3Rpdml0aWVzID0geWllbGQgc2VsZWN0KGFjdGl2aXRpZXNPZlR5cGUoJ21lc3NhZ2UnKSk7XG4gICAgICBjb25zdCBsYXN0TWVzc2FnZUFjdGl2aXR5ID0gbWVzc2FnZUFjdGl2aXRpZXNbbWVzc2FnZUFjdGl2aXRpZXMubGVuZ3RoIC0gMV07XG5cbiAgICAgIGlmIChhY3Rpdml0eUZyb21Cb3QobGFzdE1lc3NhZ2VBY3Rpdml0eSkpIHtcbiAgICAgICAgY29uc3QgeyBzdWdnZXN0ZWRBY3Rpb25zOiB7IGFjdGlvbnMsIHRvIH0gPSB7fSB9ID0gbGFzdE1lc3NhZ2VBY3Rpdml0eTtcblxuICAgICAgICAvLyBJZiBzdWdnZXN0ZWQgYWN0aW9ucyBpcyBub3QgZGVzdGluZWQgdG8gYW55b25lLCBvciBpcyBkZXN0aW5lZCB0byB0aGUgdXNlciwgc2hvdyBpdC5cbiAgICAgICAgLy8gSW4gb3RoZXIgd29yZHMsIGlmIHN1Z2dlc3RlZCBhY3Rpb25zIGlzIGRlc3RpbmVkIHRvIHNvbWVvbmUgZWxzZSwgZG9uJ3Qgc2hvdyBpdC5cbiAgICAgICAgeWllbGQgcHV0KHNldFN1Z2dlc3RlZEFjdGlvbnModG8gJiYgdG8ubGVuZ3RoICYmICF0by5pbmNsdWRlcyh1c2VySUQpID8gbnVsbCA6IGFjdGlvbnMpKTtcbiAgICAgIH1cbiAgICB9XG4gICk7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uKiBxdWV1ZUluY29taW5nQWN0aXZpdHlTYWdhKCkge1xuICB5aWVsZCB3aGlsZUNvbm5lY3RlZChxdWV1ZUluY29taW5nQWN0aXZpdHkpO1xufVxuIl19