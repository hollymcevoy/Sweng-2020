"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = render;

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _markdownItForInline = _interopRequireDefault(require("markdown-it-for-inline"));

var _markdownIt = _interopRequireDefault(require("markdown-it"));

var _markdownItAttrsEs = _interopRequireDefault(require("markdown-it-attrs-es5"));

var _sanitizeHtml = _interopRequireDefault(require("sanitize-html"));

/* eslint no-magic-numbers: ["error", { "ignore": [0, 1, 2] }] */
var SANITIZE_HTML_OPTIONS = {
  allowedAttributes: {
    a: ['aria-label', 'href', 'name', 'rel', 'target', 'title'],
    img: ['alt', 'class', 'src']
  },
  allowedSchemes: ['data', 'http', 'https', 'ftp', 'mailto', 'sip', 'tel'],
  allowedTags: ['a', 'b', 'blockquote', 'br', 'caption', 'code', 'del', 'div', 'em', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'hr', 'i', 'img', 'ins', 'li', 'nl', 'ol', 'p', 'pre', 's', 'span', 'strike', 'strong', 'table', 'tbody', 'td', 'tfoot', 'th', 'thead', 'tr', 'ul']
}; // Put a transparent pixel instead of the "open in new window" icon, so developers can easily modify the icon in CSS.

var TRANSPARENT_GIF = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; // This is used for parsing Markdown for external links.

var internalMarkdownIt = new _markdownIt.default();
var MARKDOWN_ATTRS_LEFT_DELIMITER = '⟬'; // Make sure the delimiter is free from any RegExp characters, such as *, ?, etc.
// IE11 does not support "u" flag and Babel could not remove it. We intentionally omitting the "u" flag here.
// eslint-disable-next-line security/detect-non-literal-regexp, require-unicode-regexp

var MARKDOWN_ATTRS_LEFT_DELIMITER_PATTERN = new RegExp(MARKDOWN_ATTRS_LEFT_DELIMITER, 'g');
var MARKDOWN_ATTRS_RIGHT_DELIMITER = '⟭'; // Make sure the delimiter is free from any RegExp characters, such as *, ?, etc.
// IE11 does not support "u" flag and Babel could not remove it. We intentionally omitting the "u" flag here.
// eslint-disable-next-line security/detect-non-literal-regexp, require-unicode-regexp

var MARKDOWN_ATTRS_RIGHT_DELIMITER_PATTERN = new RegExp(MARKDOWN_ATTRS_RIGHT_DELIMITER, 'g');

function render(markdown, _ref) {
  var markdownRespectCRLF = _ref.markdownRespectCRLF;

  var _ref2 = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {},
      _ref2$externalLinkAlt = _ref2.externalLinkAlt,
      externalLinkAlt = _ref2$externalLinkAlt === void 0 ? '' : _ref2$externalLinkAlt;

  if (markdownRespectCRLF) {
    markdown = markdown.replace(/\n\r|\r\n/g, function (carriageReturn) {
      return carriageReturn === '\n\r' ? '\r\n' : '\n\r';
    });
  } // Related to #3165.
  // We only support attributes "aria-label" and should leave other attributes as-is.
  // However, `markdown-it-attrs` remove unrecognized attributes, such as {hello}.
  // Before passing to `markdown-it-attrs`, we will convert known attributes from {aria-label="..."} into ⟬aria-label="..."⟭ (using white tortoise shell brackets).
  // Then, we ask `markdown-it-attrs` to only process the new brackets, so it should only try to process things that we allowlisted.
  // Lastly, we revert tortoise shell brackets back to curly brackets, for unprocessed attributes.


  markdown = markdown.replace(/\{[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]*aria\x2Dlabel()[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]*\}/gi, "".concat(MARKDOWN_ATTRS_LEFT_DELIMITER, "aria-label").concat(MARKDOWN_ATTRS_RIGHT_DELIMITER)).replace(/\{[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]*aria\x2Dlabel=("(?:(?!")[\s\S])*"|(?:(?![\t-\r \}\xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF])[\s\S])*)[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]*\}/gi, function (_, valueInsideQuotes) {
    return "".concat(MARKDOWN_ATTRS_LEFT_DELIMITER, "aria-label=").concat(valueInsideQuotes).concat(MARKDOWN_ATTRS_RIGHT_DELIMITER);
  });
  var html = new _markdownIt.default({
    breaks: false,
    html: false,
    linkify: true,
    typographer: true,
    xhtmlOut: true
  }).use(_markdownItAttrsEs.default, {
    // `markdown-it-attrs` is added for accessibility and allow bot developers to specify `aria-label`.
    // We are allowlisting `aria-label` only as it is allowlisted in `sanitize-html`.
    // Other `aria-*` will be sanitized even we allowlisted here.
    allowedAttributes: ['aria-label'],
    leftDelimiter: MARKDOWN_ATTRS_LEFT_DELIMITER,
    rightDelimiter: MARKDOWN_ATTRS_RIGHT_DELIMITER
  }).use(_markdownItForInline.default, 'url_new_win', 'link_open', function (tokens, index) {
    var token = tokens[+index];
    token.attrSet('rel', 'noopener noreferrer');
    token.attrSet('target', '_blank');
    var linkOpenToken = tokens.find(function (_ref3) {
      var type = _ref3.type;
      return type === 'link_open';
    });

    var _linkOpenToken$attrs$ = linkOpenToken.attrs.find(function (_ref4) {
      var _ref5 = (0, _slicedToArray2.default)(_ref4, 1),
          name = _ref5[0];

      return name === 'href';
    }),
        _linkOpenToken$attrs$2 = (0, _slicedToArray2.default)(_linkOpenToken$attrs$, 2),
        href = _linkOpenToken$attrs$2[1]; // Adds a new icon if the link is http: or https:.
    // Don't add if it's a phone number, etc.


    if (/^http[s\u017F]?:/i.test(href)) {
      externalLinkAlt && token.attrSet('title', externalLinkAlt);
      var iconTokens = internalMarkdownIt.parseInline("![".concat(externalLinkAlt, "](").concat(TRANSPARENT_GIF, ")"))[0].children;
      iconTokens[0].attrJoin('class', 'webchat__markdown__external-link-icon');
      tokens.splice.apply(tokens, [index + 2, 0].concat((0, _toConsumableArray2.default)(iconTokens)));
    }
  }).render(markdown); // Restore attributes not processed by `markdown-it-attrs`.
  // TODO: [P2] #2511 After we fixed our polyfill story, we should use "String.prototype.replaceAll" instead of RegExp for replace all occurrences.

  html = html.replace(MARKDOWN_ATTRS_LEFT_DELIMITER_PATTERN, '{').replace(MARKDOWN_ATTRS_RIGHT_DELIMITER_PATTERN, '}'); // The signature from "sanitize-html" module is not correct.
  // @ts-ignore

  return (0, _sanitizeHtml.default)(html, SANITIZE_HTML_OPTIONS);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9yZW5kZXJNYXJrZG93bi50cyJdLCJuYW1lcyI6WyJTQU5JVElaRV9IVE1MX09QVElPTlMiLCJhbGxvd2VkQXR0cmlidXRlcyIsImEiLCJpbWciLCJhbGxvd2VkU2NoZW1lcyIsImFsbG93ZWRUYWdzIiwiVFJBTlNQQVJFTlRfR0lGIiwiaW50ZXJuYWxNYXJrZG93bkl0IiwiTWFya2Rvd25JdCIsIk1BUktET1dOX0FUVFJTX0xFRlRfREVMSU1JVEVSIiwiTUFSS0RPV05fQVRUUlNfTEVGVF9ERUxJTUlURVJfUEFUVEVSTiIsIlJlZ0V4cCIsIk1BUktET1dOX0FUVFJTX1JJR0hUX0RFTElNSVRFUiIsIk1BUktET1dOX0FUVFJTX1JJR0hUX0RFTElNSVRFUl9QQVRURVJOIiwicmVuZGVyIiwibWFya2Rvd24iLCJtYXJrZG93blJlc3BlY3RDUkxGIiwiZXh0ZXJuYWxMaW5rQWx0IiwicmVwbGFjZSIsImNhcnJpYWdlUmV0dXJuIiwiXyIsInZhbHVlSW5zaWRlUXVvdGVzIiwiaHRtbCIsImJyZWFrcyIsImxpbmtpZnkiLCJ0eXBvZ3JhcGhlciIsInhodG1sT3V0IiwidXNlIiwibWFya2Rvd25JdEF0dHJzIiwibGVmdERlbGltaXRlciIsInJpZ2h0RGVsaW1pdGVyIiwiaXRlcmF0b3IiLCJ0b2tlbnMiLCJpbmRleCIsInRva2VuIiwiYXR0clNldCIsImxpbmtPcGVuVG9rZW4iLCJmaW5kIiwidHlwZSIsImF0dHJzIiwibmFtZSIsImhyZWYiLCJ0ZXN0IiwiaWNvblRva2VucyIsInBhcnNlSW5saW5lIiwiY2hpbGRyZW4iLCJhdHRySm9pbiIsInNwbGljZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUxBO0FBT0EsSUFBTUEscUJBQXFCLEdBQUc7QUFDNUJDLEVBQUFBLGlCQUFpQixFQUFFO0FBQ2pCQyxJQUFBQSxDQUFDLEVBQUUsQ0FBQyxZQUFELEVBQWUsTUFBZixFQUF1QixNQUF2QixFQUErQixL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Q1I3QixNQXBDUSxDQW9DREMsUUFwQ0MsQ0FBWCxDQW5CUSxDQXlEUjtBQUNBOztBQUNBTyxFQUFBQSxJQUFJLEdBQUdBLElBQUksQ0FBQ0osT0FBTCxDQUFhUixxQ0FBYixFQUFvRCxHQUFwRCxFQUF5RFEsT0FBekQsQ0FBaUVMLHNDQUFqRSxFQUF5RyxHQUF6RyxDQUFQLENBM0RRLENBNkRSO0FBQ0E7O0FBQ0EsU0FBTywyQkFBYVMsSUFBYixFQUFtQnRCLHFCQUFuQixDQUFQO0FBQ0QiLCJzb3VyY2VSb290IjoiYnVuZGxlOi8vLyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludCBuby1tYWdpYy1udW1iZXJzOiBbXCJlcnJvclwiLCB7IFwiaWdub3JlXCI6IFswLCAxLCAyXSB9XSAqL1xuXG5pbXBvcnQgaXRlcmF0b3IgZnJvbSAnbWFya2Rvd24taXQtZm9yLWlubGluZSc7XG5pbXBvcnQgTWFya2Rvd25JdCBmcm9tICdtYXJrZG93bi1pdCc7XG5pbXBvcnQgbWFya2Rvd25JdEF0dHJzIGZyb20gJ21hcmtkb3duLWl0LWF0dHJzLWVzNSc7XG5pbXBvcnQgc2FuaXRpemVIVE1MIGZyb20gJ3Nhbml0aXplLWh0bWwnO1xuXG5jb25zdCBTQU5JVElaRV9IVE1MX09QVElPTlMgPSB7XG4gIGFsbG93ZWRBdHRyaWJ1dGVzOiB7XG4gICAgYTogWydhcmlhLWxhYmVsJywgJ2hyZWYnLCAnbmFtZScsICdyZWwnLCAndGFyZ2V0JywgJ3RpdGxlJ10sXG4gICAgaW1nOiBbJ2FsdCcsICdjbGFzcycsICdzcmMnXVxuICB9LFxuICBhbGxvd2VkU2NoZW1lczogWydkYXRhJywgJ2h0dHAnLCAnaHR0cHMnLCAnZnRwJywgJ21haWx0bycsICdzaXAnLCAndGVsJ10sXG4gIGFsbG93ZWRUYWdzOiBbXG4gICAgJ2EnLFxuICAgICdiJyxcbiAgICAnYmxvY2txdW90ZScsXG4gICAgJ2JyJyxcbiAgICAnY2FwdGlvbicsXG4gICAgJ2NvZGUnLFxuICAgICdkZWwnLFxuICAgICdkaXYnLFxuICAgICdlbScsXG4gICAgJ2gxJyxcbiAgICAnaDInLFxuICAgICdoMycsXG4gICAgJ2g0JyxcbiAgICAnaDUnLFxuICAgICdoNicsXG4gICAgJ2hyJyxcbiAgICAnaScsXG4gICAgJ2ltZycsXG4gICAgJ2lucycsXG4gICAgJ2xpJyxcbiAgICAnbmwnLFxuICAgICdvbCcsXG4gICAgJ3AnLFxuICAgICdwcmUnLFxuICAgICdzJyxcbiAgICAnc3BhbicsXG4gICAgJ3N0cmlrZScsXG4gICAgJ3N0cm9uZycsXG4gICAgJ3RhYmxlJyxcbiAgICAndGJvZHknLFxuICAgICd0ZCcsXG4gICAgJ3Rmb290JyxcbiAgICAndGgnLFxuICAgICd0aGVhZCcsXG4gICAgJ3RyJyxcbiAgICAndWwnXG4gIF1cbn07XG5cbi8vIFB1dCBhIHRyYW5zcGFyZW50IHBpeGVsIGluc3RlYWQgb2YgdGhlIFwib3BlbiBpbiBuZXcgd2luZG93XCIgaWNvbiwgc28gZGV2ZWxvcGVycyBjYW4gZWFzaWx5IG1vZGlmeSB0aGUgaWNvbiBpbiBDU1MuXG5jb25zdCBUUkFOU1BBUkVOVF9HSUYgPSAnZGF0YTppbWFnZS9naWY7YmFzZTY0LFIwbEdPRGxoQVFBQkFJQUFBQUFBQVAvLy95SDVCQUVBQUFBQUxBQUFBQUFCQUFFQUFBSUJSQUE3JztcblxuLy8gVGhpcyBpcyB1c2VkIGZvciBwYXJzaW5nIE1hcmtkb3duIGZvciBleHRlcm5hbCBsaW5rcy5cbmNvbnN0IGludGVybmFsTWFya2Rvd25JdCA9IG5ldyBNYXJrZG93bkl0KCk7XG5cbmNvbnN0IE1BUktET1dOX0FUVFJTX0xFRlRfREVMSU1JVEVSID0gJ+KfrCc7XG4vLyBNYWtlIHN1cmUgdGhlIGRlbGltaXRlciBpcyBmcmVlIGZyb20gYW55IFJlZ0V4cCBjaGFyYWN0ZXJzLCBzdWNoIGFzICosID8sIGV0Yy5cbi8vIElFMTEgZG9lcyBub3Qgc3VwcG9ydCBcInVcIiBmbGFnIGFuZCBCYWJlbCBjb3VsZCBub3QgcmVtb3ZlIGl0LiBXZSBpbnRlbnRpb25hbGx5IG9taXR0aW5nIHRoZSBcInVcIiBmbGFnIGhlcmUuXG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgc2VjdXJpdHkvZGV0ZWN0LW5vbi1saXRlcmFsLXJlZ2V4cCwgcmVxdWlyZS11bmljb2RlLXJlZ2V4cFxuY29uc3QgTUFSS0RPV05fQVRUUlNfTEVGVF9ERUxJTUlURVJfUEFUVEVSTiA9IG5ldyBSZWdFeHAoTUFSS0RPV05fQVRUUlNfTEVGVF9ERUxJTUlURVIsICdnJyk7XG5cbmNvbnN0IE1BUktET1dOX0FUVFJTX1JJR0hUX0RFTElNSVRFUiA9ICfin60nO1xuLy8gTWFrZSBzdXJlIHRoZSBkZWxpbWl0ZXIgaXMgZnJlZSBmcm9tIGFueSBSZWdFeHAgY2hhcmFjdGVycywgc3VjaCBhcyAqLCA/LCBldGMuXG4vLyBJRTExIGRvZXMgbm90IHN1cHBvcnQgXCJ1XCIgZmxhZyBhbmQgQmFiZWwgY291bGQgbm90IHJlbW92ZSBpdC4gV2UgaW50ZW50aW9uYWxseSBvbWl0dGluZyB0aGUgXCJ1XCIgZmxhZyBoZXJlLlxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHNlY3VyaXR5L2RldGVjdC1ub24tbGl0ZXJhbC1yZWdleHAsIHJlcXVpcmUtdW5pY29kZS1yZWdleHBcbmNvbnN0IE1BUktET1dOX0FUVFJTX1JJR0hUX0RFTElNSVRFUl9QQVRURVJOID0gbmV3IFJlZ0V4cChNQVJLRE9XTl9BVFRSU19SSUdIVF9ERUxJTUlURVIsICdnJyk7XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIHJlbmRlcihcbiAgbWFya2Rvd246IHN0cmluZyxcbiAgeyBtYXJrZG93blJlc3BlY3RDUkxGIH06IHsgbWFya2Rvd25SZXNwZWN0Q1JMRjogYm9vbGVhbiB9LFxuICB7IGV4dGVybmFsTGlua0FsdCA9ICcnIH06IHsgZXh0ZXJuYWxMaW5rQWx0Pzogc3RyaW5nIH0gPSB7fVxuKTogc3RyaW5nIHtcbiAgaWYgKG1hcmtkb3duUmVzcGVjdENSTEYpIHtcbiAgICBtYXJrZG93biA9IG1hcmtkb3duLnJlcGxhY2UoL1xcblxccnxcXHJcXG4vZ3UsIGNhcnJpYWdlUmV0dXJuID0+IChjYXJyaWFnZVJldHVybiA9PT0gJ1xcblxccicgPyAnXFxyXFxuJyA6ICdcXG5cXHInKSk7XG4gIH1cblxuICAvLyBSZWxhdGVkIHRvICMzMTY1LlxuICAvLyBXZSBvbmx5IHN1cHBvcnQgYXR0cmlidXRlcyBcImFyaWEtbGFiZWxcIiBhbmQgc2hvdWxkIGxlYXZlIG90aGVyIGF0dHJpYnV0ZXMgYXMtaXMuXG4gIC8vIEhvd2V2ZXIsIGBtYXJrZG93bi1pdC1hdHRyc2AgcmVtb3ZlIHVucmVjb2duaXplZCBhdHRyaWJ1dGVzLCBzdWNoIGFzIHtoZWxsb30uXG4gIC8vIEJlZm9yZSBwYXNzaW5nIHRvIGBtYXJrZG93bi1pdC1hdHRyc2AsIHdlIHdpbGwgY29udmVydCBrbm93biBhdHRyaWJ1dGVzIGZyb20ge2FyaWEtbGFiZWw9XCIuLi5cIn0gaW50byDin6xhcmlhLWxhYmVsPVwiLi4uXCLin60gKHVzaW5nIHdoaXRlIHRvcnRvaXNlIHNoZWxsIGJyYWNrZXRzKS5cbiAgLy8gVGhlbiwgd2UgYXNrIGBtYXJrZG93bi1pdC1hdHRyc2AgdG8gb25seSBwcm9jZXNzIHRoZSBuZXcgYnJhY2tldHMsIHNvIGl0IHNob3VsZCBvbmx5IHRyeSB0byBwcm9jZXNzIHRoaW5ncyB0aGF0IHdlIGFsbG93bGlzdGVkLlxuICAvLyBMYXN0bHksIHdlIHJldmVydCB0b3J0b2lzZSBzaGVsbCBicmFja2V0cyBiYWNrIHRvIGN1cmx5IGJyYWNrZXRzLCBmb3IgdW5wcm9jZXNzZWQgYXR0cmlidXRlcy5cbiAgbWFya2Rvd24gPSBtYXJrZG93blxuICAgIC5yZXBsYWNlKC9cXHtcXHMqYXJpYS1sYWJlbCgpXFxzKlxcfS9naXUsIGAke01BUktET1dOX0FUVFJTX0xFRlRfREVMSU1JVEVSfWFyaWEtbGFiZWwke01BUktET1dOX0FUVFJTX1JJR0hUX0RFTElNSVRFUn1gKVxuICAgIC5yZXBsYWNlKFxuICAgICAgL1xce1xccyphcmlhLWxhYmVsPShcIlteXCJdKlwifFteXFxzfV0qKVxccypcXH0vZ2l1LFxuICAgICAgKF8sIHZhbHVlSW5zaWRlUXVvdGVzKSA9PlxuICAgICAgICBgJHtNQVJLRE9XTl9BVFRSU19MRUZUX0RFTElNSVRFUn1hcmlhLWxhYmVsPSR7dmFsdWVJbnNpZGVRdW90ZXN9JHtNQVJLRE9XTl9BVFRSU19SSUdIVF9ERUxJTUlURVJ9YFxuICAgICk7XG5cbiAgbGV0IGh0bWwgPSBuZXcgTWFya2Rvd25JdCh7XG4gICAgYnJlYWtzOiBmYWxzZSxcbiAgICBodG1sOiBmYWxzZSxcbiAgICBsaW5raWZ5OiB0cnVlLFxuICAgIHR5cG9ncmFwaGVyOiB0cnVlLFxuICAgIHhodG1sT3V0OiB0cnVlXG4gIH0pXG4gICAgLnVzZShtYXJrZG93bkl0QXR0cnMsIHtcbiAgICAgIC8vIGBtYXJrZG93bi1pdC1hdHRyc2AgaXMgYWRkZWQgZm9yIGFjY2Vzc2liaWxpdHkgYW5kIGFsbG93IGJvdCBkZXZlbG9wZXJzIHRvIHNwZWNpZnkgYGFyaWEtbGFiZWxgLlxuICAgICAgLy8gV2UgYXJlIGFsbG93bGlzdGluZyBgYXJpYS1sYWJlbGAgb25seSBhcyBpdCBpcyBhbGxvd2xpc3RlZCBpbiBgc2FuaXRpemUtaHRtbGAuXG4gICAgICAvLyBPdGhlciBgYXJpYS0qYCB3aWxsIGJlIHNhbml0aXplZCBldmVuIHdlIGFsbG93bGlzdGVkIGhlcmUuXG4gICAgICBhbGxvd2VkQXR0cmlidXRlczogWydhcmlhLWxhYmVsJ10sXG4gICAgICBsZWZ0RGVsaW1pdGVyOiBNQVJLRE9XTl9BVFRSU19MRUZUX0RFTElNSVRFUixcbiAgICAgIHJpZ2h0RGVsaW1pdGVyOiBNQVJLRE9XTl9BVFRSU19SSUdIVF9ERUxJTUlURVJcbiAgICB9KVxuICAgIC51c2UoaXRlcmF0b3IsICd1cmxfbmV3X3dpbicsICdsaW5rX29wZW4nLCAodG9rZW5zLCBpbmRleCkgPT4ge1xuICAgICAgY29uc3QgdG9rZW4gPSB0b2tlbnNbK2luZGV4XTtcblxuICAgICAgdG9rZW4uYXR0clNldCgncmVsJywgJ25vb3BlbmVyIG5vcmVmZXJyZXInKTtcbiAgICAgIHRva2VuLmF0dHJTZXQoJ3RhcmdldCcsICdfYmxhbmsnKTtcblxuICAgICAgY29uc3QgbGlua09wZW5Ub2tlbiA9IHRva2Vucy5maW5kKCh7IHR5cGUgfSkgPT4gdHlwZSA9PT0gJ2xpbmtfb3BlbicpO1xuICAgICAgY29uc3QgWywgaHJlZl0gPSBsaW5rT3BlblRva2VuLmF0dHJzLmZpbmQoKFtuYW1lXSkgPT4gbmFtZSA9PT0gJ2hyZWYnKTtcblxuICAgICAgLy8gQWRkcyBhIG5ldyBpY29uIGlmIHRoZSBsaW5rIGlzIGh0dHA6IG9yIGh0dHBzOi5cbiAgICAgIC8vIERvbid0IGFkZCBpZiBpdCdzIGEgcGhvbmUgbnVtYmVyLCBldGMuXG4gICAgICBpZiAoL15odHRwcz86L2l1LnRlc3QoaHJlZikpIHtcbiAgICAgICAgZXh0ZXJuYWxMaW5rQWx0ICYmIHRva2VuLmF0dHJTZXQoJ3RpdGxlJywgZXh0ZXJuYWxMaW5rQWx0KTtcblxuICAgICAgICBjb25zdCBpY29uVG9rZW5zID0gaW50ZXJuYWxNYXJrZG93bkl0LnBhcnNlSW5saW5lKGAhWyR7ZXh0ZXJuYWxMaW5rQWx0fV0oJHtUUkFOU1BBUkVOVF9HSUZ9KWApWzBdLmNoaWxkcmVuO1xuXG4gICAgICAgIGljb25Ub2tlbnNbMF0uYXR0ckpvaW4oJ2NsYXNzJywgJ3dlYmNoYXRfX21hcmtkb3duX19leHRlcm5hbC1saW5rLWljb24nKTtcblxuICAgICAgICB0b2tlbnMuc3BsaWNlKGluZGV4ICsgMiwgMCwgLi4uaWNvblRva2Vucyk7XG4gICAgICB9XG4gICAgfSlcbiAgICAucmVuZGVyKG1hcmtkb3duKTtcblxuICAvLyBSZXN0b3JlIGF0dHJpYnV0ZXMgbm90IHByb2Nlc3NlZCBieSBgbWFya2Rvd24taXQtYXR0cnNgLlxuICAvLyBUT0RPOiBbUDJdICMyNTExIEFmdGVyIHdlIGZpeGVkIG91ciBwb2x5ZmlsbCBzdG9yeSwgd2Ugc2hvdWxkIHVzZSBcIlN0cmluZy5wcm90b3R5cGUucmVwbGFjZUFsbFwiIGluc3RlYWQgb2YgUmVnRXhwIGZvciByZXBsYWNlIGFsbCBvY2N1cnJlbmNlcy5cbiAgaHRtbCA9IGh0bWwucmVwbGFjZShNQVJLRE9XTl9BVFRSU19MRUZUX0RFTElNSVRFUl9QQVRURVJOLCAneycpLnJlcGxhY2UoTUFSS0RPV05fQVRUUlNfUklHSFRfREVMSU1JVEVSX1BBVFRFUk4sICd9Jyk7XG5cbiAgLy8gVGhlIHNpZ25hdHVyZSBmcm9tIFwic2FuaXRpemUtaHRtbFwiIG1vZHVsZSBpcyBub3QgY29ycmVjdC5cbiAgLy8gQHRzLWlnbm9yZVxuICByZXR1cm4gc2FuaXRpemVIVE1MKGh0bWwsIFNBTklUSVpFX0hUTUxfT1BUSU9OUyk7XG59XG4iXX0=