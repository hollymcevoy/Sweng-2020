"use strict";

function _typeof(obj) { "@babel/helpers - typeof"; if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _propTypes = _interopRequireDefault(require("prop-types"));

var _react = _interopRequireWildcard(require("react"));

var _Context = _interopRequireDefault(require("./private/Context"));

var _getActivityId = _interopRequireDefault(require("./private/getActivityId"));

var _getClientActivityId = _interopRequireDefault(require("./private/getClientActivityId"));

var _uniqueId = _interopRequireDefault(require("./private/uniqueId"));

var _useActivities3 = _interopRequireDefault(require("../../hooks/useActivities"));

var _useContext = _interopRequireDefault(require("./private/useContext"));

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || _typeof(obj) !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _unsupportedIterableToArray(arr, i) || _nonIterableRest(); }

function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }

function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

function _iterableToArrayLimit(arr, i) { var _i = arr == null ? null : typeof Symbol !== "undefined" && arr[Symbol.iterator] || arr["@@iterator"]; if (_i == null) return; var _arr = []; var _n = true; var _d = false; var _s, _e; try { for (_i = _i.call(arr); !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"] != null) _i["return"](); } finally { if (_d) throw _e; } } return _arr; }

function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }

/**
 * React context composer component to assign a perma-key to every activity.
 * This will support both `useGetActivityByKey` and `useGetKeyByActivity` custom hooks.
 *
 * Today, `activity.id` is only guaranteed for activity from others.
 * Not all activities sent by the local user has `activity.id`.
 *
 * To track outgoing activities, we added `activity.channelData.clientActivityId`.
 *
 * This component will create a local key, which can be used to track both
 * incoming and outgoing activities in a consistent way.
 *
 * Local key are only persisted in memory. On refresh, they will be a new random key.
 */
var ActivityKeyerComposer = function ActivityKeyerComposer(_ref) {
  var children = _ref.children;
  var existingContext = (0, _useContext.default)(false);

  if (existingContext) {
    throw new Error('botframework-webchat internal: <ActivityKeyerComposer> should not be nested.');
  }

  var _useActivities = (0, _useActivities3.default)(),
      _useActivities2 = _slicedToArray(_useActivities, 1),
      activities = _useActivities2[0];

  var activityIdToKeyMapRef = (0, _react.useRef)(Object.freeze(new Map()));
  var activityToKeyMapRef = (0, _react.useRef)(Object.freeze(new Map()));
  var clientActivityIdToKeyMapRef = (0, _react.useRef)(Object.freeze(new Map()));
  var keyToActivityMapRef = (0, _react.useRef)(Object.freeze(new Map())); // TODO: [P1] `useMemoWithPrevious` to check and cache the resulting array if it hasn't changed.

  var activityKeysState = (0, _react.useMemo)(function () {
    var activityIdToKeyMap = activityIdToKeyMapRef.current;
    var activityToKeyMap = activityToKeyMapRef.current;
    var clientActivityIdToKeyMap = clientActivityIdToKeyMapRef.current;
    var nextActivityIdToKeyMap = new Map();
    var nextActivityKeys = [];
    var nextActivityToKeyMap = new Map();
    var nextClientActivityIdToKeyMap = new Map();
    var nextKeyToActivityMap = new Map();
    activities.forEach(function (activity) {
      var activityId = (0, _getActivityId.default)(activity);
      var clientActivityId = (0, _getClientActivityId.default)(activity);
      var key = clientActivityId && clientActivityIdToKeyMap.get(clientActivityId) || activityId && activityIdToKeyMap.get(activityId) || activityToKeyMap.get(activity) || (0, _uniqueId.default)();
      activityId && nextActivityIdToKeyMap.set(activityId, key);
      clientActivityId && nextClientActivityIdToKeyMap.set(clientActivityId, key);
      nextActivityToKeyMap.set(activity, key);
      nextKeyToActivityMap.set(key, activity);
      nextActivityKeys.push(key);
    });
    activityIdToKeyMapRef.current = Object.freeze(nextActivityIdToKeyMap);
    activityToKeyMapRef.current = Object.freeze(nextActivityToKeyMap);
    clientActivityIdToKeyMapRef.current = Object.freeze(nextClientActivityIdToKeyMap);
    keyToActivityMapRef.current = Object.freeze(nextKeyToActivityMap); // `nextActivityKeys` could potentially same as `prevActivityKeys` despite reference differences, we should memoize it.

    return Object.freeze([Object.freeze(nextActivityKeys)]);
  }, [activities, activityIdToKeyMapRef, activityToKeyMapRef, clientActivityIdToKeyMapRef, keyToActivityMapRef]);
  var getActivityByKey = (0, _react.useCallback)(function (key) {
    return key && keyToActivityMapRef.current.get(key);
  }, [keyToActivityMapRef]);
  var getKeyByActivity = (0, _react.useCallback)(function (activity) {
    return activity && activityToKeyMapRef.current.get(activity);
  }, [activityToKeyMapRef]);
  var getKeyByActivityId = (0, _react.useCallback)(function (activityId) {
    return activityId && activityIdToKeyMapRef.current.get(activityId);
  }, [activityIdToKeyMapRef]);
  var contextValue = (0, _react.useMemo)(function () {
    return {
      activityKeysState: activityKeysState,
      getActivityByKey: getActivityByKey,
      getKeyByActivity: getKeyByActivity,
      getKeyByActivityId: getKeyByActivityId
    };
  }, [activityKeysState, getActivityByKey, getKeyByActivity, getKeyByActivityId]);
  var numActivities = activities.length;

  if (activityIdToKeyMapRef.current.size > numActivities) {
    console.warn('botframework-webchat internal assertion: "activityIdToKeyMap.size" should be equal or less than "activities.length".');
  }

  if (activityToKeyMapRef.current.size !== numActivities) {
    console.warn('botframework-webchat internal assertion: "activityToKeyMap.size" should be same as "activities.length".');
  }

  if (clientActivityIdToKeyMapRef.current.size > numActivities) {
    console.warn('botframework-webchat internal assertion: "clientActivityIdToKeyMap.size" should be equal or less than "activities.length".');
  }

  if (keyToActivityMapRef.current.size !== numActivities) {
    console.warn('botframework-webchat internal assertion: "keyToActivityMap.size" should be same as "activities.length".');
  }

  if (activityKeysState[0].length !== numActivities) {
    console.warn('botframework-webchat internal assertion: "activityKeys.length" should be same as "activities.length".');
  }

  return /*#__PURE__*/_react.default.createElement(_Context.default.Provider, {
    value: contextValue
  }, children);
};

ActivityKeyerComposer.defaultProps = {
  children: undefined
};
ActivityKeyerComposer.propTypes = {
  children: _propTypes.default.any
};
var _default = ActivityKeyerComposer;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9wcm92aWRlcnMvQWN0aXZpdHlLZXllci9BY3Rpdml0eUtleWVyQ29tcG9zZXIudHN4Il0sIm5hbWVzIjpbIkFjdGl2aXR5S2V5ZXJDb21wb3NlciIsImNoaWxkcmVuIiwiZXhpc3RpbmdDb250ZXh0IiwiRXJyb3IiLCJhY3Rpdml0aWVzIiwiYWN0aXZpdHlJZFRvS2V5TWFwUmVmIiwiT2JqZWN0IiwiZnJlZXplIiwiTWFwIiwiYWN0aXZpdHlUb0tleU1hcFJlZiIsImNsaWVudEFjdGl2aXR5SWRUb0tleU1hcFJlZiIsImtleVRvQWN0aXZpdHlNYXBSZWYiLCJhY3Rpdml0eUtleXNTdGF0ZSIsImFjdGl2aXR5SWRUb0tleU1hcCIsImN1cnJlbnQiLCJhY3Rpdml0eVRvS2V5TWFwIiwiY2xpZW50QWN0aXZpdHlJZFRvS2V5TWFwIiwibmV4dEFjdGl2aXR5SWRUb0tleU1hcCIsIm5leHRBY3Rpdml0eUtleXMiLCJuZXh0QWN0aXZpdHlUb0tleU1hcCIsIm5leHRDbGllbnRBY3Rpdml0eUlkVG9LZXlNYXAiLCJuZXh0S2V5VG9BY3Rpdml0eU1hcCIsImZvckVhY2giLCJhY3Rpdml0eSIsImFjdGl2aXR5SWQiLCJjbGllbnRBY3Rpdml0eUlkIiwia2V5IiwiZ2V0Iiwic2V0IiwicHVzaCIsImdldEFjdGl2aXR5QnlLZXkiLCJnZXRLZXlCeUFjdGl2aXR5IiwiZ2V0S2V5QnlBY3Rpdml0eUlkIiwiY29udGV4dFZhbHVlIiwibnVtQWN0aXZpdGllcyIsImxlbmd0aCIsInNpemUiLCJjb25zb2xlIiwid2FybiIsImRlZmF1bHRQcm9wcyIsInVuZGVmaW5lZCIsInByb3BUeXBlcyIsIlByb3BUeXBlcyIsImFueSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBS0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBT0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtB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QVEsRUFBRXlDLG1CQUFVQztBQURZLENBQWxDO2VBSWUzQyxxQiIsInNvdXJjZVJvb3QiOiJjb21wb25lbnQ6Ly8vIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJztcbmltcG9ydCBSZWFjdCwgeyB1c2VDYWxsYmFjaywgdXNlTWVtbywgdXNlUmVmIH0gZnJvbSAncmVhY3QnO1xuXG5pbXBvcnQgdHlwZSB7IERpcmVjdExpbmVBY3Rpdml0eSB9IGZyb20gJ2JvdGZyYW1ld29yay13ZWJjaGF0LWNvcmUnO1xuaW1wb3J0IHR5cGUgeyBGQyB9IGZyb20gJ3JlYWN0JztcblxuaW1wb3J0IEFjdGl2aXR5S2V5ZXJDb250ZXh0LCB7IEFjdGl2aXR5S2V5ZXJDb250ZXh0VHlwZSB9IGZyb20gJy4vcHJpdmF0ZS9Db250ZXh0JztcbmltcG9ydCBnZXRBY3Rpdml0eUlkIGZyb20gJy4vcHJpdmF0ZS9nZXRBY3Rpdml0eUlkJztcbmltcG9ydCBnZXRDbGllbnRBY3Rpdml0eUlkIGZyb20gJy4vcHJpdmF0ZS9nZXRDbGllbnRBY3Rpdml0eUlkJztcbmltcG9ydCB1bmlxdWVJZCBmcm9tICcuL3ByaXZhdGUvdW5pcXVlSWQnO1xuaW1wb3J0IHVzZUFjdGl2aXRpZXMgZnJvbSAnLi4vLi4vaG9va3MvdXNlQWN0aXZpdGllcyc7XG5pbXBvcnQgdXNlQWN0aXZpdHlLZXllckNvbnRleHQgZnJvbSAnLi9wcml2YXRlL3VzZUNvbnRleHQnO1xuXG50eXBlIEFjdGl2aXR5SWRUb0tleU1hcCA9IE1hcDxzdHJpbmcsIHN0cmluZz47XG50eXBlIEFjdGl2aXR5VG9LZXlNYXAgPSBNYXA8RGlyZWN0TGluZUFjdGl2aXR5LCBzdHJpbmc+O1xudHlwZSBDbGllbnRBY3Rpdml0eUlkVG9LZXlNYXAgPSBNYXA8c3RyaW5nLCBzdHJpbmc+O1xudHlwZSBLZXlUb0FjdGl2aXR5TWFwID0gTWFwPHN0cmluZywgRGlyZWN0TGluZUFjdGl2aXR5PjtcblxuLyoqXG4gKiBSZWFjdCBjb250ZXh0IGNvbXBvc2VyIGNvbXBvbmVudCB0byBhc3NpZ24gYSBwZXJtYS1rZXkgdG8gZXZlcnkgYWN0aXZpdHkuXG4gKiBUaGlzIHdpbGwgc3VwcG9ydCBib3RoIGB1c2VHZXRBY3Rpdml0eUJ5S2V5YCBhbmQgYHVzZUdldEtleUJ5QWN0aXZpdHlgIGN1c3RvbSBob29rcy5cbiAqXG4gKiBUb2RheSwgYGFjdGl2aXR5LmlkYCBpcyBvbmx5IGd1YXJhbnRlZWQgZm9yIGFjdGl2aXR5IGZyb20gb3RoZXJzLlxuICogTm90IGFsbCBhY3Rpdml0aWVzIHNlbnQgYnkgdGhlIGxvY2FsIHVzZXIgaGFzIGBhY3Rpdml0eS5pZGAuXG4gKlxuICogVG8gdHJhY2sgb3V0Z29pbmcgYWN0aXZpdGllcywgd2UgYWRkZWQgYGFjdGl2aXR5LmNoYW5uZWxEYXRhLmNsaWVudEFjdGl2aXR5SWRgLlxuICpcbiAqIFRoaXMgY29tcG9uZW50IHdpbGwgY3JlYXRlIGEgbG9jYWwga2V5LCB3aGljaCBjYW4gYmUgdXNlZCB0byB0cmFjayBib3RoXG4gKiBpbmNvbWluZyBhbmQgb3V0Z29pbmcgYWN0aXZpdGllcyBpbiBhIGNvbnNpc3RlbnQgd2F5LlxuICpcbiAqIExvY2FsIGtleSBhcmUgb25seSBwZXJzaXN0ZWQgaW4gbWVtb3J5LiBPbiByZWZyZXNoLCB0aGV5IHdpbGwgYmUgYSBuZXcgcmFuZG9tIGtleS5cbiAqL1xuY29uc3QgQWN0aXZpdHlLZXllckNvbXBvc2VyOiBGQzx7fT4gPSAoeyBjaGlsZHJlbiB9KSA9PiB7XG4gIGNvbnN0IGV4aXN0aW5nQ29udGV4dCA9IHVzZUFjdGl2aXR5S2V5ZXJDb250ZXh0KGZhbHNlKTtcblxuICBpZiAoZXhpc3RpbmdDb250ZXh0KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdib3RmcmFtZXdvcmstd2ViY2hhdCBpbnRlcm5hbDogPEFjdGl2aXR5S2V5ZXJDb21wb3Nlcj4gc2hvdWxkIG5vdCBiZSBuZXN0ZWQuJyk7XG4gIH1cblxuICBjb25zdCBbYWN0aXZpdGllc10gPSB1c2VBY3Rpdml0aWVzKCk7XG4gIGNvbnN0IGFjdGl2aXR5SWRUb0tleU1hcFJlZiA9IHVzZVJlZjxSZWFkb25seTxBY3Rpdml0eUlkVG9LZXlNYXA+PihPYmplY3QuZnJlZXplKG5ldyBNYXAoKSkpO1xuICBjb25zdCBhY3Rpdml0eVRvS2V5TWFwUmVmID0gdXNlUmVmPFJlYWRvbmx5PEFjdGl2aXR5VG9LZXlNYXA+PihPYmplY3QuZnJlZXplKG5ldyBNYXAoKSkpO1xuICBjb25zdCBjbGllbnRBY3Rpdml0eUlkVG9LZXlNYXBSZWYgPSB1c2VSZWY8UmVhZG9ubHk8Q2xpZW50QWN0aXZpdHlJZFRvS2V5TWFwPj4oT2JqZWN0LmZyZWV6ZShuZXcgTWFwKCkpKTtcbiAgY29uc3Qga2V5VG9BY3Rpdml0eU1hcFJlZiA9IHVzZVJlZjxSZWFkb25seTxLZXlUb0FjdGl2aXR5TWFwPj4oT2JqZWN0LmZyZWV6ZShuZXcgTWFwKCkpKTtcblxuICAvLyBUT0RPOiBbUDFdIGB1c2VNZW1vV2l0aFByZXZpb3VzYCB0byBjaGVjayBhbmQgY2FjaGUgdGhlIHJlc3VsdGluZyBhcnJheSBpZiBpdCBoYXNuJ3QgY2hhbmdlZC5cbiAgY29uc3QgYWN0aXZpdHlLZXlzU3RhdGUgPSB1c2VNZW1vPHJlYWRvbmx5IFtyZWFkb25seSBzdHJpbmdbXV0+KCgpID0+IHtcbiAgICBjb25zdCB7IGN1cnJlbnQ6IGFjdGl2aXR5SWRUb0tleU1hcCB9ID0gYWN0aXZpdHlJZFRvS2V5TWFwUmVmO1xuICAgIGNvbnN0IHsgY3VycmVudDogYWN0aXZpdHlUb0tleU1hcCB9ID0gYWN0aXZpdHlUb0tleU1hcFJlZjtcbiAgICBjb25zdCB7IGN1cnJlbnQ6IGNsaWVudEFjdGl2aXR5SWRUb0tleU1hcCB9ID0gY2xpZW50QWN0aXZpdHlJZFRvS2V5TWFwUmVmO1xuICAgIGNvbnN0IG5leHRBY3Rpdml0eUlkVG9LZXlNYXA6IEFjdGl2aXR5SWRUb0tleU1hcCA9IG5ldyBNYXAoKTtcbiAgICBjb25zdCBuZXh0QWN0aXZpdHlLZXlzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGNvbnN0IG5leHRBY3Rpdml0eVRvS2V5TWFwOiBBY3Rpdml0eVRvS2V5TWFwID0gbmV3IE1hcCgpO1xuICAgIGNvbnN0IG5leHRDbGllbnRBY3Rpdml0eUlkVG9LZXlNYXA6IENsaWVudEFjdGl2aXR5SWRUb0tleU1hcCA9IG5ldyBNYXAoKTtcbiAgICBjb25zdCBuZXh0S2V5VG9BY3Rpdml0eU1hcDogS2V5VG9BY3Rpdml0eU1hcCA9IG5ldyBNYXAoKTtcblxuICAgIGFjdGl2aXRpZXMuZm9yRWFjaChhY3Rpdml0eSA9PiB7XG4gICAgICBjb25zdCBhY3Rpdml0eUlkID0gZ2V0QWN0aXZpdHlJZChhY3Rpdml0eSk7XG4gICAgICBjb25zdCBjbGllbnRBY3Rpdml0eUlkID0gZ2V0Q2xpZW50QWN0aXZpdHlJZChhY3Rpdml0eSk7XG5cbiAgICAgIGNvbnN0IGtleSA9XG4gICAgICAgIChjbGllbnRBY3Rpdml0eUlkICYmIGNsaWVudEFjdGl2aXR5SWRUb0tleU1hcC5nZXQoY2xpZW50QWN0aXZpdHlJZCkpIHx8XG4gICAgICAgIChhY3Rpdml0eUlkICYmIGFjdGl2aXR5SWRUb0tleU1hcC5nZXQoYWN0aXZpdHlJZCkpIHx8XG4gICAgICAgIGFjdGl2aXR5VG9LZXlNYXAuZ2V0KGFjdGl2aXR5KSB8fFxuICAgICAgICB1bmlxdWVJZCgpO1xuXG4gICAgICBhY3Rpdml0eUlkICYmIG5leHRBY3Rpdml0eUlkVG9LZXlNYXAuc2V0KGFjdGl2aXR5SWQsIGtleSk7XG4gICAgICBjbGllbnRBY3Rpdml0eUlkICYmIG5leHRDbGllbnRBY3Rpdml0eUlkVG9LZXlNYXAuc2V0KGNsaWVudEFjdGl2aXR5SWQsIGtleSk7XG4gICAgICBuZXh0QWN0aXZpdHlUb0tleU1hcC5zZXQoYWN0aXZpdHksIGtleSk7XG4gICAgICBuZXh0S2V5VG9BY3Rpdml0eU1hcC5zZXQoa2V5LCBhY3Rpdml0eSk7XG4gICAgICBuZXh0QWN0aXZpdHlLZXlzLnB1c2goa2V5KTtcbiAgICB9KTtcblxuICAgIGFjdGl2aXR5SWRUb0tleU1hcFJlZi5jdXJyZW50ID0gT2JqZWN0LmZyZWV6ZShuZXh0QWN0aXZpdHlJZFRvS2V5TWFwKTtcbiAgICBhY3Rpdml0eVRvS2V5TWFwUmVmLmN1cnJlbnQgPSBPYmplY3QuZnJlZXplKG5leHRBY3Rpdml0eVRvS2V5TWFwKTtcbiAgICBjbGllbnRBY3Rpdml0eUlkVG9LZXlNYXBSZWYuY3VycmVudCA9IE9iamVjdC5mcmVlemUobmV4dENsaWVudEFjdGl2aXR5SWRUb0tleU1hcCk7XG4gICAga2V5VG9BY3Rpdml0eU1hcFJlZi5jdXJyZW50ID0gT2JqZWN0LmZyZWV6ZShuZXh0S2V5VG9BY3Rpdml0eU1hcCk7XG5cbiAgICAvLyBgbmV4dEFjdGl2aXR5S2V5c2AgY291bGQgcG90ZW50aWFsbHkgc2FtZSBhcyBgcHJldkFjdGl2aXR5S2V5c2AgZGVzcGl0ZSByZWZlcmVuY2UgZGlmZmVyZW5jZXMsIHdlIHNob3VsZCBtZW1vaXplIGl0LlxuICAgIHJldHVybiBPYmplY3QuZnJlZXplKFtPYmplY3QuZnJlZXplKG5leHRBY3Rpdml0eUtleXMpXSkgYXMgcmVhZG9ubHkgW3JlYWRvbmx5IHN0cmluZ1tdXTtcbiAgfSwgW2FjdGl2aXRpZXMsIGFjdGl2aXR5SWRUb0tleU1hcFJlZiwgYWN0aXZpdHlUb0tleU1hcFJlZiwgY2xpZW50QWN0aXZpdHlJZFRvS2V5TWFwUmVmLCBrZXlUb0FjdGl2aXR5TWFwUmVmXSk7XG5cbiAgY29uc3QgZ2V0QWN0aXZpdHlCeUtleTogKGtleT86IHN0cmluZykgPT4gRGlyZWN0TGluZUFjdGl2aXR5IHwgdW5kZWZpbmVkID0gdXNlQ2FsbGJhY2soXG4gICAgKGtleT86IHN0cmluZyk6IERpcmVjdExpbmVBY3Rpdml0eSB8IHVuZGVmaW5lZCA9PiBrZXkgJiYga2V5VG9BY3Rpdml0eU1hcFJlZi5jdXJyZW50LmdldChrZXkpLFxuICAgIFtrZXlUb0FjdGl2aXR5TWFwUmVmXVxuICApO1xuXG4gIGNvbnN0IGdldEtleUJ5QWN0aXZpdHk6IChhY3Rpdml0eT86IERpcmVjdExpbmVBY3Rpdml0eSkgPT4gc3RyaW5nIHwgdW5kZWZpbmVkID0gdXNlQ2FsbGJhY2soXG4gICAgKGFjdGl2aXR5PzogRGlyZWN0TGluZUFjdGl2aXR5KSA9PiBhY3Rpdml0eSAmJiBhY3Rpdml0eVRvS2V5TWFwUmVmLmN1cnJlbnQuZ2V0KGFjdGl2aXR5KSxcbiAgICBbYWN0aXZpdHlUb0tleU1hcFJlZl1cbiAgKTtcblxuICBjb25zdCBnZXRLZXlCeUFjdGl2aXR5SWQ6IChhY3Rpdml0eUlkPzogc3RyaW5nKSA9PiBzdHJpbmcgfCB1bmRlZmluZWQgPSB1c2VDYWxsYmFjayhcbiAgICAoYWN0aXZpdHlJZD86IHN0cmluZykgPT4gYWN0aXZpdHlJZCAmJiBhY3Rpdml0eUlkVG9LZXlNYXBSZWYuY3VycmVudC5nZXQoYWN0aXZpdHlJZCksXG4gICAgW2FjdGl2aXR5SWRUb0tleU1hcFJlZl1cbiAgKTtcblxuICBjb25zdCBjb250ZXh0VmFsdWUgPSB1c2VNZW1vPEFjdGl2aXR5S2V5ZXJDb250ZXh0VHlwZT4oXG4gICAgKCkgPT4gKHtcbiAgICAgIGFjdGl2aXR5S2V5c1N0YXRlLFxuICAgICAgZ2V0QWN0aXZpdHlCeUtleSxcbiAgICAgIGdldEtleUJ5QWN0aXZpdHksXG4gICAgICBnZXRLZXlCeUFjdGl2aXR5SWRcbiAgICB9KSxcbiAgICBbYWN0aXZpdHlLZXlzU3RhdGUsIGdldEFjdGl2aXR5QnlLZXksIGdldEtleUJ5QWN0aXZpdHksIGdldEtleUJ5QWN0aXZpdHlJZF1cbiAgKTtcblxuICBjb25zdCB7IGxlbmd0aDogbnVtQWN0aXZpdGllcyB9ID0gYWN0aXZpdGllcztcblxuICBpZiAoYWN0aXZpdHlJZFRvS2V5TWFwUmVmLmN1cnJlbnQuc2l6ZSA+IG51bUFjdGl2aXRpZXMpIHtcbiAgICBjb25zb2xlLndhcm4oXG4gICAgICAnYm90ZnJhbWV3b3JrLXdlYmNoYXQgaW50ZXJuYWwgYXNzZXJ0aW9uOiBcImFjdGl2aXR5SWRUb0tleU1hcC5zaXplXCIgc2hvdWxkIGJlIGVxdWFsIG9yIGxlc3MgdGhhbiBcImFjdGl2aXRpZXMubGVuZ3RoXCIuJ1xuICAgICk7XG4gIH1cblxuICBpZiAoYWN0aXZpdHlUb0tleU1hcFJlZi5jdXJyZW50LnNpemUgIT09IG51bUFjdGl2aXRpZXMpIHtcbiAgICBjb25zb2xlLndhcm4oXG4gICAgICAnYm90ZnJhbWV3b3JrLXdlYmNoYXQgaW50ZXJuYWwgYXNzZXJ0aW9uOiBcImFjdGl2aXR5VG9LZXlNYXAuc2l6ZVwiIHNob3VsZCBiZSBzYW1lIGFzIFwiYWN0aXZpdGllcy5sZW5ndGhcIi4nXG4gICAgKTtcbiAgfVxuXG4gIGlmIChjbGllbnRBY3Rpdml0eUlkVG9LZXlNYXBSZWYuY3VycmVudC5zaXplID4gbnVtQWN0aXZpdGllcykge1xuICAgIGNvbnNvbGUud2FybihcbiAgICAgICdib3RmcmFtZXdvcmstd2ViY2hhdCBpbnRlcm5hbCBhc3NlcnRpb246IFwiY2xpZW50QWN0aXZpdHlJZFRvS2V5TWFwLnNpemVcIiBzaG91bGQgYmUgZXF1YWwgb3IgbGVzcyB0aGFuIFwiYWN0aXZpdGllcy5sZW5ndGhcIi4nXG4gICAgKTtcbiAgfVxuXG4gIGlmIChrZXlUb0FjdGl2aXR5TWFwUmVmLmN1cnJlbnQuc2l6ZSAhPT0gbnVtQWN0aXZpdGllcykge1xuICAgIGNvbnNvbGUud2FybihcbiAgICAgICdib3RmcmFtZXdvcmstd2ViY2hhdCBpbnRlcm5hbCBhc3NlcnRpb246IFwia2V5VG9BY3Rpdml0eU1hcC5zaXplXCIgc2hvdWxkIGJlIHNhbWUgYXMgXCJhY3Rpdml0aWVzLmxlbmd0aFwiLidcbiAgICApO1xuICB9XG5cbiAgaWYgKGFjdGl2aXR5S2V5c1N0YXRlWzBdLmxlbmd0aCAhPT0gbnVtQWN0aXZpdGllcykge1xuICAgIGNvbnNvbGUud2FybihcbiAgICAgICdib3RmcmFtZXdvcmstd2ViY2hhdCBpbnRlcm5hbCBhc3NlcnRpb246IFwiYWN0aXZpdHlLZXlzLmxlbmd0aFwiIHNob3VsZCBiZSBzYW1lIGFzIFwiYWN0aXZpdGllcy5sZW5ndGhcIi4nXG4gICAgKTtcbiAgfVxuXG4gIHJldHVybiA8QWN0aXZpdHlLZXllckNvbnRleHQuUHJvdmlkZXIgdmFsdWU9e2NvbnRleHRWYWx1ZX0+e2NoaWxkcmVufTwvQWN0aXZpdHlLZXllckNvbnRleHQuUHJvdmlkZXI+O1xufTtcblxuQWN0aXZpdHlLZXllckNvbXBvc2VyLmRlZmF1bHRQcm9wcyA9IHtcbiAgY2hpbGRyZW46IHVuZGVmaW5lZFxufTtcblxuQWN0aXZpdHlLZXllckNvbXBvc2VyLnByb3BUeXBlcyA9IHtcbiAgY2hpbGRyZW46IFByb3BUeXBlcy5hbnlcbn07XG5cbmV4cG9ydCBkZWZhdWx0IEFjdGl2aXR5S2V5ZXJDb21wb3NlcjtcbiJdfQ==