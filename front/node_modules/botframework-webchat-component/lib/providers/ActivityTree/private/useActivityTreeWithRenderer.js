"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _botframeworkWebchatApi = require("botframework-webchat-api");

var _react = require("react");

var _intersectionOf = _interopRequireDefault(require("../../../Utils/intersectionOf"));

var _removeInline = _interopRequireDefault(require("../../../Utils/removeInline"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _unsupportedIterableToArray(arr) || _nonIterableSpread(); }

function _nonIterableSpread() { throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }

function _iterableToArray(iter) { if (typeof Symbol !== "undefined" && iter[Symbol.iterator] != null || iter["@@iterator"] != null) return Array.from(iter); }

function _arrayWithoutHoles(arr) { if (Array.isArray(arr)) return _arrayLikeToArray(arr); }

function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _unsupportedIterableToArray(arr, i) || _nonIterableRest(); }

function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }

function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

function _iterableToArrayLimit(arr, i) { var _i = arr == null ? null : typeof Symbol !== "undefined" && arr[Symbol.iterator] || arr["@@iterator"]; if (_i == null) return; var _arr = []; var _n = true; var _d = false; var _s, _e; try { for (_i = _i.call(arr); !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"] != null) _i["return"](); } finally { if (_d) throw _e; } } return _arr; }

function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }

var useGroupActivities = _botframeworkWebchatApi.hooks.useGroupActivities;

function validateAllEntriesTagged(entries, bins) {
  return entries.every(function (entry) {
    return bins.some(function (bin) {
      return bin.includes(entry);
    });
  });
} // Activity tree is a multidimensional array, while activities is a 1D array.
// - The first dimension of the array contains activities with same sender;
// - The second dimension of the array contains activities with same status.
// [
//   [
//     // Both messages are from bot and is sent as a batch, we will group them as an array.
//     'Bot: Hello!'
//     'Bot: What can I help today?'
//   ],
//   [
//     'User: What is the weather?'
//   ],
//   [
//     'Bot: Let me look it up... hold on.'
//   ],
//   [
//     // This message is in a different group because it is more than a few seconds apart from the previous message.
//     'Bot: Here is the weather forecast.'
//   ]
// ]


function useActivityTreeWithRenderer(entries) {
  var groupActivities = useGroupActivities(); // We bin activities in 2 different ways:
  // - `activitiesBySender` is a 2D array containing activities with same sender
  // - `activitiesByStatus` is a 2D array containing activities with same status
  // Both arrays should contains all activities.

  var _useMemo = (0, _react.useMemo)(function () {
    var visibleActivities = entries.map(function (_ref) {
      var activity = _ref.activity;
      return activity;
    });

    var _groupActivities = groupActivities({
      activities: visibleActivities
    }),
        activitiesBySender = _groupActivities.sender,
        activitiesByStatus = _groupActivities.status;

    var _map = [activitiesBySender, activitiesByStatus].map(function (bins) {
      return bins.map(function (bin) {
        return bin.map(function (activity) {
          return entries.find(function (entry) {
            return entry.activity === activity;
          });
        });
      });
    }),
        _map2 = _slicedToArray(_map, 2),
        entriesBySender = _map2[0],
        entriesByStatus = _map2[1];

    if (!validateAllEntriesTagged(visibleActivities, activitiesBySender)) {
      console.warn('botframework-webchat: Not every activities are grouped in the "sender" property. Please fix "groupActivitiesMiddleware" and group every activities.');
    }

    if (!validateAllEntriesTagged(visibleActivities, activitiesByStatus)) {
      console.warn('botframework-webchat: Not every activities are grouped in the "status" property. Please fix "groupActivitiesMiddleware" and group every activities.');
    }

    return {
      entriesBySender: entriesBySender,
      entriesByStatus: entriesByStatus
    };
  }, [entries, groupActivities]),
      entriesBySender = _useMemo.entriesBySender,
      entriesByStatus = _useMemo.entriesByStatus; // Create a tree of activities with 2 dimensions: sender, followed by status.


  var activityTree = (0, _react.useMemo)(function () {
    var entriesPendingGrouping = _toConsumableArray(entries);

    var activityTree = [];

    var _loop = function _loop() {
      var entriesWithSameSender = entriesBySender.find(function (bin) {
        return bin.includes(entriesPendingGrouping[0]);
      });
      var senderTree = [];
      entriesWithSameSender.forEach(function (entry) {
        var entriesWithSameStatus = entriesByStatus.find(function (bin) {
          return bin.includes(entry);
        });
        var entriesWithSameSenderAndStatus = (0, _intersectionOf.default)(entriesPendingGrouping, entriesWithSameSender, entriesWithSameStatus);

        if (entriesWithSameSenderAndStatus.length) {
          senderTree.push(Object.freeze(entriesWithSameSenderAndStatus));

          _removeInline.default.apply(void 0, [entriesPendingGrouping].concat(_toConsumableArray(entriesWithSameSenderAndStatus)));
        }
      });
      activityTree.push(Object.freeze(senderTree));
    };

    while (entriesPendingGrouping.length) {
      _loop();
    } // Assertion: All entries must be assigned to the activityTree.


    if (!entries.every(function (activity) {
      return activityTree.some(function (activitiesWithSameSender) {
        return activitiesWithSameSender.some(function (activitiesWithSameSenderAndStatus) {
          return activitiesWithSameSenderAndStatus.includes(activity);
        });
      });
    })) {
      console.warn('botframework-webchat internal: Not all visible activities are grouped in the activityTree.', {
        entries: entries,
        activityTree: activityTree
      });
    }

    return Object.freeze(activityTree);
  }, [entriesBySender, entriesByStatus, entries]);
  return activityTree;
}

var _default = useActivityTreeWithRenderer;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9wcm92aWRlcnMvQWN0aXZpdHlUcmVlL3ByaXZhdGUvdXNlQWN0aXZpdHlUcmVlV2l0aFJlbmRlcmVyLnRzIl0sIm5hbWVzIjpbInVzZUdyb3VwQWN0aXZpdGllcyIsImhvb2tzIiwidmFsaWRhdGVBbGxFbnRyaWVzVGFnZ2VkIiwiZW50cmllcyIsImJpbnMiLCJldmVyeSIsImVudHJ5Iiwic29tZSIsImJpbiIsImluY2x1ZGVzIiwidXNlQWN0aXZpdHlUcmVlV2l0aFJlbmRlcmVyIiwiZ3JvdXBBY3Rpdml0aWVzIiwidmlzaWJsZUFjdGl2aXRpZXMiLCJtYXAiLCJhY3Rpdml0eSIsImFjdGl2aXRpZXMiLCJhY3Rpdml0aWVzQnlTZW5kZXIiLCJzZW5kZXIiLCJhY3Rpdml0aWVzQnlTdGF0dXMiLCJzdGF0dXMiLCJmaW5kIiwiZW50cmllc0J5U2VuZGVyIiwiZW50cmllc0J5U3RhdHVzIiwiY29uc29sZSIsIndhcm4iLCJhY3Rpdml0eVRyZWUiLCJlbnRyaWVzUGVuZGluZ0dyb3VwaW5nIiwiZW50cmllc1dpdGhTYW1lU2VuZGVyIiwic2VuZGVyVHJlZSIsImZvckVhY2giLCJlbnRyaWVzV2l0aFNhbWVTdGF0dXMiLCJlbnRyaWVzV2l0aFNhbWVTZW5kZXJBbmRTdGF0dXMiLCJsZW5ndGgiLCJwdXNoIiwiT2JqZWN0IiwiZnJlZXplIiwicmVtb3ZlSW5saW5lIiwiYWN0aXZpdGllc1dpdGhTYW1lU2VuZGVyIiwiYWN0aXZpdGllc1dpdGhTYW1lU2VuZGVyQW5kU3RhdHVzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBSUE7O0FBQ0E7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUlBLElBQVFBLGtCQUFSLEdBQStCQyw2QkFBL0IsQ0FBUUQsa0JBQVI7O0FBRUEsU0FBU0Usd0JBQVQsQ0FDRUMsT0FERixFQUVFQyxJQUZGLEVBR1c7QUFDVCxTQUFPRCxPQUFPLENBQUNFLEtBQVIsQ0FBYyxVQUFBQyxLQUFLO0FB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bnQ6Ly8vIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaG9va3MgfSBmcm9tICdib3RmcmFtZXdvcmstd2ViY2hhdC1hcGknO1xuaW1wb3J0IHsgdXNlTWVtbyB9IGZyb20gJ3JlYWN0JztcblxuaW1wb3J0IHR5cGUgeyBEaXJlY3RMaW5lQWN0aXZpdHkgfSBmcm9tICdib3RmcmFtZXdvcmstd2ViY2hhdC1jb3JlJztcblxuaW1wb3J0IGludGVyc2VjdGlvbk9mIGZyb20gJy4uLy4uLy4uL1V0aWxzL2ludGVyc2VjdGlvbk9mJztcbmltcG9ydCByZW1vdmVJbmxpbmUgZnJvbSAnLi4vLi4vLi4vVXRpbHMvcmVtb3ZlSW5saW5lJztcblxuaW1wb3J0IHR5cGUgeyBBY3Rpdml0eVdpdGhSZW5kZXJlciwgUmVhZG9ubHlBY3Rpdml0eVRyZWUgfSBmcm9tICcuL3R5cGVzJztcblxuY29uc3QgeyB1c2VHcm91cEFjdGl2aXRpZXMgfSA9IGhvb2tzO1xuXG5mdW5jdGlvbiB2YWxpZGF0ZUFsbEVudHJpZXNUYWdnZWQoXG4gIGVudHJpZXM6IHJlYWRvbmx5IEFjdGl2aXR5V2l0aFJlbmRlcmVyW10sXG4gIGJpbnM6IHJlYWRvbmx5IChyZWFkb25seSBBY3Rpdml0eVdpdGhSZW5kZXJlcltdKVtdXG4pOiBib29sZWFuIHtcbiAgcmV0dXJuIGVudHJpZXMuZXZlcnkoZW50cnkgPT4gYmlucy5zb21lKGJpbiA9PiBiaW4uaW5jbHVkZXMoZW50cnkpKSk7XG59XG5cbi8vIEFjdGl2aXR5IHRyZWUgaXMgYSBtdWx0aWRpbWVuc2lvbmFsIGFycmF5LCB3aGlsZSBhY3Rpdml0aWVzIGlzIGEgMUQgYXJyYXkuXG4vLyAtIFRoZSBmaXJzdCBkaW1lbnNpb24gb2YgdGhlIGFycmF5IGNvbnRhaW5zIGFjdGl2aXRpZXMgd2l0aCBzYW1lIHNlbmRlcjtcbi8vIC0gVGhlIHNlY29uZCBkaW1lbnNpb24gb2YgdGhlIGFycmF5IGNvbnRhaW5zIGFjdGl2aXRpZXMgd2l0aCBzYW1lIHN0YXR1cy5cblxuLy8gW1xuLy8gICBbXG4vLyAgICAgLy8gQm90aCBtZXNzYWdlcyBhcmUgZnJvbSBib3QgYW5kIGlzIHNlbnQgYXMgYSBiYXRjaCwgd2Ugd2lsbCBncm91cCB0aGVtIGFzIGFuIGFycmF5LlxuLy8gICAgICdCb3Q6IEhlbGxvISdcbi8vICAgICAnQm90OiBXaGF0IGNhbiBJIGhlbHAgdG9kYXk/J1xuLy8gICBdLFxuLy8gICBbXG4vLyAgICAgJ1VzZXI6IFdoYXQgaXMgdGhlIHdlYXRoZXI/J1xuLy8gICBdLFxuLy8gICBbXG4vLyAgICAgJ0JvdDogTGV0IG1lIGxvb2sgaXQgdXAuLi4gaG9sZCBvbi4nXG4vLyAgIF0sXG4vLyAgIFtcbi8vICAgICAvLyBUaGlzIG1lc3NhZ2UgaXMgaW4gYSBkaWZmZXJlbnQgZ3JvdXAgYmVjYXVzZSBpdCBpcyBtb3JlIHRoYW4gYSBmZXcgc2Vjb25kcyBhcGFydCBmcm9tIHRoZSBwcmV2aW91cyBtZXNzYWdlLlxuLy8gICAgICdCb3Q6IEhlcmUgaXMgdGhlIHdlYXRoZXIgZm9yZWNhc3QuJ1xuLy8gICBdXG4vLyBdXG5cbmZ1bmN0aW9uIHVzZUFjdGl2aXR5VHJlZVdpdGhSZW5kZXJlcihlbnRyaWVzOiByZWFkb25seSBBY3Rpdml0eVdpdGhSZW5kZXJlcltdKTogUmVhZG9ubHlBY3Rpdml0eVRyZWUge1xuICBjb25zdCBncm91cEFjdGl2aXRpZXMgPSB1c2VHcm91cEFjdGl2aXRpZXMoKTtcblxuICAvLyBXZSBiaW4gYWN0aXZpdGllcyBpbiAyIGRpZmZlcmVudCB3YXlzOlxuICAvLyAtIGBhY3Rpdml0aWVzQnlTZW5kZXJgIGlzIGEgMkQgYXJyYXkgY29udGFpbmluZyBhY3Rpdml0aWVzIHdpdGggc2FtZSBzZW5kZXJcbiAgLy8gLSBgYWN0aXZpdGllc0J5U3RhdHVzYCBpcyBhIDJEIGFycmF5IGNvbnRhaW5pbmcgYWN0aXZpdGllcyB3aXRoIHNhbWUgc3RhdHVzXG4gIC8vIEJvdGggYXJyYXlzIHNob3VsZCBjb250YWlucyBhbGwgYWN0aXZpdGllcy5cblxuICBjb25zdCB7IGVudHJpZXNCeVNlbmRlciwgZW50cmllc0J5U3RhdHVzIH0gPSB1c2VNZW1vPHtcbiAgICBlbnRyaWVzQnlTZW5kZXI6IHJlYWRvbmx5IChyZWFkb25seSBEaXJlY3RMaW5lQWN0aXZpdHlbXSlbXTtcbiAgICBlbnRyaWVzQnlTdGF0dXM6IHJlYWRvbmx5IChyZWFkb25seSBEaXJlY3RMaW5lQWN0aXZpdHlbXSlbXTtcbiAgfT4oKCkgPT4ge1xuICAgIGNvbnN0IHZpc2libGVBY3Rpdml0aWVzID0gZW50cmllcy5tYXAoKHsgYWN0aXZpdHkgfSkgPT4gYWN0aXZpdHkpO1xuXG4gICAgY29uc3Qge1xuICAgICAgc2VuZGVyOiBhY3Rpdml0aWVzQnlTZW5kZXIsXG4gICAgICBzdGF0dXM6IGFjdGl2aXRpZXNCeVN0YXR1c1xuICAgIH06IHtcbiAgICAgIHNlbmRlcjogcmVhZG9ubHkgKHJlYWRvbmx5IERpcmVjdExpbmVBY3Rpdml0eVtdKVtdO1xuICAgICAgc3RhdHVzOiByZWFkb25seSAocmVhZG9ubHkgRGlyZWN0TGluZUFjdGl2aXR5W10pW107XG4gICAgfSA9IGdyb3VwQWN0aXZpdGllcyh7XG4gICAgICBhY3Rpdml0aWVzOiB2aXNpYmxlQWN0aXZpdGllc1xuICAgIH0pO1xuXG4gICAgY29uc3QgW2VudHJpZXNCeVNlbmRlciwgZW50cmllc0J5U3RhdHVzXSA9IFthY3Rpdml0aWVzQnlTZW5kZXIsIGFjdGl2aXRpZXNCeVN0YXR1c10ubWFwKGJpbnMgPT5cbiAgICAgIGJpbnMubWFwKGJpbiA9PiBiaW4ubWFwKGFjdGl2aXR5ID0+IGVudHJpZXMuZmluZChlbnRyeSA9PiBlbnRyeS5hY3Rpdml0eSA9PT0gYWN0aXZpdHkpKSlcbiAgICApO1xuXG4gICAgaWYgKCF2YWxpZGF0ZUFsbEVudHJpZXNUYWdnZWQodmlzaWJsZUFjdGl2aXRpZXMsIGFjdGl2aXRpZXNCeVNlbmRlcikpIHtcbiAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgJ2JvdGZyYW1ld29yay13ZWJjaGF0OiBOb3QgZXZlcnkgYWN0aXZpdGllcyBhcmUgZ3JvdXBlZCBpbiB0aGUgXCJzZW5kZXJcIiBwcm9wZXJ0eS4gUGxlYXNlIGZpeCBcImdyb3VwQWN0aXZpdGllc01pZGRsZXdhcmVcIiBhbmQgZ3JvdXAgZXZlcnkgYWN0aXZpdGllcy4nXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmICghdmFsaWRhdGVBbGxFbnRyaWVzVGFnZ2VkKHZpc2libGVBY3Rpdml0aWVzLCBhY3Rpdml0aWVzQnlTdGF0dXMpKSB7XG4gICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgICdib3RmcmFtZXdvcmstd2ViY2hhdDogTm90IGV2ZXJ5IGFjdGl2aXRpZXMgYXJlIGdyb3VwZWQgaW4gdGhlIFwic3RhdHVzXCIgcHJvcGVydHkuIFBsZWFzZSBmaXggXCJncm91cEFjdGl2aXRpZXNNaWRkbGV3YXJlXCIgYW5kIGdyb3VwIGV2ZXJ5IGFjdGl2aXRpZXMuJ1xuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgZW50cmllc0J5U2VuZGVyLFxuICAgICAgZW50cmllc0J5U3RhdHVzXG4gICAgfTtcbiAgfSwgW2VudHJpZXMsIGdyb3VwQWN0aXZpdGllc10pO1xuXG4gIC8vIENyZWF0ZSBhIHRyZWUgb2YgYWN0aXZpdGllcyB3aXRoIDIgZGltZW5zaW9uczogc2VuZGVyLCBmb2xsb3dlZCBieSBzdGF0dXMuXG5cbiAgY29uc3QgYWN0aXZpdHlUcmVlOiBSZWFkb25seUFjdGl2aXR5VHJlZSA9IHVzZU1lbW8oKCkgPT4ge1xuICAgIGNvbnN0IGVudHJpZXNQZW5kaW5nR3JvdXBpbmcgPSBbLi4uZW50cmllc107XG4gICAgY29uc3QgYWN0aXZpdHlUcmVlOiAocmVhZG9ubHkgKHJlYWRvbmx5IEFjdGl2aXR5V2l0aFJlbmRlcmVyW10pW10pW10gPSBbXTtcblxuICAgIHdoaWxlIChlbnRyaWVzUGVuZGluZ0dyb3VwaW5nLmxlbmd0aCkge1xuICAgICAgY29uc3QgZW50cmllc1dpdGhTYW1lU2VuZGVyID0gZW50cmllc0J5U2VuZGVyLmZpbmQoYmluID0+IGJpbi5pbmNsdWRlcyhlbnRyaWVzUGVuZGluZ0dyb3VwaW5nWzBdKSk7XG4gICAgICBjb25zdCBzZW5kZXJUcmVlOiAocmVhZG9ubHkgQWN0aXZpdHlXaXRoUmVuZGVyZXJbXSlbXSA9IFtdO1xuXG4gICAgICBlbnRyaWVzV2l0aFNhbWVTZW5kZXIuZm9yRWFjaChlbnRyeSA9PiB7XG4gICAgICAgIGNvbnN0IGVudHJpZXNXaXRoU2FtZVN0YXR1cyA9IGVudHJpZXNCeVN0YXR1cy5maW5kKGJpbiA9PiBiaW4uaW5jbHVkZXMoZW50cnkpKTtcblxuICAgICAgICBjb25zdCBlbnRyaWVzV2l0aFNhbWVTZW5kZXJBbmRTdGF0dXMgPSBpbnRlcnNlY3Rpb25PZjxBY3Rpdml0eVdpdGhSZW5kZXJlcj4oXG4gICAgICAgICAgZW50cmllc1BlbmRpbmdHcm91cGluZyxcbiAgICAgICAgICBlbnRyaWVzV2l0aFNhbWVTZW5kZXIsXG4gICAgICAgICAgZW50cmllc1dpdGhTYW1lU3RhdHVzXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKGVudHJpZXNXaXRoU2FtZVNlbmRlckFuZFN0YXR1cy5sZW5ndGgpIHtcbiAgICAgICAgICBzZW5kZXJUcmVlLnB1c2goT2JqZWN0LmZyZWV6ZShlbnRyaWVzV2l0aFNhbWVTZW5kZXJBbmRTdGF0dXMpKTtcbiAgICAgICAgICByZW1vdmVJbmxpbmUoZW50cmllc1BlbmRpbmdHcm91cGluZywgLi4uZW50cmllc1dpdGhTYW1lU2VuZGVyQW5kU3RhdHVzKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIGFjdGl2aXR5VHJlZS5wdXNoKE9iamVjdC5mcmVlemUoc2VuZGVyVHJlZSkpO1xuICAgIH1cblxuICAgIC8vIEFzc2VydGlvbjogQWxsIGVudHJpZXMgbXVzdCBiZSBhc3NpZ25lZCB0byB0aGUgYWN0aXZpdHlUcmVlLlxuICAgIGlmIChcbiAgICAgICFlbnRyaWVzLmV2ZXJ5KGFjdGl2aXR5ID0+XG4gICAgICAgIGFjdGl2aXR5VHJlZS5zb21lKGFjdGl2aXRpZXNXaXRoU2FtZVNlbmRlciA9PlxuICAgICAgICAgIGFjdGl2aXRpZXNXaXRoU2FtZVNlbmRlci5zb21lKGFjdGl2aXRpZXNXaXRoU2FtZVNlbmRlckFuZFN0YXR1cyA9PlxuICAgICAgICAgICAgYWN0aXZpdGllc1dpdGhTYW1lU2VuZGVyQW5kU3RhdHVzLmluY2x1ZGVzKGFjdGl2aXR5KVxuICAgICAgICAgIClcbiAgICAgICAgKVxuICAgICAgKVxuICAgICkge1xuICAgICAgY29uc29sZS53YXJuKCdib3RmcmFtZXdvcmstd2ViY2hhdCBpbnRlcm5hbDogTm90IGFsbCB2aXNpYmxlIGFjdGl2aXRpZXMgYXJlIGdyb3VwZWQgaW4gdGhlIGFjdGl2aXR5VHJlZS4nLCB7XG4gICAgICAgIGVudHJpZXMsXG4gICAgICAgIGFjdGl2aXR5VHJlZVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIE9iamVjdC5mcmVlemUoYWN0aXZpdHlUcmVlKTtcbiAgfSwgW2VudHJpZXNCeVNlbmRlciwgZW50cmllc0J5U3RhdHVzLCBlbnRyaWVzXSk7XG5cbiAgcmV0dXJuIGFjdGl2aXR5VHJlZTtcbn1cblxuZXhwb3J0IHR5cGUgeyBBY3Rpdml0eVdpdGhSZW5kZXJlciB9O1xuXG5leHBvcnQgZGVmYXVsdCB1c2VBY3Rpdml0eVRyZWVXaXRoUmVuZGVyZXI7XG4iXX0=