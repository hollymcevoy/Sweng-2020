"use strict";

function _typeof(obj) { "@babel/helpers - typeof"; if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _reactDictateButton = require("react-dictate-button");

var _botframeworkWebchatCore = require("botframework-webchat-core");

var _botframeworkWebchatApi = require("botframework-webchat-api");

var _propTypes = _interopRequireDefault(require("prop-types"));

var _react = _interopRequireWildcard(require("react"));

var _useResumeAudioContext = _interopRequireDefault(require("./hooks/internal/useResumeAudioContext"));

var _useSettableDictateAbortable = _interopRequireDefault(require("./hooks/internal/useSettableDictateAbortable"));

var _useWebSpeechPonyfill4 = _interopRequireDefault(require("./hooks/useWebSpeechPonyfill"));

var _useSetDictateState = _interopRequireDefault(require("botframework-webchat-api/lib/hooks/internal/useSetDictateState"));

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || _typeof(obj) !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _unsupportedIterableToArray(arr, i) || _nonIterableRest(); }

function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }

function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

function _iterableToArrayLimit(arr, i) { var _i = arr == null ? null : typeof Symbol !== "undefined" && arr[Symbol.iterator] || arr["@@iterator"]; if (_i == null) return; var _arr = []; var _n = true; var _d = false; var _s, _e; try { for (_i = _i.call(arr); !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"] != null) _i["return"](); } finally { if (_d) throw _e; } } return _arr; }

function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }

var useActivities = _botframeworkWebchatApi.hooks.useActivities,
    useDictateInterims = _botframeworkWebchatApi.hooks.useDictateInterims,
    useDictateState = _botframeworkWebchatApi.hooks.useDictateState,
    useDisabled = _botframeworkWebchatApi.hooks.useDisabled,
    useEmitTypingIndicator = _botframeworkWebchatApi.hooks.useEmitTypingIndicator,
    useLanguage = _botframeworkWebchatApi.hooks.useLanguage,
    useSendBoxValue = _botframeworkWebchatApi.hooks.useSendBoxValue,
    useSendTypingIndicator = _botframeworkWebchatApi.hooks.useSendTypingIndicator,
    useShouldSpeakIncomingActivity = _botframeworkWebchatApi.hooks.useShouldSpeakIncomingActivity,
    useStopDictate = _botframeworkWebchatApi.hooks.useStopDictate,
    useSubmitSendBox = _botframeworkWebchatApi.hooks.useSubmitSendBox;
var _Constants$DictateSta = _botframeworkWebchatCore.Constants.DictateState,
    DICTATING = _Constants$DictateSta.DICTATING,
    IDLE = _Constants$DictateSta.IDLE,
    STARTING = _Constants$DictateSta.STARTING;

var Dictation = function Dictation(_ref) {
  var onError = _ref.onError;

  var _useSettableDictateAb = (0, _useSettableDictateAbortable.default)(),
      _useSettableDictateAb2 = _slicedToArray(_useSettableDictateAb, 2),
      setDictateAbortable = _useSettableDictateAb2[1];

  var _useDictateInterims = useDictateInterims(),
      _useDictateInterims2 = _slicedToArray(_useDictateInterims, 2),
      setDictateInterims = _useDictateInterims2[1];

  var _useSendBoxValue = useSendBoxValue(),
      _useSendBoxValue2 = _slicedToArray(_useSendBoxValue, 2),
      setSendBox = _useSendBoxValue2[1];

  var _useShouldSpeakIncomi = useShouldSpeakIncomingActivity(),
      _useShouldSpeakIncomi2 = _slicedToArray(_useShouldSpeakIncomi, 2),
      setShouldSpeakIncomingActivity = _useShouldSpeakIncomi2[1];

  var _useWebSpeechPonyfill = (0, _useWebSpeechPonyfill4.default)(),
      _useWebSpeechPonyfill2 = _slicedToArray(_useWebSpeechPonyfill, 1),
      _useWebSpeechPonyfill3 = _useWebSpeechPonyfill2[0];

  _useWebSpeechPonyfill3 = _useWebSpeechPonyfill3 === void 0 ? {} : _useWebSpeechPonyfill3;
  var SpeechGrammarList = _useWebSpeechPonyfill3.SpeechGrammarList,
      SpeechRecognition = _useWebSpeechPonyfill3.SpeechRecognition;

  var _useActivities = useActivities(),
      _useActivities2 = _slicedToArray(_useActivities, 1),
      activities = _useActivities2[0];

  var _useDictateState = useDictateState(),
      _useDictateState2 = _slicedToArray(_useDictateState, 1),
      dictateState = _useDictateState2[0];

  var _useDisabled = useDisabled(),
      _useDisabled2 = _slicedToArray(_useDisabled, 1),
      disabled = _useDisabled2[0];

  var _useSendTypingIndicat = useSendTypingIndicator(),
      _useSendTypingIndicat2 = _slicedToArray(_useSendTypingIndicat, 1),
      sendTypingIndicator = _useSendTypingIndicat2[0];

  var _useLanguage = useLanguage('speech'),
      _useLanguage2 = _slicedToArray(_useLanguage, 1),
      speechLanguage = _useLanguage2[0];

  var emitTypingIndicator = useEmitTypingIndicator();
  var resumeAudioContext = (0, _useResumeAudioContext.default)();
  var setDictateState = (0, _useSetDictateState.default)();
  var stopDictate = useStopDictate();
  var submitSendBox = useSubmitSendBox();
  var numSpeakingActivities = (0, _react.useMemo)(function () {
    return activities.filter(function (_ref2) {
      var _ref2$channelData = _ref2.channelData;
      _ref2$channelData = _ref2$channelData === void 0 ? {} : _ref2$channelData;
      var speak = _ref2$channelData.speak;
      return speak;
    }).length;
  }, [activities]);
  var handleDictate = (0, _react.useCallback)(function (_ref3) {
    var _ref3$result = _ref3.result;
    _ref3$result = _ref3$result === void 0 ? {} : _ref3$result;
    var confidence = _ref3$result.confidence,
        transcript = _ref3$result.transcript;

    if (dictateState === DICTATING || dictateState === STARTING) {
      setDictateInterims([]);
      setDictateState(IDLE);
      stopDictate();

      if (transcript) {
        setSendBox(transcript);
        submitSendBox('speech', {
          channelData: {
            speech: {
              alternatives: [{
                confidence: confidence,
                transcript: transcript
              }]
            }
          }
        });
        setShouldSpeakIncomingActivity(true);
      }
    }
  }, [dictateState, setDictateInterims, setDictateState, stopDictate, setSendBox, submitSendBox, setShouldSpeakIncomingActivity]);
  var handleDictating = (0, _react.useCallback)(function (_ref4) {
    var abortable = _ref4.abortable,
        _ref4$results = _ref4.results,
        results = _ref4$results === void 0 ? [] : _ref4$results;

    if (dictateState === DICTATING || dictateState === STARTING) {
      var interims = results.map(function (_ref5) {
        var transcript = _ref5.transcript;
        return transcript;
      });
      setDictateAbortable(abortable);
      setDictateInterims(interims);
      setDictateState(DICTATING);
      sendTypingIndicator && emitTypingIndicator();
    }
  }, [dictateState, emitTypingIndicator, sendTypingIndicator, setDictateAbortable, setDictateInterims, setDictateState]);
  var handleError = (0, _react.useCallback)(function (event) {
    dictateState !== IDLE && setDictateState(IDLE);
    (dictateState === DICTATING || dictateState === STARTING) && stopDictate();
    onError && onError(event);
  }, [dictateState, onError, setDictateState, stopDictate]);
  (0, _react.useEffect)(function () {
    window.addEventListener('pointerdown', resumeAudioContext);
    return function () {
      return window.removeEventListener('pointerdown', resumeAudioContext);
    };
  }, [resumeAudioContext]);
  return /*#__PURE__*/_react.default.createElement(_reactDictateButton.Composer, {
    lang: speechLanguage,
    onDictate: handleDictate,
    onError: handleError,
    onProgress: handleDictating,
    speechGrammarList: SpeechGrammarList,
    speechRecognition: SpeechRecognition,
    started: !disabled && (dictateState === STARTING || dictateState === DICTATING) && !numSpeakingActivities
  });
};

Dictation.defaultProps = {
  onError: undefined
};
Dictation.propTypes = {
  onError: _propTypes.default.func
};
var _default = Dictation;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9EaWN0YXRpb24uanMiXSwibmFtZXMiOlsidXNlQWN0aXZpdGllcyIsImhvb2tzIiwidXNlRGljdGF0ZUludGVyaW1zIiwidXNlRGljdGF0ZVN0YXRlIiwidXNlRGlzYWJsZWQiLCJ1c2VFbWl0VHlwaW5nSW5kaWNhdG9yIiwidXNlTGFuZ3VhZ2UiLCJ1c2VTZW5kQm94VmFsdWUiLCJ1c2VTZW5kVHlwaW5nSW5kaWNhdG9yIiwidXNlU2hvdWxkU3BlYWtJbmNvbWluZ0FjdGl2aXR5IiwidXNlU3RvcERpY3RhdGUiLCJ1c2VTdWJtaXRTZW5kQm94IiwiQ29uc3RhbnRzIiwiRGljdGF0ZVN0YXRlIiwiRElDVEFUSU5HIiwiSURMRSIsIlNUQVJUSU5HIiwiRGljdGF0aW9uIiwib25FcnJvciIsInNldERpY3RhdGVBYm9ydGFibGUiLCJzZXREaWN0YXRlSW50ZXJpbXMiLCJzZXRTZW5kQm94Iiwic2V0U2hvdWxkU3BlYWtJbmNvbWluZ0FjdGl2aXR5IiwiU3BlZWNoR3JhbW1hckxpc3QiLCJTcGVlY2hSZWNvZ25pdGlvbiIsImFjdGl2aXRpZXMiLCJkaWN0YXRlU3RhdGUiLCJkaXNhYmxlZCIsInNlbmRUeXBpbmdJbmRpY2F0b3IiLCJzcGVlY2hMYW5ndWFnZSIsImVtaXRUeXBpbmdJbmRpY2F0b3IiLCJyZXN1bWVBdWRpb0NvbnRleHQiLCJzZXREaWN0YXRlU3RhdGUiLCJzdG9wRGljdGF0ZSIsInN1Ym1pdFNlbmRCb3giLCJudW1TcGVha2luZ0FjdGl2aXRpZXMiLCJmaWx0ZXIiLCJjaGFubmVsRGF0YSIsInNwZWFrIiwibGVuZ3RoIiwiaGFuZGxlRGljdGF0ZSIsInJlc3VsdCIsImNvbmZpZGVuY2UiLCJ0cmFuc2NyaXB0Iiwic3BlZWNoIiwiYWx0ZXJuYXRpdmVzIiwiaGFuZGxlRGljdGF0aW5nIiwiYWJvcnRhYmxlIiwicmVzdWx0cyIsImludGVyaW1zIiwibWFwIiwiaGFuZGxlRXJyb3IiLCJldmVudCIsIndpbmRvdyIsImFkZEV2ZW50TGlzdGVuZXIiLCJyZW1vdmVFdmVudExpc3RlbmVyIiwiZGVmYXVsdFByb3BzIiwidW5kZWZpbmVkIiwicHJvcFR5cGVzIiwiUHJvcFR5cGVzIiwiZnVuYyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBR0E7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRUEsSUFDRUEsYUFERixHQVlJQyw2QkFaSixDQUNFRCxhQURGO0FBQUEsSUFFRUUsa0JBRkYsR0FZSUQsNkJBWkosQ0FFRUMsa0JBRkY7QUFBQSxJQUdFQyxlQUhGLEdBWUlGLDZCQVpKLENBR0VFLGVBSEY7QUFBQSxJQUlFQyxXQUpGLEdBWUlILDZCQVpKLENBSUVHLFdBSkY7QUFBQSxJQUtFQyxzQkFMRixHQVlJSiw2QkFaSixDQUtFSSxzQkFMRjtBQUFBLElBTUVDLFdBTkYsR0FZSUwsNkJBWkosQ0FNRUssV0FORjtBQUFBLElBT0VDLGVBUEYsR0FZSU4sNkJBWkosQ0FPRU0sZUFQRjtBQUFBLElBUUVDLHNCQVJGLEdBWUlQLDZCQVpKLENBUUVPLHNCQVJGO0FBQUEsSUFTRUMsOEJBVEYsR0FZSVIsNkJBWkosQ0FTRVEsOEJBVEY7QUFBQSxJQVVFQyxjQVZGLEdBWUlULDZCQVpKLENBVUVTLGNBVkY7QUFBQSxJQVdFQyxnQkFYRixHQVlJViw2QkFaSixDQVdFVSxnQkFYRjtBQWNBLDRCQUVJQyxrQ0FGSixDQUNFQyxZQURGO0FBQUEsSUFDa0JDLFNBRGxCLHlCQUNrQkEsU0FEbEI7QUFBQSxJQUM2QkMsSUFEN0IseUJBQzZCQSxJQUQ3QjtBQUFBLElBQ21DQyxRQURuQyx5QkFDbUNBLFFBRG5DOztBQUlBLElBQU1DLFNBQVMsR0FBRyxTQUFaQSxTQUFZLE9BQWlCO0FBQUEsTUFBZEMsT0FBYyxRQUFkQSxPQUFjOztBQUNqQyw4QkFBZ0MsMkNBQWhDO0FBQUE7QUFBQSxNQUFTQyxtQkFBVDs7QUFDQSw0QkFBK0JqQixrQkFBa0IsRUFBakQ7QUFBQTtBQUFBLE1BQVNrQixr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QUEsaUJBQWlCLEVBQUV2QixpQkFMckI7QUFNRSxJQUFBLGlCQUFpQixFQUFFQyxpQkFOckI7QUFPRSxJQUFBLE9BQU8sRUFBRSxDQUFDRyxRQUFELEtBQWNELFlBQVksS0FBS1YsUUFBakIsSUFBNkJVLFlBQVksS0FBS1osU0FBNUQsS0FBMEUsQ0FBQ3FCO0FBUHRGLElBREY7QUFXRCxDQXhGRDs7QUEwRkFsQixTQUFTLENBQUN1QyxZQUFWLEdBQXlCO0FBQ3ZCdEMsRUFBQUEsT0FBTyxFQUFFdUM7QUFEYyxDQUF6QjtBQUlBeEMsU0FBUyxDQUFDeUMsU0FBVixHQUFzQjtBQUNwQnhDLEVBQUFBLE9BQU8sRUFBRXlDLG1CQUFVQztBQURDLENBQXRCO2VBSWUzQyxTIiwic291cmNlUm9vdCI6ImNvbXBvbmVudDovLy8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb3NlciBhcyBEaWN0YXRlQ29tcG9zZXIgfSBmcm9tICdyZWFjdC1kaWN0YXRlLWJ1dHRvbic7XG5pbXBvcnQgeyBDb25zdGFudHMgfSBmcm9tICdib3RmcmFtZXdvcmstd2ViY2hhdC1jb3JlJztcbmltcG9ydCB7IGhvb2tzIH0gZnJvbSAnYm90ZnJhbWV3b3JrLXdlYmNoYXQtYXBpJztcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcyc7XG5pbXBvcnQgUmVhY3QsIHsgdXNlQ2FsbGJhY2ssIHVzZUVmZmVjdCwgdXNlTWVtbyB9IGZyb20gJ3JlYWN0JztcblxuaW1wb3J0IHVzZVJlc3VtZUF1ZGlvQ29udGV4dCBmcm9tICcuL2hvb2tzL2ludGVybmFsL3VzZVJlc3VtZUF1ZGlvQ29udGV4dCc7XG5pbXBvcnQgdXNlU2V0dGFibGVEaWN0YXRlQWJvcnRhYmxlIGZyb20gJy4vaG9va3MvaW50ZXJuYWwvdXNlU2V0dGFibGVEaWN0YXRlQWJvcnRhYmxlJztcbmltcG9ydCB1c2VXZWJTcGVlY2hQb255ZmlsbCBmcm9tICcuL2hvb2tzL3VzZVdlYlNwZWVjaFBvbnlmaWxsJztcblxuLy8gVE9ETzogW1AxXSAjMzM1MCBObyAvbGliLywgd2UgbmVlZCB0byBtb3ZlIHNldERpY3RhdGVTdGF0ZSBmcm9tIGJmLXdjLWNvcmUgKFJlZHV4KSB0byBSZWFjdCBDb250ZXh0LlxuaW1wb3J0IHVzZVNldERpY3RhdGVTdGF0ZSBmcm9tICdib3RmcmFtZXdvcmstd2ViY2hhdC1hcGkvbGliL2hvb2tzL2ludGVybmFsL3VzZVNldERpY3RhdGVTdGF0ZSc7XG5cbmNvbnN0IHtcbiAgdXNlQWN0aXZpdGllcyxcbiAgdXNlRGljdGF0ZUludGVyaW1zLFxuICB1c2VEaWN0YXRlU3RhdGUsXG4gIHVzZURpc2FibGVkLFxuICB1c2VFbWl0VHlwaW5nSW5kaWNhdG9yLFxuICB1c2VMYW5ndWFnZSxcbiAgdXNlU2VuZEJveFZhbHVlLFxuICB1c2VTZW5kVHlwaW5nSW5kaWNhdG9yLFxuICB1c2VTaG91bGRTcGVha0luY29taW5nQWN0aXZpdHksXG4gIHVzZVN0b3BEaWN0YXRlLFxuICB1c2VTdWJtaXRTZW5kQm94XG59ID0gaG9va3M7XG5cbmNvbnN0IHtcbiAgRGljdGF0ZVN0YXRlOiB7IERJQ1RBVElORywgSURMRSwgU1RBUlRJTkcgfVxufSA9IENvbnN0YW50cztcblxuY29uc3QgRGljdGF0aW9uID0gKHsgb25FcnJvciB9KSA9PiB7XG4gIGNvbnN0IFssIHNldERpY3RhdGVBYm9ydGFibGVdID0gdXNlU2V0dGFibGVEaWN0YXRlQWJvcnRhYmxlKCk7XG4gIGNvbnN0IFssIHNldERpY3RhdGVJbnRlcmltc10gPSB1c2VEaWN0YXRlSW50ZXJpbXMoKTtcbiAgY29uc3QgWywgc2V0U2VuZEJveF0gPSB1c2VTZW5kQm94VmFsdWUoKTtcbiAgY29uc3QgWywgc2V0U2hvdWxkU3BlYWtJbmNvbWluZ0FjdGl2aXR5XSA9IHVzZVNob3VsZFNwZWFrSW5jb21pbmdBY3Rpdml0eSgpO1xuICBjb25zdCBbeyBTcGVlY2hHcmFtbWFyTGlzdCwgU3BlZWNoUmVjb2duaXRpb24gfSA9IHt9XSA9IHVzZVdlYlNwZWVjaFBvbnlmaWxsKCk7XG4gIGNvbnN0IFthY3Rpdml0aWVzXSA9IHVzZUFjdGl2aXRpZXMoKTtcbiAgY29uc3QgW2RpY3RhdGVTdGF0ZV0gPSB1c2VEaWN0YXRlU3RhdGUoKTtcbiAgY29uc3QgW2Rpc2FibGVkXSA9IHVzZURpc2FibGVkKCk7XG4gIGNvbnN0IFtzZW5kVHlwaW5nSW5kaWNhdG9yXSA9IHVzZVNlbmRUeXBpbmdJbmRpY2F0b3IoKTtcbiAgY29uc3QgW3NwZWVjaExhbmd1YWdlXSA9IHVzZUxhbmd1YWdlKCdzcGVlY2gnKTtcbiAgY29uc3QgZW1pdFR5cGluZ0luZGljYXRvciA9IHVzZUVtaXRUeXBpbmdJbmRpY2F0b3IoKTtcbiAgY29uc3QgcmVzdW1lQXVkaW9Db250ZXh0ID0gdXNlUmVzdW1lQXVkaW9Db250ZXh0KCk7XG4gIGNvbnN0IHNldERpY3RhdGVTdGF0ZSA9IHVzZVNldERpY3RhdGVTdGF0ZSgpO1xuICBjb25zdCBzdG9wRGljdGF0ZSA9IHVzZVN0b3BEaWN0YXRlKCk7XG4gIGNvbnN0IHN1Ym1pdFNlbmRCb3ggPSB1c2VTdWJtaXRTZW5kQm94KCk7XG5cbiAgY29uc3QgbnVtU3BlYWtpbmdBY3Rpdml0aWVzID0gdXNlTWVtbyhcbiAgICAoKSA9PiBhY3Rpdml0aWVzLmZpbHRlcigoeyBjaGFubmVsRGF0YTogeyBzcGVhayB9ID0ge30gfSkgPT4gc3BlYWspLmxlbmd0aCxcbiAgICBbYWN0aXZpdGllc11cbiAgKTtcblxuICBjb25zdCBoYW5kbGVEaWN0YXRlID0gdXNlQ2FsbGJhY2soXG4gICAgKHsgcmVzdWx0OiB7IGNvbmZpZGVuY2UsIHRyYW5zY3JpcHQgfSA9IHt9IH0pID0+IHtcbiAgICAgIGlmIChkaWN0YXRlU3RhdGUgPT09IERJQ1RBVElORyB8fCBkaWN0YXRlU3RhdGUgPT09IFNUQVJUSU5HKSB7XG4gICAgICAgIHNldERpY3RhdGVJbnRlcmltcyhbXSk7XG4gICAgICAgIHNldERpY3RhdGVTdGF0ZShJRExFKTtcbiAgICAgICAgc3RvcERpY3RhdGUoKTtcblxuICAgICAgICBpZiAodHJhbnNjcmlwdCkge1xuICAgICAgICAgIHNldFNlbmRCb3godHJhbnNjcmlwdCk7XG4gICAgICAgICAgc3VibWl0U2VuZEJveCgnc3BlZWNoJywgeyBjaGFubmVsRGF0YTogeyBzcGVlY2g6IHsgYWx0ZXJuYXRpdmVzOiBbeyBjb25maWRlbmNlLCB0cmFuc2NyaXB0IH1dIH0gfSB9KTtcbiAgICAgICAgICBzZXRTaG91bGRTcGVha0luY29taW5nQWN0aXZpdHkodHJ1ZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9LFxuICAgIFtcbiAgICAgIGRpY3RhdGVTdGF0ZSxcbiAgICAgIHNldERpY3RhdGVJbnRlcmltcyxcbiAgICAgIHNldERpY3RhdGVTdGF0ZSxcbiAgICAgIHN0b3BEaWN0YXRlLFxuICAgICAgc2V0U2VuZEJveCxcbiAgICAgIHN1Ym1pdFNlbmRCb3gsXG4gICAgICBzZXRTaG91bGRTcGVha0luY29taW5nQWN0aXZpdHlcbiAgICBdXG4gICk7XG5cbiAgY29uc3QgaGFuZGxlRGljdGF0aW5nID0gdXNlQ2FsbGJhY2soXG4gICAgKHsgYWJvcnRhYmxlLCByZXN1bHRzID0gW10gfSkgPT4ge1xuICAgICAgaWYgKGRpY3RhdGVTdGF0ZSA9PT0gRElDVEFUSU5HIHx8IGRpY3RhdGVTdGF0ZSA9PT0gU1RBUlRJTkcpIHtcbiAgICAgICAgY29uc3QgaW50ZXJpbXMgPSByZXN1bHRzLm1hcCgoeyB0cmFuc2NyaXB0IH0pID0+IHRyYW5zY3JpcHQpO1xuXG4gICAgICAgIHNldERpY3RhdGVBYm9ydGFibGUoYWJvcnRhYmxlKTtcbiAgICAgICAgc2V0RGljdGF0ZUludGVyaW1zKGludGVyaW1zKTtcbiAgICAgICAgc2V0RGljdGF0ZVN0YXRlKERJQ1RBVElORyk7XG4gICAgICAgIHNlbmRUeXBpbmdJbmRpY2F0b3IgJiYgZW1pdFR5cGluZ0luZGljYXRvcigpO1xuICAgICAgfVxuICAgIH0sXG4gICAgW2RpY3RhdGVTdGF0ZSwgZW1pdFR5cGluZ0luZGljYXRvciwgc2VuZFR5cGluZ0luZGljYXRvciwgc2V0RGljdGF0ZUFib3J0YWJsZSwgc2V0RGljdGF0ZUludGVyaW1zLCBzZXREaWN0YXRlU3RhdGVdXG4gICk7XG5cbiAgY29uc3QgaGFuZGxlRXJyb3IgPSB1c2VDYWxsYmFjayhcbiAgICBldmVudCA9PiB7XG4gICAgICBkaWN0YXRlU3RhdGUgIT09IElETEUgJiYgc2V0RGljdGF0ZVN0YXRlKElETEUpO1xuICAgICAgKGRpY3RhdGVTdGF0ZSA9PT0gRElDVEFUSU5HIHx8IGRpY3RhdGVTdGF0ZSA9PT0gU1RBUlRJTkcpICYmIHN0b3BEaWN0YXRlKCk7XG5cbiAgICAgIG9uRXJyb3IgJiYgb25FcnJvcihldmVudCk7XG4gICAgfSxcbiAgICBbZGljdGF0ZVN0YXRlLCBvbkVycm9yLCBzZXREaWN0YXRlU3RhdGUsIHN0b3BEaWN0YXRlXVxuICApO1xuXG4gIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3BvaW50ZXJkb3duJywgcmVzdW1lQXVkaW9Db250ZXh0KTtcblxuICAgIHJldHVybiAoKSA9PiB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigncG9pbnRlcmRvd24nLCByZXN1bWVBdWRpb0NvbnRleHQpO1xuICB9LCBbcmVzdW1lQXVkaW9Db250ZXh0XSk7XG5cbiAgcmV0dXJuIChcbiAgICA8RGljdGF0ZUNvbXBvc2VyXG4gICAgICBsYW5nPXtzcGVlY2hMYW5ndWFnZX1cbiAgICAgIG9uRGljdGF0ZT17aGFuZGxlRGljdGF0ZX1cbiAgICAgIG9uRXJyb3I9e2hhbmRsZUVycm9yfVxuICAgICAgb25Qcm9ncmVzcz17aGFuZGxlRGljdGF0aW5nfVxuICAgICAgc3BlZWNoR3JhbW1hckxpc3Q9e1NwZWVjaEdyYW1tYXJMaXN0fVxuICAgICAgc3BlZWNoUmVjb2duaXRpb249e1NwZWVjaFJlY29nbml0aW9ufVxuICAgICAgc3RhcnRlZD17IWRpc2FibGVkICYmIChkaWN0YXRlU3RhdGUgPT09IFNUQVJUSU5HIHx8IGRpY3RhdGVTdGF0ZSA9PT0gRElDVEFUSU5HKSAmJiAhbnVtU3BlYWtpbmdBY3Rpdml0aWVzfVxuICAgIC8+XG4gICk7XG59O1xuXG5EaWN0YXRpb24uZGVmYXVsdFByb3BzID0ge1xuICBvbkVycm9yOiB1bmRlZmluZWRcbn07XG5cbkRpY3RhdGlvbi5wcm9wVHlwZXMgPSB7XG4gIG9uRXJyb3I6IFByb3BUeXBlcy5mdW5jXG59O1xuXG5leHBvcnQgZGVmYXVsdCBEaWN0YXRpb247XG4iXX0=