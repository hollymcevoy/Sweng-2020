"use strict";

function _typeof(obj) { "@babel/helpers - typeof"; if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _botframeworkWebchatApi = require("botframework-webchat-api");

var _botframeworkWebchatCore = require("botframework-webchat-core");

var _propTypes = _interopRequireDefault(require("prop-types"));

var _react = _interopRequireWildcard(require("react"));

var _simpleUpdateIn = _interopRequireDefault(require("simple-update-in"));

var _createCustomEvent = _interopRequireDefault(require("./createCustomEvent"));

var _randomId = _interopRequireDefault(require("./randomId"));

var _useInternalMarkdownIt = _interopRequireDefault(require("../hooks/internal/useInternalMarkdownIt"));

var _useStyleToEmotionObject = _interopRequireDefault(require("../hooks/internal/useStyleToEmotionObject"));

var _walkMarkdownTokens = _interopRequireDefault(require("./walkMarkdownTokens"));

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || _typeof(obj) !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _unsupportedIterableToArray(arr, i) || _nonIterableRest(); }

function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }

function _iterableToArrayLimit(arr, i) { var _i = arr == null ? null : typeof Symbol !== "undefined" && arr[Symbol.iterator] || arr["@@iterator"]; if (_i == null) return; var _arr = []; var _n = true; var _d = false; var _s, _e; try { for (_i = _i.call(arr); !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"] != null) _i["return"](); } finally { if (_d) throw _e; } } return _arr; }

function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }

function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _unsupportedIterableToArray(arr) || _nonIterableSpread(); }

function _nonIterableSpread() { throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }

function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _iterableToArray(iter) { if (typeof Symbol !== "undefined" && iter[Symbol.iterator] != null || iter["@@iterator"] != null) return Array.from(iter); }

function _arrayWithoutHoles(arr) { if (Array.isArray(arr)) return _arrayLikeToArray(arr); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

var useStyleOptions = _botframeworkWebchatApi.hooks.useStyleOptions;

function replaceAnchorWithButton(markdownTokens) {
  return (0, _walkMarkdownTokens.default)(markdownTokens, function (markdownToken) {
    markdownToken = _objectSpread({}, markdownToken);

    switch (markdownToken.type) {
      case 'link_open':
        markdownToken.tag = 'button';
        markdownToken.attrs = [].concat(_toConsumableArray((0, _simpleUpdateIn.default)(markdownToken.attrs, [function (_ref) {
          var _ref2 = _slicedToArray(_ref, 2),
              name = _ref2[0],
              value = _ref2[1];

          return name === 'href' && value.startsWith('#');
        }], function (_ref3) {
          var _ref4 = _slicedToArray(_ref3, 2),
              value = _ref4[1];

          return ['data-markdown-href', value.substr(1)];
        })), [['type', 'button']]);
        break;

      case 'link_close':
        markdownToken.tag = 'button';
        break;

      default:
        break;
    }

    return markdownToken;
  });
}

var InlineMarkdown = function InlineMarkdown(_ref5) {
  var children = _ref5.children,
      onReference = _ref5.onReference,
      references = _ref5.references;

  if (typeof children !== 'string') {
    console.warn('botframework-webchat: "children" prop passed to <InlineMarkdown> must be of type string.');
    children = '';
  }

  var _useInternalMarkdownI = (0, _useInternalMarkdownIt.default)(),
      _useInternalMarkdownI2 = _slicedToArray(_useInternalMarkdownI, 1),
      markdownIt = _useInternalMarkdownI2[0];

  var _useStyleOptions = useStyleOptions(),
      _useStyleOptions2 = _slicedToArray(_useStyleOptions, 1),
      accent = _useStyleOptions2[0].accent;

  var styleToClassName = (0, _useStyleToEmotionObject.default)(); // We inlined the style here because this style is:
  // 1. Internal to Web Chat
  // 2. Not customizable from developers (other than setting `styleOptions.accent`)

  var className = (0, _react.useMemo)(function () {
    return styleToClassName({
      '& button[data-markdown-href]': {
        appearance: 'none',
        backgroundColor: 'transparent',
        border: 0,
        color: accent,
        cursor: 'pointer',
        fontFamily: 'inherit',
        fontSize: 'inherit',
        padding: 0
      }
    }) + '';
  }, [accent, styleToClassName]); // Markdown-It only support references in uppercase.

  references = references.map(function (reference) {
    return reference.toUpperCase();
  });

  var _references$reduce = references.reduce(function (_ref6, ref) {
    var hrefToRef = _ref6.hrefToRef,
        refToHref = _ref6.refToHref;
    var href = (0, _randomId.default)();
    return {
      hrefToRef: _objectSpread(_objectSpread({}, hrefToRef), {}, _defineProperty({}, href, ref)),
      refToHref: _objectSpread(_objectSpread({}, refToHref), {}, _defineProperty({}, ref, href))
    };
  }, {
    hrefToRef: {},
    refToHref: {}
  }),
      hrefToRef = _references$reduce.hrefToRef,
      refToHref = _references$reduce.refToHref;

  var html = (0, _react.useMemo)(function () {
    var tree = markdownIt.parseInline(children, {
      references: references.reduce(function (references, key) {
        return (// Mitigated through denylisting.
          // eslint-disable-next-line security/detect-object-injection
          (0, _botframeworkWebchatCore.isForbiddenPropertyName)(key) ? references : _objectSpread(_objectSpread({}, references), {}, _defineProperty({}, key, {
            href: "#".concat(refToHref[key])
          }))
        );
      }, {})
    }); // Turn "<a href="#retry">Retry</a>" into "<button data-ref="retry" type="button">Retry</button>"

    var updatedTree = replaceAnchorWithButton(tree);
    return {
      __html: markdownIt.renderer.render(updatedTree)
    };
  }, [children, refToHref, markdownIt, references]);
  var handleClick = (0, _react.useCallback)(function (event) {
    event.stopPropagation();
    var href = event.target.getAttribute('data-markdown-href');
    href && onReference && onReference((0, _createCustomEvent.default)('reference', // Mitigated through denylisting.
    // eslint-disable-next-line security/detect-object-injection
    (0, _botframeworkWebchatCore.isForbiddenPropertyName)(href) ? {} : {
      data: hrefToRef[href]
    }));
  }, [hrefToRef, onReference]);
  return /*#__PURE__*/_react.default.createElement("span", {
    className: className,
    dangerouslySetInnerHTML: html,
    onClick: handleClick
  });
};

InlineMarkdown.defaultProps = {
  children: '',
  onReference: undefined,
  references: []
};
InlineMarkdown.propTypes = {
  children: _propTypes.default.string,
  onReference: _propTypes.default.func,
  references: _propTypes.default.arrayOf(_propTypes.default.string)
};
var _default = InlineMarkdown;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9VdGlscy9JbmxpbmVNYXJrZG93bi5qcyJdLCJuYW1lcyI6WyJ1c2VTdHlsZU9wdGlvbnMiLCJob29rcyIsInJlcGxhY2VBbmNob3JXaXRoQnV0dG9uIiwibWFya2Rvd25Ub2tlbnMiLCJtYXJrZG93blRva2VuIiwidHlwZSIsInRhZyIsImF0dHJzIiwibmFtZSIsInZhbHVlIiwic3RhcnRzV2l0aCIsInN1YnN0ciIsIklubGluZU1hcmtkb3duIiwiY2hpbGRyZW4iLCJvblJlZmVyZW5jZSIsInJlZmVyZW5jZXMiLCJjb25zb2xlIiwid2FybiIsIm1hcmtkb3duSXQiLCJhY2NlbnQiLCJzdHlsZVRvQ2xhc3NOYW1lIiwiY2xhc3NOYW1lIiwiYXBwZWFyYW5jZSIsImJhY2tncm91bmRDb2xvciIsImJvcmRlciIsImNvbG9yIiwiY3Vyc29yIiwiZm9udEZhbWlseSIsImZvbnRTaXplIiwicGFkZGluZyIsIm1hcCIsInJlZmVyZW5jZSIsInRvVXBwZXJDYXNlIiwicmVkdWNlIiwicmVmIiwiaHJlZlRvUmVmIiwicmVmVG9IcmVmIiwiaHJlZiIsImh0bWwiLCJ0cmVlIiwicGFyc2VJbmxpbmUiLCJrZXkiLCJ1cGRhdGVkVHJlZSIsIl9faHRtbCIsInJlbmRlcmVyIiwicmVuZGVyIiwiaGFuZGxlQ2xpY2siLCJldmVudCIsInN0b3BQcm9wYWdhdGlvbiIsInRhcmdldCIsImdldEF0dHJpYnV0ZSIsImRhdGEiLCJkZWZhdWx0UHJvcHMiLCJ1bmRlZmluZWQiLCJwcm9wVHlwZXMiLCJQcm9wVHlwZXMiLCJzdHJpbmciLCJmdW5jIiwiYXJyYXlPZiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFQSxJQUFRQSxlQUFSLEdBQTRCQyw2QkFBNUIsQ0FBUUQsZUFBUjs7QUFFQSxTQUFTRSx1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LElBRUVBLFdBQVcsQ0FDVCxnQ0FDRSxXQURGLEVBRUU7QUFDQTtBQUNBLDBEQUF3QnVCLElBQXhCLElBQWdDLEVBQWhDLEdBQXFDO0FBQUVjLE1BQUFBLElBQUksRUFBRWhCLFNBQVMsQ0FBQ0UsSUFBRDtBQUFqQixLQUp2QyxDQURTLENBRmI7QUFVRCxHQWhCaUIsRUFpQmxCLENBQUNGLFNBQUQsRUFBWXJCLFdBQVosQ0FqQmtCLENBQXBCO0FBb0JBLHNCQUFPO0FBQU0sSUFBQSxTQUFTLEVBQUVPLFNBQWpCO0FBQTRCLElBQUEsdUJBQXVCLEVBQUVpQixJQUFyRDtBQUEyRCxJQUFBLE9BQU8sRUFBRVE7QUFBcEUsSUFBUDtBQUNELENBbkZEOztBQXFGQWxDLGNBQWMsQ0FBQ3dDLFlBQWYsR0FBOEI7QUFDNUJ2QyxFQUFBQSxRQUFRLEVBQUUsRUFEa0I7QUFFNUJDLEVBQUFBLFdBQVcsRUFBRXVDLFNBRmU7QUFHNUJ0QyxFQUFBQSxVQUFVLEVBQUU7QUFIZ0IsQ0FBOUI7QUFNQUgsY0FBYyxDQUFDMEMsU0FBZixHQUEyQjtBQUN6QnpDLEVBQUFBLFFBQVEsRUFBRTBDLG1CQUFVQyxNQURLO0FBRXpCMUMsRUFBQUEsV0FBVyxFQUFFeUMsbUJBQVVFLElBRkU7QUFHekIxQyxFQUFBQSxVQUFVLEVBQUV3QyxtQkFBVUcsT0FBVixDQUFrQkgsbUJBQVVDLE1BQTVCO0FBSGEsQ0FBM0I7ZUFNZTVDLGMiLCJzb3VyY2VSb290IjoiY29tcG9uZW50Oi8vLyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludCByZWFjdC9uby1kYW5nZXI6IFwib2ZmXCIgKi9cblxuaW1wb3J0IHsgaG9va3MgfSBmcm9tICdib3RmcmFtZXdvcmstd2ViY2hhdC1hcGknO1xuaW1wb3J0IHsgaXNGb3JiaWRkZW5Qcm9wZXJ0eU5hbWUgfSBmcm9tICdib3RmcmFtZXdvcmstd2ViY2hhdC1jb3JlJztcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcyc7XG5pbXBvcnQgUmVhY3QsIHsgdXNlQ2FsbGJhY2ssIHVzZU1lbW8gfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgdXBkYXRlSW4gZnJvbSAnc2ltcGxlLXVwZGF0ZS1pbic7XG5cbmltcG9ydCBjcmVhdGVDdXN0b21FdmVudCBmcm9tICcuL2NyZWF0ZUN1c3RvbUV2ZW50JztcbmltcG9ydCByYW5kb21JZCBmcm9tICcuL3JhbmRvbUlkJztcbmltcG9ydCB1c2VJbnRlcm5hbE1hcmtkb3duSXQgZnJvbSAnLi4vaG9va3MvaW50ZXJuYWwvdXNlSW50ZXJuYWxNYXJrZG93bkl0JztcbmltcG9ydCB1c2VTdHlsZVRvRW1vdGlvbk9iamVjdCBmcm9tICcuLi9ob29rcy9pbnRlcm5hbC91c2VTdHlsZVRvRW1vdGlvbk9iamVjdCc7XG5pbXBvcnQgd2Fsa01hcmtkb3duVG9rZW5zIGZyb20gJy4vd2Fsa01hcmtkb3duVG9rZW5zJztcblxuY29uc3QgeyB1c2VTdHlsZU9wdGlvbnMgfSA9IGhvb2tzO1xuXG5mdW5jdGlvbiByZXBsYWNlQW5jaG9yV2l0aEJ1dHRvbihtYXJrZG93blRva2Vucykge1xuICByZXR1cm4gd2Fsa01hcmtkb3duVG9rZW5zKG1hcmtkb3duVG9rZW5zLCBtYXJrZG93blRva2VuID0+IHtcbiAgICBtYXJrZG93blRva2VuID0geyAuLi5tYXJrZG93blRva2VuIH07XG5cbiAgICBzd2l0Y2ggKG1hcmtkb3duVG9rZW4udHlwZSkge1xuICAgICAgY2FzZSAnbGlua19vcGVuJzpcbiAgICAgICAgbWFya2Rvd25Ub2tlbi50YWcgPSAnYnV0dG9uJztcbiAgICAgICAgbWFya2Rvd25Ub2tlbi5hdHRycyA9IFtcbiAgICAgICAgICAuLi51cGRhdGVJbihcbiAgICAgICAgICAgIG1hcmtkb3duVG9rZW4uYXR0cnMsXG4gICAgICAgICAgICBbKFtuYW1lLCB2YWx1ZV0pID0+IG5hbWUgPT09ICdocmVmJyAmJiB2YWx1ZS5zdGFydHNXaXRoKCcjJyldLFxuICAgICAgICAgICAgKFssIHZhbHVlXSkgPT4gWydkYXRhLW1hcmtkb3duLWhyZWYnLCB2YWx1ZS5zdWJzdHIoMSldXG4gICAgICAgICAgKSxcbiAgICAgICAgICBbJ3R5cGUnLCAnYnV0dG9uJ11cbiAgICAgICAgXTtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgJ2xpbmtfY2xvc2UnOlxuICAgICAgICBtYXJrZG93blRva2VuLnRhZyA9ICdidXR0b24nO1xuICAgICAgICBicmVhaztcblxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuXG4gICAgcmV0dXJuIG1hcmtkb3duVG9rZW47XG4gIH0pO1xufVxuXG5jb25zdCBJbmxpbmVNYXJrZG93biA9ICh7IGNoaWxkcmVuLCBvblJlZmVyZW5jZSwgcmVmZXJlbmNlcyB9KSA9PiB7XG4gIGlmICh0eXBlb2YgY2hpbGRyZW4gIT09ICdzdHJpbmcnKSB7XG4gICAgY29uc29sZS53YXJuKCdib3RmcmFtZXdvcmstd2ViY2hhdDogXCJjaGlsZHJlblwiIHByb3AgcGFzc2VkIHRvIDxJbmxpbmVNYXJrZG93bj4gbXVzdCBiZSBvZiB0eXBlIHN0cmluZy4nKTtcbiAgICBjaGlsZHJlbiA9ICcnO1xuICB9XG5cbiAgY29uc3QgW21hcmtkb3duSXRdID0gdXNlSW50ZXJuYWxNYXJrZG93bkl0KCk7XG4gIGNvbnN0IFt7IGFjY2VudCB9XSA9IHVzZVN0eWxlT3B0aW9ucygpO1xuICBjb25zdCBzdHlsZVRvQ2xhc3NOYW1lID0gdXNlU3R5bGVUb0Vtb3Rpb25PYmplY3QoKTtcblxuICAvLyBXZSBpbmxpbmVkIHRoZSBzdHlsZSBoZXJlIGJlY2F1c2UgdGhpcyBzdHlsZSBpczpcbiAgLy8gMS4gSW50ZXJuYWwgdG8gV2ViIENoYXRcbiAgLy8gMi4gTm90IGN1c3RvbWl6YWJsZSBmcm9tIGRldmVsb3BlcnMgKG90aGVyIHRoYW4gc2V0dGluZyBgc3R5bGVPcHRpb25zLmFjY2VudGApXG4gIGNvbnN0IGNsYXNzTmFtZSA9IHVzZU1lbW8oXG4gICAgKCkgPT5cbiAgICAgIHN0eWxlVG9DbGFzc05hbWUoe1xuICAgICAgICAnJiBidXR0b25bZGF0YS1tYXJrZG93bi1ocmVmXSc6IHtcbiAgICAgICAgICBhcHBlYXJhbmNlOiAnbm9uZScsXG4gICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAndHJhbnNwYXJlbnQnLFxuICAgICAgICAgIGJvcmRlcjogMCxcbiAgICAgICAgICBjb2xvcjogYWNjZW50LFxuICAgICAgICAgIGN1cnNvcjogJ3BvaW50ZXInLFxuICAgICAgICAgIGZvbnRGYW1pbHk6ICdpbmhlcml0JyxcbiAgICAgICAgICBmb250U2l6ZTogJ2luaGVyaXQnLFxuICAgICAgICAgIHBhZGRpbmc6IDBcbiAgICAgICAgfVxuICAgICAgfSkgKyAnJyxcbiAgICBbYWNjZW50LCBzdHlsZVRvQ2xhc3NOYW1lXVxuICApO1xuXG4gIC8vIE1hcmtkb3duLUl0IG9ubHkgc3VwcG9ydCByZWZlcmVuY2VzIGluIHVwcGVyY2FzZS5cbiAgcmVmZXJlbmNlcyA9IHJlZmVyZW5jZXMubWFwKHJlZmVyZW5jZSA9PiByZWZlcmVuY2UudG9VcHBlckNhc2UoKSk7XG5cbiAgY29uc3QgeyBocmVmVG9SZWYsIHJlZlRvSHJlZiB9ID0gcmVmZXJlbmNlcy5yZWR1Y2UoXG4gICAgKHsgaHJlZlRvUmVmLCByZWZUb0hyZWYgfSwgcmVmKSA9PiB7XG4gICAgICBjb25zdCBocmVmID0gcmFuZG9tSWQoKTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaHJlZlRvUmVmOiB7IC4uLmhyZWZUb1JlZiwgW2hyZWZdOiByZWYgfSxcbiAgICAgICAgcmVmVG9IcmVmOiB7IC4uLnJlZlRvSHJlZiwgW3JlZl06IGhyZWYgfVxuICAgICAgfTtcbiAgICB9LFxuICAgIHsgaHJlZlRvUmVmOiB7fSwgcmVmVG9IcmVmOiB7fSB9XG4gICk7XG5cbiAgY29uc3QgaHRtbCA9IHVzZU1lbW8oKCkgPT4ge1xuICAgIGNvbnN0IHRyZWUgPSBtYXJrZG93bkl0LnBhcnNlSW5saW5lKGNoaWxkcmVuLCB7XG4gICAgICByZWZlcmVuY2VzOiByZWZlcmVuY2VzLnJlZHVjZShcbiAgICAgICAgKHJlZmVyZW5jZXMsIGtleSkgPT5cbiAgICAgICAgICAvLyBNaXRpZ2F0ZWQgdGhyb3VnaCBkZW55bGlzdGluZy5cbiAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgc2VjdXJpdHkvZGV0ZWN0LW9iamVjdC1pbmplY3Rpb25cbiAgICAgICAgICBpc0ZvcmJpZGRlblByb3BlcnR5TmFtZShrZXkpID8gcmVmZXJlbmNlcyA6IHsgLi4ucmVmZXJlbmNlcywgW2tleV06IHsgaHJlZjogYCMke3JlZlRvSHJlZltrZXldfWAgfSB9LFxuICAgICAgICB7fVxuICAgICAgKVxuICAgIH0pO1xuXG4gICAgLy8gVHVybiBcIjxhIGhyZWY9XCIjcmV0cnlcIj5SZXRyeTwvYT5cIiBpbnRvIFwiPGJ1dHRvbiBkYXRhLXJlZj1cInJldHJ5XCIgdHlwZT1cImJ1dHRvblwiPlJldHJ5PC9idXR0b24+XCJcbiAgICBjb25zdCB1cGRhdGVkVHJlZSA9IHJlcGxhY2VBbmNob3JXaXRoQnV0dG9uKHRyZWUpO1xuXG4gICAgcmV0dXJuIHsgX19odG1sOiBtYXJrZG93bkl0LnJlbmRlcmVyLnJlbmRlcih1cGRhdGVkVHJlZSkgfTtcbiAgfSwgW2NoaWxkcmVuLCByZWZUb0hyZWYsIG1hcmtkb3duSXQsIHJlZmVyZW5jZXNdKTtcblxuICBjb25zdCBoYW5kbGVDbGljayA9IHVzZUNhbGxiYWNrKFxuICAgIGV2ZW50ID0+IHtcbiAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuXG4gICAgICBjb25zdCBocmVmID0gZXZlbnQudGFyZ2V0LmdldEF0dHJpYnV0ZSgnZGF0YS1tYXJrZG93bi1ocmVmJyk7XG5cbiAgICAgIGhyZWYgJiZcbiAgICAgICAgb25SZWZlcmVuY2UgJiZcbiAgICAgICAgb25SZWZlcmVuY2UoXG4gICAgICAgICAgY3JlYXRlQ3VzdG9tRXZlbnQoXG4gICAgICAgICAgICAncmVmZXJlbmNlJyxcbiAgICAgICAgICAgIC8vIE1pdGlnYXRlZCB0aHJvdWdoIGRlbnlsaXN0aW5nLlxuICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHNlY3VyaXR5L2RldGVjdC1vYmplY3QtaW5qZWN0aW9uXG4gICAgICAgICAgICBpc0ZvcmJpZGRlblByb3BlcnR5TmFtZShocmVmKSA/IHt9IDogeyBkYXRhOiBocmVmVG9SZWZbaHJlZl0gfVxuICAgICAgICAgIClcbiAgICAgICAgKTtcbiAgICB9LFxuICAgIFtocmVmVG9SZWYsIG9uUmVmZXJlbmNlXVxuICApO1xuXG4gIHJldHVybiA8c3BhbiBjbGFzc05hbWU9e2NsYXNzTmFtZX0gZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUw9e2h0bWx9IG9uQ2xpY2s9e2hhbmRsZUNsaWNrfSAvPjtcbn07XG5cbklubGluZU1hcmtkb3duLmRlZmF1bHRQcm9wcyA9IHtcbiAgY2hpbGRyZW46ICcnLFxuICBvblJlZmVyZW5jZTogdW5kZWZpbmVkLFxuICByZWZlcmVuY2VzOiBbXVxufTtcblxuSW5saW5lTWFya2Rvd24ucHJvcFR5cGVzID0ge1xuICBjaGlsZHJlbjogUHJvcFR5cGVzLnN0cmluZyxcbiAgb25SZWZlcmVuY2U6IFByb3BUeXBlcy5mdW5jLFxuICByZWZlcmVuY2VzOiBQcm9wVHlwZXMuYXJyYXlPZihQcm9wVHlwZXMuc3RyaW5nKVxufTtcblxuZXhwb3J0IGRlZmF1bHQgSW5saW5lTWFya2Rvd247XG4iXX0=