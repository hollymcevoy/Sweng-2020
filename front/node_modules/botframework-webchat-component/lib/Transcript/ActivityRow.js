"use strict";

function _typeof(obj) { "@babel/helpers - typeof"; if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _botframeworkWebchatApi = require("botframework-webchat-api");

var _classnames = _interopRequireDefault(require("classnames"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _react = _interopRequireWildcard(require("react"));

var _detectBrowser = require("../Utils/detectBrowser");

var _FocusTrap = _interopRequireDefault(require("./FocusTrap"));

var _ScreenReaderText = _interopRequireDefault(require("../ScreenReaderText"));

var _Speak = _interopRequireDefault(require("../Activity/Speak"));

var _useActiveDescendantId = _interopRequireDefault(require("../providers/TranscriptFocus/useActiveDescendantId"));

var _useActivityAccessibleName = _interopRequireDefault(require("./useActivityAccessibleName"));

var _useFocusByActivityKey = _interopRequireDefault(require("../providers/TranscriptFocus/useFocusByActivityKey"));

var _useGetDescendantIdByActivityKey = _interopRequireDefault(require("../providers/TranscriptFocus/useGetDescendantIdByActivityKey"));

var _useValueRef = _interopRequireDefault(require("../hooks/internal/useValueRef"));

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || _typeof(obj) !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _unsupportedIterableToArray(arr, i) || _nonIterableRest(); }

function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }

function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

function _iterableToArrayLimit(arr, i) { var _i = arr == null ? null : typeof Symbol !== "undefined" && arr[Symbol.iterator] || arr["@@iterator"]; if (_i == null) return; var _arr = []; var _n = true; var _d = false; var _s, _e; try { for (_i = _i.call(arr); !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"] != null) _i["return"](); } finally { if (_d) throw _e; } } return _arr; }

function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }

var useActivityKeysByRead = _botframeworkWebchatApi.hooks.useActivityKeysByRead,
    useGetHasAcknowledgedByActivityKey = _botframeworkWebchatApi.hooks.useGetHasAcknowledgedByActivityKey,
    useGetKeyByActivity = _botframeworkWebchatApi.hooks.useGetKeyByActivity;
var ActivityRow = /*#__PURE__*/(0, _react.forwardRef)(function (_ref, ref) {
  var _activity$channelData, _activity$channelData2;

  var activity = _ref.activity,
      children = _ref.children;

  var _useActiveDescendantI = (0, _useActiveDescendantId.default)(),
      _useActiveDescendantI2 = _slicedToArray(_useActiveDescendantI, 1),
      activeDescendantId = _useActiveDescendantI2[0];

  var _useActivityKeysByRea = useActivityKeysByRead(),
      _useActivityKeysByRea2 = _slicedToArray(_useActivityKeysByRea, 1),
      readActivityKeys = _useActivityKeysByRea2[0];

  var bodyRef = (0, _react.useRef)();
  var focusByActivityKey = (0, _useFocusByActivityKey.default)();
  var getKeyByActivity = useGetKeyByActivity(); // TODO: [P2] #2858 We should use core/definitions/speakingActivity for this predicate instead

  var shouldSpeak = (_activity$channelData = activity.channelData) === null || _activity$channelData === void 0 ? void 0 : _activity$channelData.speak;

  var _useActivityAccessibl = (0, _useActivityAccessibleName.default)(activity, bodyRef),
      _useActivityAccessibl2 = _slicedToArray(_useActivityAccessibl, 1),
      accessibleName = _useActivityAccessibl2[0];

  var activityKey = getKeyByActivity(activity);
  var acknowledged = useGetHasAcknowledgedByActivityKey()(activityKey);
  var activityKeyRef = (0, _useValueRef.default)(activityKey);
  var descendantId = (0, _useGetDescendantIdByActivityKey.default)()(activityKey);
  var descendantLabelId = "webchat__basic-transcript__active-descendant-label--".concat(activityKey);
  var isActiveDescendant = descendantId === activeDescendantId;
  var read = readActivityKeys.includes(activityKey);
  var focusSelf = (0, _react.useCallback)(function (withFocus) {
    return focusByActivityKey(activityKeyRef.current, withFocus);
  }, [activityKeyRef, focusByActivityKey]); // When a child of the activity receives focus, notify the transcript to set the `aria-activedescendant` to this activity.

  var handleDescendantFocus = (0, _react.useCallback)(function () {
    return focusSelf(false);
  }, [focusSelf]); // When receive Escape key from descendant, focus back to the activity.

  var handleLeaveFocusTrap = (0, _react.useCallback)(function () {
    return focusSelf();
  }, [focusSelf]); // When the user press UP/DOWN arrow keys, we put a visual focus indicator around the focused activity.
  // We should do the same for mouse, when the user click on the activity, we should also put a visual focus indicator around the activity.
  // We are doing it in event capture phase to prevent descendants from stopping event propagation to us.

  var handleMouseDownCapture = (0, _react.useCallback)(function () {
    return focusSelf(false);
  }, [focusSelf]);
  return (
    /*#__PURE__*/
    // TODO: [P2] Add `aria-roledescription="message"` for better AX, need localization strings.
    _react.default.createElement("article", {
      "aria-hidden": ((_activity$channelData2 = activity.channelData) === null || _activity$channelData2 === void 0 ? void 0 : _activity$channelData2['webchat:fallback-text']) === '',
      className: (0, _classnames.default)('webchat__basic-transcript__activity', {
        'webchat__basic-transcript__activity--acknowledged': acknowledged,
        'webchat__basic-transcript__activity--read': read
      }) // When NVDA is in browse mode, using up/down arrow key to "browse" will dispatch "click" and "mousedown" events for <article> element (inside <ScreenReaderActivity>).
      ,
      onMouseDownCapture: handleMouseDownCapture,
      ref: ref
    }, !_detectBrowser.android && /*#__PURE__*/_react.default.createElement("div", {
      "aria-labelledby": descendantLabelId,
      className: "webchat__basic-transcript__activity-active-descendant" // "id" is required for "aria-labelledby"
      // eslint-disable-next-line react/forbid-dom-props
      ,
      id: descendantId,
      role: "article"
    }, /*#__PURE__*/_react.default.createElement(_ScreenReaderText.default, {
      "aria-hidden": true,
      id: descendantLabelId,
      text: accessibleName
    })), /*#__PURE__*/_react.default.createElement(_FocusTrap.default, {
      onFocus: handleDescendantFocus,
      onLeave: handleLeaveFocusTrap
    }, /*#__PURE__*/_react.default.createElement("div", {
      className: "webchat__basic-transcript__activity-body",
      ref: bodyRef
    }, children)), shouldSpeak && /*#__PURE__*/_react.default.createElement(_Speak.default, {
      activity: activity
    }), /*#__PURE__*/_react.default.createElement("div", {
      className: (0, _classnames.default)('webchat__basic-transcript__activity-indicator', {
        'webchat__basic-transcript__activity-indicator--focus': isActiveDescendant
      })
    }))
  );
});
ActivityRow.defaultProps = {
  children: undefined
};
ActivityRow.propTypes = {
  activity: _propTypes.default.shape({
    channelData: _propTypes.default.shape({
      speak: _propTypes.default.bool,
      'webchat:fallback-text': _propTypes.default.string
    })
  }).isRequired,
  children: _propTypes.default.oneOfType([_propTypes.default.element, _propTypes.default.arrayOf(_propTypes.default.element)])
};
var _default = ActivityRow;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9UcmFuc2NyaXB0L0FjdGl2aXR5Um93LnRzeCJdLCJuYW1lcyI6WyJ1c2VBY3Rpdml0eUtleXNCeVJlYWQiLCJob29rcyIsInVzZUdldEhhc0Fja25vd2xlZGdlZEJ5QWN0aXZpdHlLZXkiLCJ1c2VHZXRLZXlCeUFjdGl2aXR5IiwiQWN0aXZpdHlSb3ciLCJyZWYiLCJhY3Rpdml0eSIsImNoaWxkcmVuIiwiYWN0aXZlRGVzY2VuZGFudElkIiwicmVhZEFjdGl2aXR5S2V5cyIsImJvZHlSZWYiLCJmb2N1c0J5QWN0aXZpdHlLZXkiLCJnZXRLZXlCeUFjdGl2aXR5Iiwic2hvdWxkU3BlYWsiLCJjaGFubmVsRGF0YSIsInNwZWFrIiwiYWNjZXNzaWJsZU5hbWUiLCJhY3Rpdml0eUtleSIsImFja25vd2xlZGdlZCIsImFjdGl2aXR5S2V5UmVmIiwiZGVzY2VuZGFudElkIiwiZGVzY2VuZGFudExhYmVsSWQiLCJpc0FjdGl2ZURlc2NlbmRhbnQiLCJyZWFkIiwiaW5jbHVkZXMiLCJmb2N1c1NlbGYiLCJ3aXRoRm9jdXMiLCJjdXJyZW50IiwiaGFuZGxlRGVzY2VuZGFudEZvY3VzIiwiaGFuZGxlTGVhdmVGb2N1c1RyYXAiLCJoYW5kbGVNb3VzZURvd25DYXB0dXJlIiwiYW5kcm9pZCIsImRlZmF1bHRQcm9wcyIsInVuZGVmaW5lZCIsInByb3BUeXBlcyIsIlByb3BUeXBlcyIsInNoYXBlIiwiYm9vbCIsInN0cmluZyIsImlzUmVxdWlyZWQiLCJvbmVPZlR5cGUiLCJlbGVtZW50IiwiYXJyYXlPZiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBS0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRUEsSUFBUUEscUJBQVIsR0FBMkZDLDZCQUEzRixDQUFRRCxxQkFBUjtBQUFBLElBQStCRSxrQ0FBL0IsR0FBMkZELDZCQUEzRixD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QUFDLGtCQUFEO0FBQVcsTUFBQSxPQUFPLEVBQUVZLHFCQUFwQjtBQUEyQyxNQUFBLE9BQU8sRUFBRUM7QUFBcEQsb0JBQ0U7QUFBSyxNQUFBLFNBQVMsRUFBQywwQ0FBZjtBQUEwRCxNQUFBLEdBQUcsRUFBRW5CO0FBQS9ELE9BQ0dILFFBREgsQ0FERixDQWhDRixFQXFDR00sV0FBVyxpQkFBSSw2QkFBQyxjQUFEO0FBQWUsTUFBQSxRQUFRLEVBQUVQO0FBQXpCLE1BckNsQixlQXNDRTtBQUNFLE1BQUEsU0FBUyxFQUFFLHlCQUFXLCtDQUFYLEVBQTREO0FBQ3JFLGdFQUF3RGdCO0FBRGEsT0FBNUQ7QUFEYixNQXRDRjtBQUZGO0FBK0NELENBbkZtQixDQUFwQjtBQXFGQWxCLFdBQVcsQ0FBQzRCLFlBQVosR0FBMkI7QUFDekJ6QixFQUFBQSxRQUFRLEVBQUUwQjtBQURlLENBQTNCO0FBSUE3QixXQUFXLENBQUM4QixTQUFaLEdBQXdCO0FBQ3RCNUIsRUFBQUEsUUFBUSxFQUFFNkIsbUJBQVVDLEtBQVYsQ0FBZ0I7QUFDeEJ0QixJQUFBQSxXQUFXLEVBQUVxQixtQkFBVUMsS0FBVixDQUFnQjtBQUMzQnJCLE1BQUFBLEtBQUssRUFBRW9CLG1CQUFVRSxJQURVO0FBRTNCLCtCQUF5QkYsbUJBQVVHO0FBRlIsS0FBaEI7QUFEVyxHQUFoQixFQUtQQyxVQU5tQjtBQU90QmhDLEVBQUFBLFFBQVEsRUFBRTRCLG1CQUFVSyxTQUFWLENBQW9CLENBQUNMLG1CQUFVTSxPQUFYLEVBQW9CTixtQkFBVU8sT0FBVixDQUFrQlAsbUJBQVVNLE9BQTVCLENBQXBCLENBQXBCO0FBUFksQ0FBeEI7ZUFVZXJDLFciLCJzb3VyY2VSb290IjoiY29tcG9uZW50Oi8vLyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGhvb2tzIH0gZnJvbSAnYm90ZnJhbWV3b3JrLXdlYmNoYXQtYXBpJztcbmltcG9ydCBjbGFzc05hbWVzIGZyb20gJ2NsYXNzbmFtZXMnO1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJztcbmltcG9ydCBSZWFjdCwgeyBmb3J3YXJkUmVmLCB1c2VDYWxsYmFjaywgdXNlUmVmIH0gZnJvbSAncmVhY3QnO1xuXG5pbXBvcnQgdHlwZSB7IERpcmVjdExpbmVBY3Rpdml0eSB9IGZyb20gJ2JvdGZyYW1ld29yay13ZWJjaGF0LWNvcmUnO1xuaW1wb3J0IHR5cGUgeyBNb3VzZUV2ZW50SGFuZGxlciwgUHJvcHNXaXRoQ2hpbGRyZW4gfSBmcm9tICdyZWFjdCc7XG5cbmltcG9ydCB7IGFuZHJvaWQgfSBmcm9tICcuLi9VdGlscy9kZXRlY3RCcm93c2VyJztcbmltcG9ydCBGb2N1c1RyYXAgZnJvbSAnLi9Gb2N1c1RyYXAnO1xuaW1wb3J0IFNjcmVlblJlYWRlclRleHQgZnJvbSAnLi4vU2NyZWVuUmVhZGVyVGV4dCc7XG5pbXBvcnQgU3BlYWtBY3Rpdml0eSBmcm9tICcuLi9BY3Rpdml0eS9TcGVhayc7XG5pbXBvcnQgdXNlQWN0aXZlRGVzY2VuZGFudElkIGZyb20gJy4uL3Byb3ZpZGVycy9UcmFuc2NyaXB0Rm9jdXMvdXNlQWN0aXZlRGVzY2VuZGFudElkJztcbmltcG9ydCB1c2VBY3Rpdml0eUFjY2Vzc2libGVOYW1lIGZyb20gJy4vdXNlQWN0aXZpdHlBY2Nlc3NpYmxlTmFtZSc7XG5pbXBvcnQgdXNlRm9jdXNCeUFjdGl2aXR5S2V5IGZyb20gJy4uL3Byb3ZpZGVycy9UcmFuc2NyaXB0Rm9jdXMvdXNlRm9jdXNCeUFjdGl2aXR5S2V5JztcbmltcG9ydCB1c2VHZXREZXNjZW5kYW50SWRCeUFjdGl2aXR5S2V5IGZyb20gJy4uL3Byb3ZpZGVycy9UcmFuc2NyaXB0Rm9jdXMvdXNlR2V0RGVzY2VuZGFudElkQnlBY3Rpdml0eUtleSc7XG5pbXBvcnQgdXNlVmFsdWVSZWYgZnJvbSAnLi4vaG9va3MvaW50ZXJuYWwvdXNlVmFsdWVSZWYnO1xuXG5jb25zdCB7IHVzZUFjdGl2aXR5S2V5c0J5UmVhZCwgdXNlR2V0SGFzQWNrbm93bGVkZ2VkQnlBY3Rpdml0eUtleSwgdXNlR2V0S2V5QnlBY3Rpdml0eSB9ID0gaG9va3M7XG5cbnR5cGUgQWN0aXZpdHlSb3dQcm9wcyA9IFByb3BzV2l0aENoaWxkcmVuPHtcbiAgYWN0aXZpdHk6IERpcmVjdExpbmVBY3Rpdml0eTtcbn0+O1xuXG5jb25zdCBBY3Rpdml0eVJvdyA9IGZvcndhcmRSZWY8SFRNTExJRWxlbWVudCwgQWN0aXZpdHlSb3dQcm9wcz4oKHsgYWN0aXZpdHksIGNoaWxkcmVuIH0sIHJlZikgPT4ge1xuICBjb25zdCBbYWN0aXZlRGVzY2VuZGFudElkXSA9IHVzZUFjdGl2ZURlc2NlbmRhbnRJZCgpO1xuICBjb25zdCBbcmVhZEFjdGl2aXR5S2V5c10gPSB1c2VBY3Rpdml0eUtleXNCeVJlYWQoKTtcbiAgY29uc3QgYm9keVJlZiA9IHVzZVJlZjxIVE1MRGl2RWxlbWVudD4oKTtcbiAgY29uc3QgZm9jdXNCeUFjdGl2aXR5S2V5ID0gdXNlRm9jdXNCeUFjdGl2aXR5S2V5KCk7XG4gIGNvbnN0IGdldEtleUJ5QWN0aXZpdHkgPSB1c2VHZXRLZXlCeUFjdGl2aXR5KCk7XG4gIC8vIFRPRE86IFtQMl0gIzI4NTggV2Ugc2hvdWxkIHVzZSBjb3JlL2RlZmluaXRpb25zL3NwZWFraW5nQWN0aXZpdHkgZm9yIHRoaXMgcHJlZGljYXRlIGluc3RlYWRcbiAgY29uc3Qgc2hvdWxkU3BlYWsgPSBhY3Rpdml0eS5jaGFubmVsRGF0YT8uc3BlYWs7XG5cbiAgY29uc3QgW2FjY2Vzc2libGVOYW1lXSA9IHVzZUFjdGl2aXR5QWNjZXNzaWJsZU5hbWUoYWN0aXZpdHksIGJvZHlSZWYpO1xuICBjb25zdCBhY3Rpdml0eUtleSA9IGdldEtleUJ5QWN0aXZpdHkoYWN0aXZpdHkpO1xuXG4gIGNvbnN0IGFja25vd2xlZGdlZCA9IHVzZUdldEhhc0Fja25vd2xlZGdlZEJ5QWN0aXZpdHlLZXkoKShhY3Rpdml0eUtleSk7XG4gIGNvbnN0IGFjdGl2aXR5S2V5UmVmID0gdXNlVmFsdWVSZWY8c3RyaW5nPihhY3Rpdml0eUtleSk7XG4gIGNvbnN0IGRlc2NlbmRhbnRJZCA9IHVzZUdldERlc2NlbmRhbnRJZEJ5QWN0aXZpdHlLZXkoKShhY3Rpdml0eUtleSk7XG4gIGNvbnN0IGRlc2NlbmRhbnRMYWJlbElkID0gYHdlYmNoYXRfX2Jhc2ljLXRyYW5zY3JpcHRfX2FjdGl2ZS1kZXNjZW5kYW50LWxhYmVsLS0ke2FjdGl2aXR5S2V5fWA7XG5cbiAgY29uc3QgaXNBY3RpdmVEZXNjZW5kYW50ID0gZGVzY2VuZGFudElkID09PSBhY3RpdmVEZXNjZW5kYW50SWQ7XG4gIGNvbnN0IHJlYWQgPSByZWFkQWN0aXZpdHlLZXlzLmluY2x1ZGVzKGFjdGl2aXR5S2V5KTtcblxuICBjb25zdCBmb2N1c1NlbGYgPSB1c2VDYWxsYmFjazwod2l0aEZvY3VzPzogYm9vbGVhbikgPT4gdm9pZD4oXG4gICAgKHdpdGhGb2N1cz86IGJvb2xlYW4pID0+IGZvY3VzQnlBY3Rpdml0eUtleShhY3Rpdml0eUtleVJlZi5jdXJyZW50LCB3aXRoRm9jdXMpLFxuICAgIFthY3Rpdml0eUtleVJlZiwgZm9jdXNCeUFjdGl2aXR5S2V5XVxuICApO1xuXG4gIC8vIFdoZW4gYSBjaGlsZCBvZiB0aGUgYWN0aXZpdHkgcmVjZWl2ZXMgZm9jdXMsIG5vdGlmeSB0aGUgdHJhbnNjcmlwdCB0byBzZXQgdGhlIGBhcmlhLWFjdGl2ZWRlc2NlbmRhbnRgIHRvIHRoaXMgYWN0aXZpdHkuXG4gIGNvbnN0IGhhbmRsZURlc2NlbmRhbnRGb2N1czogKCkgPT4gdm9pZCA9IHVzZUNhbGxiYWNrKCgpID0+IGZvY3VzU2VsZihmYWxzZSksIFtmb2N1c1NlbGZdKTtcblxuICAvLyBXaGVuIHJlY2VpdmUgRXNjYXBlIGtleSBmcm9tIGRlc2NlbmRhbnQsIGZvY3VzIGJhY2sgdG8gdGhlIGFjdGl2aXR5LlxuICBjb25zdCBoYW5kbGVMZWF2ZUZvY3VzVHJhcCA9IHVzZUNhbGxiYWNrKCgpID0+IGZvY3VzU2VsZigpLCBbZm9jdXNTZWxmXSk7XG5cbiAgLy8gV2hlbiB0aGUgdXNlciBwcmVzcyBVUC9ET1dOIGFycm93IGtleXMsIHdlIHB1dCBhIHZpc3VhbCBmb2N1cyBpbmRpY2F0b3IgYXJvdW5kIHRoZSBmb2N1c2VkIGFjdGl2aXR5LlxuICAvLyBXZSBzaG91bGQgZG8gdGhlIHNhbWUgZm9yIG1vdXNlLCB3aGVuIHRoZSB1c2VyIGNsaWNrIG9uIHRoZSBhY3Rpdml0eSwgd2Ugc2hvdWxkIGFsc28gcHV0IGEgdmlzdWFsIGZvY3VzIGluZGljYXRvciBhcm91bmQgdGhlIGFjdGl2aXR5LlxuICAvLyBXZSBhcmUgZG9pbmcgaXQgaW4gZXZlbnQgY2FwdHVyZSBwaGFzZSB0byBwcmV2ZW50IGRlc2NlbmRhbnRzIGZyb20gc3RvcHBpbmcgZXZlbnQgcHJvcGFnYXRpb24gdG8gdXMuXG4gIGNvbnN0IGhhbmRsZU1vdXNlRG93bkNhcHR1cmU6IE1vdXNlRXZlbnRIYW5kbGVyID0gdXNlQ2FsbGJhY2soKCkgPT4gZm9jdXNTZWxmKGZhbHNlKSwgW2ZvY3VzU2VsZl0pO1xuXG4gIHJldHVybiAoXG4gICAgLy8gVE9ETzogW1AyXSBBZGQgYGFyaWEtcm9sZWRlc2NyaXB0aW9uPVwibWVzc2FnZVwiYCBmb3IgYmV0dGVyIEFYLCBuZWVkIGxvY2FsaXphdGlvbiBzdHJpbmdzLlxuICAgIDxhcnRpY2xlXG4gICAgICBhcmlhLWhpZGRlbj17YWN0aXZpdHkuY2hhbm5lbERhdGE/Llsnd2ViY2hhdDpmYWxsYmFjay10ZXh0J10gPT09ICcnfVxuICAgICAgY2xhc3NOYW1lPXtjbGFzc05hbWVzKCd3ZWJjaGF0X19iYXNpYy10cmFuc2NyaXB0X19hY3Rpdml0eScsIHtcbiAgICAgICAgJ3dlYmNoYXRfX2Jhc2ljLXRyYW5zY3JpcHRfX2FjdGl2aXR5LS1hY2tub3dsZWRnZWQnOiBhY2tub3dsZWRnZWQsXG4gICAgICAgICd3ZWJjaGF0X19iYXNpYy10cmFuc2NyaXB0X19hY3Rpdml0eS0tcmVhZCc6IHJlYWRcbiAgICAgIH0pfVxuICAgICAgLy8gV2hlbiBOVkRBIGlzIGluIGJyb3dzZSBtb2RlLCB1c2luZyB1cC9kb3duIGFycm93IGtleSB0byBcImJyb3dzZVwiIHdpbGwgZGlzcGF0Y2ggXCJjbGlja1wiIGFuZCBcIm1vdXNlZG93blwiIGV2ZW50cyBmb3IgPGFydGljbGU+IGVsZW1lbnQgKGluc2lkZSA8U2NyZWVuUmVhZGVyQWN0aXZpdHk+KS5cbiAgICAgIG9uTW91c2VEb3duQ2FwdHVyZT17aGFuZGxlTW91c2VEb3duQ2FwdHVyZX1cbiAgICAgIHJlZj17cmVmfVxuICAgID5cbiAgICAgIHsvKiBUT0RPOiBbUDFdIEZpbGUgYSBjcmJ1ZyBmb3IgVGFsa0JhY2suIEl0IHNob3VsZCBub3QgYWJsZSB0byByZWFkIHRoZSBjb250ZW50IHR3aWNlIHdoZW4gc2Nhbm5pbmcuICovfVxuXG4gICAgICB7LyogVGhlIGZvbGxvd2luZyA8ZGl2PiBpcyBkZXNpZ25lZCBmb3IgYWN0aXZlIGRlc2NlbmRhbnQgb25seS5cbiAgICAgICAgICBXZSB3YW50IHRvIHByZXZlbnQgc2NyZWVuIHJlYWRlciBmcm9tIHNjYW5uaW5nIHRoZSBjb250ZW50IHRoYXQgaXMgYXV0aG9yZWQgb25seSBmb3IgYWN0aXZlIGRlc2NlbmRhbnQuXG4gICAgICAgICAgVGhlIHNwZWNpZmljIGNvbnRlbnQgc2hvdWxkIG9ubHkgcmVhZCB3aGVuIHVzZXIgcHJlc3MgVVAvRE9XTiBhcnJvdyBrZXlzIHRvIGNoYW5nZSBgYXJpYS1hY3RpdmVkZXNjZW5kYW50YC5cbiAgICAgICAgICBIb3dldmVyLCBBbmRyb2lkIFRhbGtCYWNrIDEyLjEgaXMgYnVnZ3kgd2hlbiB0aGUgdGhlcmUgaXMgYW4gZWxlbWVudCB3aXRoIElEIG9mIG9uZSBvZiB0aGUgYGFyaWEtYWN0aXZlZGVzY2VuZGFudGAgcG90ZW50aWFsIGNhbmRpZGF0ZXMsXG4gICAgICAgICAgVGFsa0JhY2sgd2lsbCBuYXJyYXRlIHRoZSBtZXNzYWdlIGNvbnRlbnQgdHdpY2UgKGkuZS4gY29udGVudCBvZiBgYm9keVJlZmApLCByZWdhcmRsZXNzIHdoZXRoZXIgdGhlIElEIGlzIGN1cnJlbnRseSBzZXQgYXMgYGFyaWEtYWN0aXZlZGVzY2VuZGFudGAgb3Igbm90LlxuICAgICAgICAgIEFzIEFuZHJvaWQgZG9lcyBub3Qgc3VwcG9ydCBhY3RpdmUgZGVzY2VuZGFudCwgd2UgYXJlIGhpZGluZyB0aGUgd2hvbGUgRE9NIGVsZW1lbnQgYWx0b2dldGhlci4gKi99XG5cbiAgICAgIHshYW5kcm9pZCAmJiAoXG4gICAgICAgIDxkaXZcbiAgICAgICAgICBhcmlhLWxhYmVsbGVkYnk9e2Rlc2NlbmRhbnRMYWJlbElkfVxuICAgICAgICAgIGNsYXNzTmFtZT1cIndlYmNoYXRfX2Jhc2ljLXRyYW5zY3JpcHRfX2FjdGl2aXR5LWFjdGl2ZS1kZXNjZW5kYW50XCJcbiAgICAgICAgICAvLyBcImlkXCIgaXMgcmVxdWlyZWQgZm9yIFwiYXJpYS1sYWJlbGxlZGJ5XCJcbiAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcmVhY3QvZm9yYmlkLWRvbS1wcm9wc1xuICAgICAgICAgIGlkPXtkZXNjZW5kYW50SWR9XG4gICAgICAgICAgcm9sZT1cImFydGljbGVcIlxuICAgICAgICA+XG4gICAgICAgICAgPFNjcmVlblJlYWRlclRleHQgYXJpYS1oaWRkZW49e3RydWV9IGlkPXtkZXNjZW5kYW50TGFiZWxJZH0gdGV4dD17YWNjZXNzaWJsZU5hbWV9IC8+XG4gICAgICAgIDwvZGl2PlxuICAgICAgKX1cbiAgICAgIHsvKiBBZGQgdGVzdHMgZm9yIGZvY3VzIHRyYXAgKi99XG4gICAgICA8Rm9jdXNUcmFwIG9uRm9jdXM9e2hhbmRsZURlc2NlbmRhbnRGb2N1c30gb25MZWF2ZT17aGFuZGxlTGVhdmVGb2N1c1RyYXB9PlxuICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIndlYmNoYXRfX2Jhc2ljLXRyYW5zY3JpcHRfX2FjdGl2aXR5LWJvZHlcIiByZWY9e2JvZHlSZWZ9PlxuICAgICAgICAgIHtjaGlsZHJlbn1cbiAgICAgICAgPC9kaXY+XG4gICAgICA8L0ZvY3VzVHJhcD5cbiAgICAgIHtzaG91bGRTcGVhayAmJiA8U3BlYWtBY3Rpdml0eSBhY3Rpdml0eT17YWN0aXZpdHl9IC8+fVxuICAgICAgPGRpdlxuICAgICAgICBjbGFzc05hbWU9e2NsYXNzTmFtZXMoJ3dlYmNoYXRfX2Jhc2ljLXRyYW5zY3JpcHRfX2FjdGl2aXR5LWluZGljYXRvcicsIHtcbiAgICAgICAgICAnd2ViY2hhdF9fYmFzaWMtdHJhbnNjcmlwdF9fYWN0aXZpdHktaW5kaWNhdG9yLS1mb2N1cyc6IGlzQWN0aXZlRGVzY2VuZGFudFxuICAgICAgICB9KX1cbiAgICAgIC8+XG4gICAgPC9hcnRpY2xlPlxuICApO1xufSk7XG5cbkFjdGl2aXR5Um93LmRlZmF1bHRQcm9wcyA9IHtcbiAgY2hpbGRyZW46IHVuZGVmaW5lZFxufTtcblxuQWN0aXZpdHlSb3cucHJvcFR5cGVzID0ge1xuICBhY3Rpdml0eTogUHJvcFR5cGVzLnNoYXBlKHtcbiAgICBjaGFubmVsRGF0YTogUHJvcFR5cGVzLnNoYXBlKHtcbiAgICAgIHNwZWFrOiBQcm9wVHlwZXMuYm9vbCxcbiAgICAgICd3ZWJjaGF0OmZhbGxiYWNrLXRleHQnOiBQcm9wVHlwZXMuc3RyaW5nXG4gICAgfSlcbiAgfSkuaXNSZXF1aXJlZCxcbiAgY2hpbGRyZW46IFByb3BUeXBlcy5vbmVPZlR5cGUoW1Byb3BUeXBlcy5lbGVtZW50LCBQcm9wVHlwZXMuYXJyYXlPZihQcm9wVHlwZXMuZWxlbWVudCldKVxufTtcblxuZXhwb3J0IGRlZmF1bHQgQWN0aXZpdHlSb3c7XG4iXX0=